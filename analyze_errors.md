# üîç –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞—Ç—á–∞ (04.11.2025, 03:00-03:05)

## üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1Ô∏è‚É£ **–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ Scoring Agent**

**User ID:** `18758bb0-c453-49d1-abd1-879f96fd4d4f`  
**–í—Ä–µ–º—è:** 03:00:02  
**–°–µ—Ä–≤–∏—Å:** agent-brain (scoring agent)

#### –û—à–∏–±–∫–∞:
```
Error: FB adsets actions failed: 403
{
  "error": {
    "message": "(#200) Ad account owner has NOT grant ads_management or ads_read permission",
    "type": "OAuthException",
    "code": 200,
    "fbtrace_id": "AwU2D2wX-iZBgyCDyn5OsdE"
  }
}
```

#### –ü—Ä–∏—á–∏–Ω–∞:
- –í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ **–ù–ï –¥–∞–ª** –ø—Ä–∞–≤–∞ `ads_management` –∏–ª–∏ `ads_read`
- –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –Ω–µ –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö permissions –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± adsets

#### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] –¢–æ–∫–µ–Ω Facebook –≤ —Ç–∞–±–ª–∏—Ü–µ `user_accounts` –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫)
- [ ] Permissions —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å `ads_management` –∏–ª–∏ –º–∏–Ω–∏–º—É–º `ads_read`)
- [ ] –í–ª–∞–¥–µ–ª–µ—Ü –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å Facebook —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

#### SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```sql
SELECT 
  id,
  name,
  telegram_username,
  fb_ad_account_id,
  fb_access_token_expires_at,
  is_active
FROM user_accounts 
WHERE id = '18758bb0-c453-49d1-abd1-879f96fd4d4f';
```

---

### 2Ô∏è‚É£ **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (WhatsApp & Instagram)**

**Ad Account ID:** `act_1902303286606721`  
**–í—Ä–µ–º—è:** 03:04:45 - 03:05:55  
**–°–µ—Ä–≤–∏—Å:** agent-service (video processing)

#### –û—à–∏–±–∫–∏:

**A) WhatsApp –∫—Ä–µ–∞—Ç–∏–≤:**
```json
{
  "error_subcode": 1487194,
  "type": "OAuthException",
  "code": 200,
  "params": {
    "name": "Video CTWA ‚Äì WhatsApp",
    "video_id": "1526908275214065" / "1341848097400589",
    "call_to_action": {"type": "WHATSAPP_MESSAGE"}
  }
}
```

**B) Instagram –∫—Ä–µ–∞—Ç–∏–≤:**
```json
{
  "error_subcode": 1487194,
  "type": "OAuthException",
  "code": 200,
  "params": {
    "name": "Instagram Profile Creative",
    "video_id": "1526908275214065" / "1341848097400589",
    "call_to_action": {
      "type": "LEARN_MORE",
      "link": "https://www.instagram.com/@cleantm.kz"
    }
  }
}
```

#### –ü—Ä–∏—á–∏–Ω–∞ (error_subcode 1487194):
–≠—Ç–æ—Ç error_subcode —á–∞—Å—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ–¥–Ω—É –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ–±–ª–µ–º:

1. **–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ WhatsApp Business API**
   - –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WhatsApp Business
   - WhatsApp Business –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω

2. **–ü—Ä–æ–±–ª–µ–º—ã —Å Instagram Business Account**
   - Instagram –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ Business
   - –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Instagram –≤ —Ä–µ–∫–ª–∞–º–µ

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –≤–∏–¥–µ–æ**
   - –í–∏–¥–µ–æ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Facebook
   - –í–∏–¥–µ–æ –Ω–µ –ø—Ä–æ—à–ª–æ –º–æ–¥–µ—Ä–∞—Ü–∏—é
   - –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∫—Ä–µ–∞—Ç–∏–≤–∞

4. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–æ–∫–µ–Ω–æ–º**
   - –¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö permissions –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
   - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ –∏—Å—Ç–µ–∫

#### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] WhatsApp Business –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- [ ] Instagram –∞–∫–∫–∞—É–Ω—Ç @cleantm.kz —è–≤–ª—è–µ—Ç—Å—è Business –∞–∫–∫–∞—É–Ω—Ç–æ–º
- [ ] Instagram –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Facebook Page (id: 108803528274173)
- [ ] –í–∏–¥–µ–æ —Å id 1526908275214065 –∏ 1341848097400589 —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∏–¥–µ–æ –≤ Facebook: `GET /{video_id}?fields=status`
- [ ] –¢–æ–∫–µ–Ω –∏–º–µ–µ—Ç permissions: `pages_show_list`, `pages_read_engagement`, `ads_management`

#### SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```sql
SELECT 
  id,
  name,
  telegram_username,
  fb_ad_account_id,
  fb_page_id,
  instagram_user_id,
  whatsapp_phone_number,
  whatsapp_business_account_id,
  fb_access_token_expires_at,
  is_active
FROM user_accounts 
WHERE fb_ad_account_id IN ('1902303286606721', 'act_1902303286606721');
```

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: User 18758bb0-c453-49d1-abd1-879f96fd4d4f
1. –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
2. –ü–æ–ø—Ä–æ—Å–∏—Ç—å **–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å Facebook** —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ permissions:
   - `ads_management` (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–æ)
   - `ads_read` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
   - `pages_show_list`
   - `business_management`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: User —Å Ad Account act_1902303286606721
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WhatsApp Business
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Instagram Business (@cleantm.kz)
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Instagram –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Facebook Page
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
5. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å Facebook —Å –ø–æ–ª–Ω—ã–º–∏ permissions

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

- **–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫:** 6
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 2
- **–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**
  - –ù–µ—Ç –ø—Ä–∞–≤ ads_management/ads_read: 1
  - –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ (1487194): 5 (4 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è 2 –≤–∏–¥–µ–æ)

---

## üõ† –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ agent-service
docker exec -it agents-monorepo-agent-service-1 node << 'EOF'
const { supabase } = require('./dist/lib/supabase.js');

async function checkTokens() {
  const { data, error } = await supabase
    .from('user_accounts')
    .select('id, name, fb_access_token_expires_at')
    .in('id', [
      '18758bb0-c453-49d1-abd1-879f96fd4d4f',
    ])
    .or('fb_ad_account_id.eq.1902303286606721,fb_ad_account_id.eq.act_1902303286606721');
  
  console.log(JSON.stringify(data, null, 2));
}

checkTokens();
EOF
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Facebook API
curl -G \
  -d "fields=status,title,length,created_time" \
  -d "access_token=YOUR_TOKEN" \
  "https://graph.facebook.com/v20.0/1526908275214065"

curl -G \
  -d "fields=status,title,length,created_time" \
  -d "access_token=YOUR_TOKEN" \
  "https://graph.facebook.com/v20.0/1341848097400589"
```

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ ID
2. –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∏–º–∏ –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
4. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É permissions –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π
5. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ error_subcode 1487194

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 04.11.2025  
**–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª:** AI Assistant




