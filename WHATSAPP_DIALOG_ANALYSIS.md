# üìä –ê–Ω–∞–ª–∏–∑ WhatsApp –¥–∏–∞–ª–æ–≥–æ–≤ —Å GPT-5-mini

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ WhatsApp –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ Evolution API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **GPT-5-mini** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–∏–Ω—Å–∞–π—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏–¥–æ–≤.

---

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑** –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ Evolution API instance
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **AI-–∞–Ω–∞–ª–∏–∑** –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:
  - –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
  - –í–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞ –∏–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä
  - –£—Ä–æ–≤–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–∞ (hot/warm/cold)
  - –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å (clinic_lead, ai_targetolog, marketing_analysis)
  - –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è
  - **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –¥–ª—è —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏
  - –°–∫–æ—Ä–∏–Ω–≥ –ª–∏–¥–∞ (0-100)
- **–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- **API endpoints** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend (Button "Analyze Dialogs")            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POST /api/dialogs/analyze                      ‚îÇ
‚îÇ  { instanceName, userAccountId, minIncoming }   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  analyzeDialogs.ts                              ‚îÇ
‚îÇ  1. –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Evolution PostgreSQL ‚îÇ
‚îÇ  2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º                   ‚îÇ
‚îÇ  3. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å (‚â• minIncoming)                 ‚îÇ
‚îÇ  4. –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT-5-mini                     ‚îÇ
‚îÇ  5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Supabase                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase: dialog_analysis table                ‚îÇ
‚îÇ  - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞                          ‚îÇ
‚îÇ  - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞                           ‚îÇ
‚îÇ  - next_message –¥–ª—è —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏—è

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `dialog_analysis` –≤ Supabase:

```bash
psql -h your-supabase-host -U postgres -d postgres -f services/frontend/supabase/dialog_analysis_table.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard ‚Üí SQL Editor.

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd services/agent-service
npm install
```

–ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `pg` - PostgreSQL –∫–ª–∏–µ–Ω—Ç –¥–ª—è Evolution DB
- `@types/pg` - TypeScript —Ç–∏–ø—ã

### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env.agent`:

```bash
# Evolution API Configuration
EVOLUTION_API_KEY=your-evolution-api-key-here
EVOLUTION_DB_PASSWORD=your-evolution-db-password-here
EVOLUTION_API_URL=http://evolution-api:8080
EVOLUTION_DB_HOST=evolution-postgres
EVOLUTION_DB_PORT=5432
EVOLUTION_DB_USER=evolution
EVOLUTION_DB_NAME=evolution

# OpenAI (—É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
OPENAI_API_KEY=your-openai-api-key
```

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
cd /root/agents-monorepo
docker-compose restart agent-service
```

---

## üì° API Endpoints

### 1. POST /api/dialogs/analyze

–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è instance.

**Request:**
```bash
curl -X POST https://app.performanteaiagency.com/api/dialogs/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "instanceName": "instance_0f559eb0_1761736509038",
    "userAccountId": "uuid-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    "minIncoming": 3
  }'
```

**Response:**
```json
{
  "success": true,
  "stats": {
    "total": 150,
    "analyzed": 87,
    "hot": 12,
    "warm": 45,
    "cold": 30,
    "errors": 0
  }
}
```

### 2. GET /api/dialogs/analysis

–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.

**Request:**
```bash
curl "https://app.performanteaiagency.com/api/dialogs/analysis?userAccountId=uuid&interestLevel=hot"
```

**Query Parameters:**
- `userAccountId` (required) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `instanceName` (optional) - —Ñ–∏–ª—å—Ç—Ä –ø–æ instance
- `interestLevel` (optional) - hot, warm, cold
- `minScore` (optional) - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π score

**Response:**
```json
{
  "success": true,
  "results": [
    {
      "id": "uuid",
      "contact_phone": "+77001234567",
      "contact_name": "–ê–ª–∏—è",
      "interest_level": "hot",
      "score": 85,
      "business_type": "–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è",
      "next_message": "–ê–ª–∏—è, –≥–æ—Ç–æ–≤—ã –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?",
      "objection": null,
      "incoming_count": 5,
      "outgoing_count": 4,
      "last_message": "2025-11-02T10:30:00Z"
    }
  ],
  "count": 1
}
```

### 3. GET /api/dialogs/export-csv

–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ CSV.

**Request:**
```bash
curl "https://app.performanteaiagency.com/api/dialogs/export-csv?userAccountId=uuid&interestLevel=hot" \
  -o dialog-analysis.csv
```

**Query Parameters:**
- `userAccountId` (required)
- `instanceName` (optional)
- `interestLevel` (optional)

**Response:** CSV —Ñ–∞–π–ª —Å –ø–æ–ª—è–º–∏:
```
contact_phone,contact_name,interest_level,score,business_type,objection,next_message,incoming_count,outgoing_count,last_message
```

### 4. GET /api/dialogs/stats

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

**Request:**
```bash
curl "https://app.performanteaiagency.com/api/dialogs/stats?userAccountId=uuid"
```

**Response:**
```json
{
  "success": true,
  "stats": {
    "total": 87,
    "hot": 12,
    "warm": 45,
    "cold": 30,
    "avgScore": 62,
    "totalMessages": 435
  }
}
```

### 5. DELETE /api/dialogs/analysis/:id

–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞.

**Request:**
```bash
curl -X DELETE "https://app.performanteaiagency.com/api/dialogs/analysis/uuid?userAccountId=uuid"
```

---

## üíª CLI –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ CLI

```bash
cd services/agent-service
npm run analyze-dialogs instance_name user_account_id [minIncoming]
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
npm run analyze-dialogs instance_0f559eb0_1761736509038 550e8400-e29b-41d4-a716-446655440000 3
```

**–ê—Ä–≥—É–º–µ–Ω—Ç—ã:**
1. `instance_name` - –∏–º—è Evolution API instance
2. `user_account_id` - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. `minIncoming` (optional, default: 3) - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üß™ –§–æ—Ä–º–∞—Ç –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è GPT-5-mini

–î–∏–∞–ª–æ–≥–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —É–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ (~3x):

```
C: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± AI-—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–µ.
A: –î–æ–±—Ä—ã–π –¥–µ–Ω—å! –î–ª—è –∫–∞–∫–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞?
C: –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è, –ê–ª–º–∞—Ç—ã
A: –í—ã –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∏–Ω–∏–∫–∏?
C: –î–∞
S: –ü–û–î–¢–í–ï–†–ñ–î–ê–ï–ú –ó–ê–ü–ò–°–¨: 02.11.2025 14:00 –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
```

–ì–¥–µ:
- `C:` - –∫–ª–∏–µ–Ω—Ç (customer)
- `A:` - –∞–≥–µ–Ω—Ç (agent)
- `S:` - —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (system)

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `dialog_analysis`

```sql
CREATE TABLE dialog_analysis (
  id UUID PRIMARY KEY,
  instance_name TEXT NOT NULL,
  user_account_id UUID,
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
  contact_phone TEXT NOT NULL,
  contact_name TEXT,
  incoming_count INT,
  outgoing_count INT,
  first_message TIMESTAMPTZ,
  last_message TIMESTAMPTZ,
  
  -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã LLM –∞–Ω–∞–ª–∏–∑–∞
  business_type TEXT,
  is_owner BOOLEAN,
  uses_ads_now BOOLEAN,
  has_sales_dept BOOLEAN,
  has_booking BOOLEAN,
  sent_instagram BOOLEAN,
  interest_level TEXT, -- hot/warm/cold
  main_intent TEXT,    -- clinic_lead/ai_targetolog/etc
  objection TEXT,
  next_message TEXT NOT NULL, -- üî• –ì–ª–∞–≤–Ω–æ–µ –ø–æ–ª–µ
  action TEXT,
  score INT,           -- 0-100
  reasoning TEXT,
  
  -- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
  messages JSONB,
  
  analyzed_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(instance_name, contact_phone)
);
```

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å

**GPT-5-mini**:
- Input: ~$0.15 / 1M tokens (–æ–∂–∏–¥–∞–µ–º–∞—è)
- Output: ~$0.60 / 1M tokens (–æ–∂–∏–¥–∞–µ–º–∞—è)

**–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:**
- 1 –¥–∏–∞–ª–æ–≥ (20 —Å–æ–æ–±—â–µ–Ω–∏–π) ‚âà 500 tokens input + 200 tokens output
- 100 –¥–∏–∞–ª–æ–≥–æ–≤ ‚âà $0.02-0.05

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Evolution PostgreSQL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–¢–∞–±–ª–∏—Ü–∞ `Message`:**
```sql
{
  "key": {
    "remoteJid": "+77001234567@s.whatsapp.net",
    "fromMe": false,
    "id": "message-id"
  },
  "pushName": "–ê–ª–∏—è",
  "message": {
    "conversation": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
  },
  "messageTimestamp": "1730543400",
  "owner": "instance_name"
}
```

### –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

1. –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ `owner = instanceName`
2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `key.remoteJid` (—É–¥–∞–ª—è–µ–º @s.whatsapp.net)
3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `key.fromMe = false` –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö
4. –ü–æ–¥—Å—á–µ—Ç incoming/outgoing, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ first/last message

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ GPT-5-mini –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON ‚Üí –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç
- –ï—Å–ª–∏ Evolution DB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –ï—Å–ª–∏ Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤

```bash
# –ß–µ—Ä–µ–∑ API
curl -X POST https://app.performanteaiagency.com/api/dialogs/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "instanceName": "instance_0f559eb0_1761736509038",
    "userAccountId": "550e8400-e29b-41d4-a716-446655440000",
    "minIncoming": 3
  }'
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—É—á–∏—Ç—å hot leads

```bash
curl "https://app.performanteaiagency.com/api/dialogs/analysis?userAccountId=uuid&interestLevel=hot&minScore=70"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –≠–∫—Å–ø–æ—Ä—Ç hot leads –≤ CSV

```bash
curl "https://app.performanteaiagency.com/api/dialogs/export-csv?userAccountId=uuid&interestLevel=hot" \
  -o hot-leads.csv
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: CLI –∞–Ω–∞–ª–∏–∑

```bash
cd services/agent-service
npm run analyze-dialogs instance_name user_uuid 5
```

---

## üö® Troubleshooting

### –û—à–∏–±–∫–∞: "EVOLUTION_DB_PASSWORD is not set"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
echo "EVOLUTION_DB_PASSWORD=your-password" >> .env.agent
docker-compose restart agent-service
```

### –û—à–∏–±–∫–∞: "Instance not found"

**–ü—Ä–∏—á–∏–Ω–∞:** Instance –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ instanceName –≤ —Ç–∞–±–ª–∏—Ü–µ `whatsapp_instances`:
```sql
SELECT * FROM whatsapp_instances WHERE user_account_id = 'uuid';
```

### –û—à–∏–±–∫–∞: "OpenAI API error"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `OPENAI_API_KEY` –≤ `.env.agent`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ https://platform.openai.com/account/billing

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Evolution PostgreSQL.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã Message:
```bash
docker exec -it evolution-postgres psql -U evolution -d evolution -c "\d Message"
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º `user_account_id` –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º
2. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:** –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. **RLS –≤ Supabase:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Row Level Security –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `dialog_analysis`

**–ü—Ä–∏–º–µ—Ä RLS –ø–æ–ª–∏—Ç–∏–∫–∏:**
```sql
CREATE POLICY "Users can view their own analysis"
  ON dialog_analysis FOR SELECT
  USING (user_account_id = auth.uid());
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [EVOLUTION_API_INTEGRATION.md](EVOLUTION_API_INTEGRATION.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Evolution API
- [EVOLUTION_API_USAGE.md](EVOLUTION_API_USAGE.md) - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Evolution API
- [INFRASTRUCTURE.md](INFRASTRUCTURE.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ WhatsApp –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é SQL
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ agent-service
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ API –∏–ª–∏ CLI
5. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ CSV
6. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

