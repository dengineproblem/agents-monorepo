<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ–¥–∫–ª—é—á–∏—Ç—å AmoCRM - AI –¢–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ Performante</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .container {
      background: white;
      padding: 50px 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 500px;
      width: 100%;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    p {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .features {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
    }

    .features h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .features ul {
      list-style: none;
    }

    .features li {
      padding: 8px 0;
      color: #555;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .features li::before {
      content: "‚úì";
      color: #667eea;
      font-weight: bold;
      margin-right: 10px;
      font-size: 16px;
    }

    #amocrm-button-container {
      margin: 30px 0;
      min-height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .loading {
      color: #999;
      font-size: 14px;
    }

    .note {
      font-size: 13px;
      color: #999;
      margin-top: 20px;
    }

    .success-message {
      display: none;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .success-message.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ü§ñ</div>
    
    <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ AmoCRM</h1>
    <p>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –≤–∞—à—É CRM —Å AI-—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ª–∏–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂</p>

    <div class="features">
      <h3>–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:</h3>
      <ul>
        <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ª–∏–¥–æ–≤ —Å —Å–∞–π—Ç–∞ –≤ AmoCRM</li>
        <li>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ —Å–¥–µ–ª–æ–∫ —Å UTM-–º–µ—Ç–∫–∞–º–∏</li>
        <li>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–∫–∞—Ö</li>
        <li>–°–∫–≤–æ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ROI –ø–æ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–º–ø–∞–Ω–∏—è–º</li>
      </ul>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ AmoCRM -->
    <div id="amocrm-button-container">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="success-message" id="success-message">
      ‚úÖ AmoCRM —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω! –û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.
    </div>

    <div class="note">
      –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ AmoCRM. 
      –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.
    </div>
  </div>

  <!-- –°–∫—Ä–∏–ø—Ç –∫–Ω–æ–ø–∫–∏ AmoCRM -->
  <script
    class="amocrm_oauth"
    charset="utf-8"
    data-name="AI-—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ Performante"
    data-description="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ª–∏–¥–æ–≤ —Å —Å–∞–π—Ç–∞ –∏ —Å–∫–≤–æ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂"
    data-redirect_uri="https://app.performanteaiagency.com/api/amocrm/callback"
    data-secrets_uri="https://app.performanteaiagency.com/api/amocrm/secrets"
    data-scopes="crm,notifications"
    data-title="–ü–æ–¥–∫–ª—é—á–∏—Ç—å amoCRM"
    data-state=""
    data-mode="popup"
    data-error-callback="onAmoAuthError"
    src="https://www.amocrm.ru/auth/button.min.js">
  </script>

  <script>
    // Generate unique state for this session
    function generateState() {
      // Get userAccountId and subdomain from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const userAccountId = urlParams.get('userAccountId') || 'REPLACE_WITH_USER_ID';
      const subdomain = urlParams.get('subdomain') || 'performanteaiagency';
      
      // Encode userAccountId|subdomain in state (base64)
      return btoa(`${userAccountId}|${subdomain}`);
    }

    // Set state when page loads
    window.addEventListener('DOMContentLoaded', () => {
      const state = generateState();
      const script = document.querySelector('.amocrm_oauth');
      
      if (script) {
        script.setAttribute('data-state', state);
        console.log('State set:', state);
      }

      // Hide loading message after a short delay
      setTimeout(() => {
        const loading = document.querySelector('.loading');
        if (loading) {
          loading.style.display = 'none';
        }
      }, 2000);
    });

    // Error callback
    function onAmoAuthError({ error, error_description }) {
      console.error('AmoCRM auth error:', error, error_description);
      
      if (error === 'access_denied') {
        alert('–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é AmoCRM');
      } else {
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è AmoCRM: ' + (error_description || error));
      }
    }

    // Listen for success message from popup
    window.addEventListener('message', (event) => {
      // Verify origin for security
      if (event.origin !== 'https://app.performanteaiagency.com' && 
          event.origin !== 'https://performanteaiagency.com') {
        return;
      }

      if (event.data.type === 'amocrm_connected') {
        console.log('AmoCRM connected:', event.data);
        
        // Show success message
        const successMessage = document.getElementById('success-message');
        if (successMessage) {
          successMessage.classList.add('show');
        }

        // Hide button
        const buttonContainer = document.getElementById('amocrm-button-container');
        if (buttonContainer) {
          buttonContainer.style.display = 'none';
        }

        // Redirect to profile page after 3 seconds
        setTimeout(() => {
          window.location.href = 'https://app.performanteaiagency.com/profile';
        }, 3000);
      }
    });
  </script>
</body>
</html>
