# Инструкция по сбросу паролей

## Обзор

Эта инструкция содержит все необходимые файлы и шаги для сброса слабых паролей (1111, 2222) для 36 пользователей и отправки им уведомлений в Telegram.

## Созданные файлы

### 1. `password_reset_data.json`
Содержит маппинг всех 36 пользователей с:
- ID пользователя
- Username
- Старый пароль
- Новый безопасный пароль (16 символов, включает буквы, цифры и спецсимволы)
- Telegram ID (все варианты: telegram_id, telegram_id_2, telegram_id_3, telegram_id_4)

### 2. `migrations/189_update_weak_passwords.sql`
SQL миграция для обновления паролей в базе данных Supabase. Содержит:
- 36 UPDATE запросов для каждого пользователя
- Обновление поля `updated_at`
- Проверочный SELECT запрос для верификации

### 3. `scripts/send_password_reset_notifications.ts`
TypeScript скрипт для отправки уведомлений пользователям через Telegram Bot API. Функции:
- Читает данные из `password_reset_data.json`
- Отправляет сообщение каждому пользователю с новым паролем
- Обрабатывает несколько telegram_id для одного пользователя
- Сохраняет результаты в `password_reset_results.json`
- Rate limiting для избежания блокировки Telegram API

## Порядок выполнения

### Шаг 1: Применить миграцию в Supabase

```bash
# Вы должны применить миграцию вручную в Supabase Dashboard или через CLI
# Файл миграции: migrations/189_update_weak_passwords.sql
```

**ВАЖНО:** Согласно правилам проекта, я НЕ подключаюсь к Supabase напрямую. Вы должны применить миграцию самостоятельно.

### Шаг 2: Запустить скрипт отправки уведомлений

После применения миграции запустите скрипт:

```bash
cd /Users/anatolijstepanov/agents-monorepo
npx ts-node scripts/send_password_reset_notifications.ts
```

## Текст сообщения

Каждый пользователь получит следующее сообщение:

```
В целях безопасности мы поменяли ваш пароль на более надежный:

`[новый_пароль]`

не показывайте его никому, даже сотрудникам performante.ai

Техподдержка переехала в [бот техподдержки](https://t.me/Moltbot_prfmnt_bot)
```

## Статистика

- **Всего пользователей:** 36
- **Пользователи с telegram_id:** 33
- **Пользователи без telegram_id:** 3 (YMAgency, facebody, testagency)
- **Пользователи с несколькими telegram_id:** 5
  - loftspace (2 ID)
  - jungle_boutique (2 ID)
  - PIFAGOR_School (2 ID)
  - Scaleup (2 ID)
  - silazakona (2 ID)
  - vitis.advisors (2 ID)

## Результаты

После выполнения скрипта будет создан файл `password_reset_results.json` с детальной информацией о результатах отправки:
- Количество успешных отправок
- Количество неудачных отправок
- Список пользователей без telegram_id
- Детали по каждой отправке

## Безопасность

⚠️ **ВАЖНО:**

1. **Не коммитьте в Git:**
   - `password_reset_data.json` (содержит пароли в открытом виде)
   - `password_reset_results.json` (может содержать чувствительную информацию)

2. **После выполнения:**
   - Удалите файл `password_reset_data.json` с диска
   - Сохраните только зашифрованную копию для истории (если необходимо)

3. **Telegram Bot Token:**
   - Токен жестко закодирован в скрипте: `8584683514:AAHzoE31UbNNCDexse9hYeJQLWT9Ay2pBhE`
   - Убедитесь, что этот токен принадлежит официальному боту Performante
   - Не делитесь этим токеном публично

## Пользователи без Telegram ID

Следующие пользователи не получат уведомление, так как у них нет telegram_id:

1. **YMAgency** (id: a09342e3-1660-49c8-847f-9334f4e49ccf)
   - Новый пароль: `Qw6dS#hG9xN$fK3y`

2. **facebody** (id: e4fad5cb-d456-44fb-8b6e-5fc484fd52ae)
   - Новый пароль: `Tz5jM#pW8vL$nR4b`

3. **testagency** (id: 36f011b1-0ae7-4b9d-aaee-c979a295ed11)
   - Новый пароль: `Fh8kR#vG4xM$jW9q`

**Рекомендация:** Свяжитесь с этими пользователями другим способом (email, телефон) для передачи новых паролей.

## Troubleshooting

### Ошибка "Failed to send message"

Возможные причины:
- Пользователь заблокировал бота
- Неверный telegram_id
- Проблемы с Telegram API

Проверьте файл `password_reset_results.json` для деталей.

### Rate limiting

Скрипт автоматически добавляет задержку 100ms между сообщениями. Если получаете ошибки rate limiting, увеличьте задержку в коде.

## Дата выполнения

- Дата создания: 2026-02-04
- Миграция: `189_update_weak_passwords.sql`
- Статус: Готово к выполнению
