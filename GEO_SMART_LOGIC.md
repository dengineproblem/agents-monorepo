# üß† –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø –°–¢–†–ê–ù/–ì–û–†–û–î–û–í

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï (–ë–ï–ó –ú–ò–ì–†–ê–¶–ò–ô!)

**Supabase –æ—Å—Ç–∞–µ—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô:**
- –ö–æ–ª–æ–Ω–∫–∞ `cities TEXT[]` - –∫–∞–∫ –µ—Å—Ç—å
- –ù–∏–∫–∞–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –Ω—É–∂–Ω–æ!

**–í –∫–æ–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:**
- `"RU", "KZ"` (2 —Å–∏–º–≤–æ–ª–∞, –∑–∞–≥–ª–∞–≤–Ω—ã–µ) ‚Üí —Å—Ç—Ä–∞–Ω—ã
- `"2420877", "524901"` (–¥–ª–∏–Ω–Ω—ã–µ ID) ‚Üí –≥–æ—Ä–æ–¥–∞

---

## üéØ –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:

```typescript
for (const item of cities) {
  if (item.length === 2 && /^[A-Z]{2}$/.test(item)) {
    // 2 –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã = –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã ISO 3166-1 alpha-2
    countries.push(item);
  } else {
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ = ID –≥–æ—Ä–æ–¥–∞ –∏–∑ Facebook API
    cities.push(item);
  }
}
```

---

## üìä –ü–†–ò–ú–ï–†–´ (–ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û)

### ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω
```javascript
Input:  cities = ["RU", "KZ", "BY"]
Output: geo_locations = {
  "countries": ["RU", "KZ", "BY"]
}
```

### ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤
```javascript
Input:  cities = ["2420877", "2452344", "524901"]
Output: geo_locations = {
  "cities": [
    {"key": "2420877"},  // –ê–ª–º–∞—Ç—ã
    {"key": "2452344"},  // –ê—Å—Ç–∞–Ω–∞
    {"key": "524901"}    // –ú–æ—Å–∫–≤–∞
  ]
}
```

### ‚úÖ –°–º–µ—à–∞–Ω–Ω–æ–µ (—Å—Ç—Ä–∞–Ω—ã + –≥–æ—Ä–æ–¥–∞)
```javascript
Input:  cities = ["RU", "KZ", "2420877"]
Output: geo_locations = {
  "countries": ["RU", "KZ"],
  "cities": [{"key": "2420877"}]
}
```
**Facebook –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∞–∫—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é!**

### ‚úÖ –û–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞
```javascript
Input:  cities = ["RU"]
Output: geo_locations = {
  "countries": ["RU"]
}
```

### ‚úÖ –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ (default)
```javascript
Input:  cities = []
Output: geo_locations = {
  "countries": ["RU"]  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –†–æ—Å—Å–∏—è
}
```

---

## üîß –§–ê–ô–õ–´

**–û–±–Ω–æ–≤–ª–µ–Ω:** `services/agent-service/src/lib/defaultSettings.ts`

**–§—É–Ω–∫—Ü–∏—è:** `convertToFacebookTargeting()`

**–¢–µ—Å—Ç—ã:** `test-geo-logic.js` (6 —Ç–µ—Å—Ç–æ–≤, –≤—Å–µ –ø—Ä–æ—à–ª–∏ ‚úÖ)

---

## üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ Supabase:

**–ù–ò–ß–ï–ì–û! üéâ**

–ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–π –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –æ–±—ã—á–Ω–æ:

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç –ê: –°—Ç—Ä–∞–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–ª–∞–≤–Ω—ã–µ –¥–≤—É—Ö—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –∫–æ–¥—ã)
INSERT INTO default_ad_settings (user_id, campaign_goal, cities, age_min, age_max, gender, description)
VALUES (
  '0f559eb0-53fa-4b6a-a51b-5d3e15e5864b',
  'whatsapp',
  ARRAY['RU', 'KZ'],  -- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–∞–Ω—ã
  25,
  55,
  'all',
  '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏'
);

-- –í–∞—Ä–∏–∞–Ω—Ç –ë: –ì–æ—Ä–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–π ID –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ Facebook)
INSERT INTO default_ad_settings (user_id, campaign_goal, cities, age_min, age_max, gender, description)
VALUES (
  '0f559eb0-53fa-4b6a-a51b-5d3e15e5864b',
  'whatsapp',
  ARRAY['2420877', '2452344'],  -- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ –≥–æ—Ä–æ–¥–∞
  25,
  55,
  'all',
  '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏'
);

-- –í–∞—Ä–∏–∞–Ω—Ç –í: –°–º–µ—à–∞–Ω–Ω–æ–µ (Facebook –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç!)
INSERT INTO default_ad_settings (user_id, campaign_goal, cities, age_min, age_max, gender, description)
VALUES (
  '0f559eb0-53fa-4b6a-a51b-5d3e15e5864b',
  'whatsapp',
  ARRAY['RU', 'KZ', '2420877'],  -- ‚úÖ RU, KZ ‚Üí —Å—Ç—Ä–∞–Ω—ã, 2420877 ‚Üí –≥–æ—Ä–æ–¥
  25,
  55,
  'all',
  '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏'
);
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –†–ï–ì–ò–°–¢–† –ò–ú–ï–ï–¢ –ó–ù–ê–ß–ï–ù–ò–ï

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```sql
ARRAY['RU', 'KZ']  -- ‚úÖ –ó–∞–≥–ª–∞–≤–Ω—ã–µ - —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–∞–Ω—ã
```

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```sql
ARRAY['ru', 'kz']  -- ‚ùå Lowercase - —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ –≥–æ—Ä–æ–¥–∞!
```

---

## üéØ –î–õ–Ø –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –ö–ê–ú–ü–ê–ù–ò–ô

–ü—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ adset:

```typescript
// –ü–æ–ª—É—á–∞–µ–º targeting –∏–∑ Facebook
const sourceTargeting = await fb.getAdSet(adset_id, {fields: 'targeting'});

// –ò–∑–≤–ª–µ–∫–∞–µ–º geo_locations
const geoLoc = sourceTargeting.targeting.geo_locations;

// –§–æ—Ä–º–∏—Ä—É–µ–º cities –º–∞—Å—Å–∏–≤ –¥–ª—è Supabase
const cities = [];

if (geoLoc.countries) {
  cities.push(...geoLoc.countries);  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥—ã —Å—Ç—Ä–∞–Ω
}

if (geoLoc.cities) {
  cities.push(...geoLoc.cities.map(c => c.key));  // –î–æ–±–∞–≤–ª—è–µ–º ID –≥–æ—Ä–æ–¥–æ–≤
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
await supabase
  .from('default_ad_settings')
  .upsert({
    user_id,
    campaign_goal: 'whatsapp',
    cities: cities,  // ["RU", "KZ", "2420877"] - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è!
    // ...
  });
```

---

## ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç
3. **–ì–∏–±–∫–æ—Å—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–∞–Ω, –≥–æ—Ä–æ–¥–æ–≤, –∏ —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ
4. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–º:** –ù–µ –Ω—É–∂–Ω–æ –¥—É–º–∞—Ç—å –æ —Ñ–æ—Ä–º–∞—Ç–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
5. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:** –õ–µ–≥–∫–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥ –∏–∑ Facebook

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ª–æ–≥–∏–∫–∏
node test-geo-logic.js

# –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ ‚úÖ
```

---

## üöÄ –ì–û–¢–û–í–û!

**Agent-service –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π!**

–ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å CreateCampaignWithCreative –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! üéâ

---

üìÖ **–î–∞—Ç–∞:** 5 –æ–∫—Ç—è–±—Ä—è 2025  
üîß **–í–µ—Ä—Å–∏—è:** 2.3 (Final)  
‚úÖ **–°—Ç–∞—Ç—É—Å:** Production Ready
