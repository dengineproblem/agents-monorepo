# üîó AmoCRM Integration - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AmoCRM

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-08  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  

---

## üìã –û–±–∑–æ—Ä

AmoCRM –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–∏–¥–æ–≤ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

- ‚úÖ **OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ AmoCRM –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ **Webhook-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ª–∏–¥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **–†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –ª–∏–¥–æ–≤
- ‚úÖ **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏ AmoCRM –ª–∏–¥–∞–º–∏
- ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–æ—Ä–æ–Ω–∫–∏** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —ç—Ç–∞–ø–∞–º –≤–æ—Ä–æ–Ω–∫–∏

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Frontend (React/TypeScript)

**–§–∞–π–ª**: `services/frontend/src/pages/Profile.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å AmoCRM" —Å –≤–≤–æ–¥–æ–º –ø–æ–¥–¥–æ–º–µ–Ω–∞
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ë–∞–¥–∂ "Webhook" –µ—Å–ª–∏ webhook –∞–∫—Ç–∏–≤–µ–Ω
- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `API_BASE_URL` —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ–Ω–≤–µ–Ω—Ü–∏—è–º

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- `ConnectionsGrid` - –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è AmoCRM
- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### Backend (Fastify/TypeScript)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤**:

```
services/agent-service/src/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ amocrmOAuth.ts         # OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ amocrmManagement.ts    # API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (webhook, sync)
‚îÇ   ‚îú‚îÄ‚îÄ amocrmPipelines.ts     # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ—Ä–æ–Ω–æ–∫ –∏ —ç—Ç–∞–ø–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ amocrmWebhooks.ts      # –ü—Ä–∏–µ–º webhook —Å–æ–±—ã—Ç–∏–π –æ—Ç AmoCRM
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ amocrmTokens.ts        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ amocrmWebhook.ts       # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhooks
‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îú‚îÄ‚îÄ amocrmSync.ts          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–∏–¥–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ amocrmLeadsSync.ts     # –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ª–∏–¥–æ–≤
‚îî‚îÄ‚îÄ adapters/
    ‚îî‚îÄ‚îÄ amocrm.ts              # API –∫–ª–∏–µ–Ω—Ç AmoCRM
```

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–æ–¥–¥–æ–º–µ–Ω

```typescript
// Frontend: Profile.tsx
const handleAmoCRMConnectSubmit = () => {
  const url = `${API_BASE_URL}/amocrm/auth?userAccountId=${user.id}&subdomain=${subdomain}`;
  window.location.href = url;
};
```

### 2. OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**Endpoint**: `GET /amocrm/auth`

```typescript
// Backend: amocrmOAuth.ts
app.get('/amocrm/auth', async (request, reply) => {
  // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  // 2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ AmoCRM OAuth
});
```

### 3. Callback –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

**Endpoint**: `GET /amocrm/callback`

```typescript
// Backend: amocrmOAuth.ts
app.get('/amocrm/callback', async (request, reply) => {
  // 1. –û–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ —Ç–æ–∫–µ–Ω—ã
  // 2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (user_account_integrations)
  // 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç webhook
  // 4. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ /profile
});
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Webhook

```typescript
// Backend: amocrmWebhook.ts
await registerAmoCRMWebhook(userAccountId, subdomain, accessToken);
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç webhook –¥–ª—è —Å–æ–±—ã—Ç–∏–π:
// - add_lead (–Ω–æ–≤—ã–π –ª–∏–¥)
// - update_lead (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–¥–∞)
// - status_lead (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
```

---

## üîî Webhook —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (Real-time)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **AmoCRM –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–∏–¥–∞
2. **Endpoint**: `POST /webhooks/amocrm?user_id={userAccountId}`
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞** (`amocrmWebhooks.ts`):
   ```typescript
   // 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ status_lead
   // 2. –í—ã–∑—ã–≤–∞–µ—Ç processLeadStatusChange()
   ```

### –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–æ–≤:

```typescript
// Backend: workflows/amocrmSync.ts
export async function processLeadStatusChange(statusChange, userAccountId) {
  // 1. –ò—â–µ–º –ª–∏–¥ –ø–æ amocrm_lead_id
  let lead = await supabase
    .from('leads')
    .select('*')
    .eq('amocrm_lead_id', amocrmLeadId)
    .maybeSingle();
  
  // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—â–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  if (!lead) {
    const amocrmLead = await getLead(amocrmLeadId, subdomain, token);
    const contact = await getContact(contactId, subdomain, token);
    const phone = normalizePhone(extractPhoneFromContact(contact));
    
    lead = await supabase
      .from('leads')
      .select('*')
      .eq('user_account_id', userAccountId)
      .or(`phone.eq.${phone},chat_id.like.%${phone}%`)
      .maybeSingle();
    
    // 3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω - —Å–æ—Ö—Ä–∞–Ω—è–µ–º amocrm_lead_id –¥–ª—è –±—É–¥—É—â–∏—Ö webhook
    if (lead) {
      await supabase
        .from('leads')
        .update({ amocrm_lead_id: amocrmLeadId })
        .eq('id', lead.id);
    }
  }
  
  // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–æ—Ä–æ–Ω–∫–∏
  if (lead) {
    await supabase
      .from('leads')
      .update({ 
        amocrm_pipeline_id: pipelineId,
        amocrm_stage_id: stageId 
      })
      .eq('id', lead.id);
  }
}
```

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:

```typescript
// Backend: workflows/amocrmSync.ts
function normalizePhone(phone: string): string {
  // –£–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
  return phone.replace(/\D/g, '');
}
```

---

## üîÑ –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ö–Ω–æ–ø–∫–∞ –≤ UI

```typescript
// Frontend: Profile.tsx
const handleAmoCRMSync = async () => {
  const response = await fetch(
    `${API_BASE_URL}/amocrm/sync-leads?userAccountId=${user.id}`,
    { method: 'POST' }
  );
  const data = await response.json();
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
};
```

### Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞

**Endpoint**: `POST /amocrm/sync-leads`

```typescript
// Backend: amocrmManagement.ts
app.post('/amocrm/sync-leads', async (request, reply) => {
  const result = await syncLeadsFromAmoCRM(userAccountId, app);
  return reply.send({
    success: true,
    total: 150,
    updated: 45,
    errors: 0
  });
});
```

---

## üïê Fallback Cron —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω:

- –ù–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö webhook —Å–æ–±—ã—Ç–∏–π
- –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ AmoCRM
- –†–µ–∑–µ—Ä–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

**–§–∞–π–ª**: `env.agent.example`

```bash
# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron –¥–ª—è fallback —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
# –û—Å–Ω–æ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ webhooks
AMOCRM_LEADS_SYNC_CRON_SCHEDULE=0 */6 * * *  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
```

**–§–∞–π–ª**: `services/agent-brain/src/amocrmLeadsSyncCron.js`

```javascript
const CRON_SCHEDULE = process.env.AMOCRM_LEADS_SYNC_CRON_SCHEDULE || '0 */6 * * *';

cron.schedule(CRON_SCHEDULE, async () => {
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ª–∏–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
});
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: `user_account_integrations`

```sql
CREATE TABLE user_account_integrations (
  id UUID PRIMARY KEY,
  user_account_id UUID REFERENCES user_accounts(id),
  integration_type TEXT,  -- 'amocrm'
  access_token TEXT,
  refresh_token TEXT,
  token_expires_at TIMESTAMP,
  subdomain TEXT,
  metadata JSONB,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞: `leads` (–æ–±–Ω–æ–≤–ª–µ–Ω–∞)

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è AmoCRM
ALTER TABLE leads ADD COLUMN amocrm_lead_id BIGINT;
ALTER TABLE leads ADD COLUMN amocrm_pipeline_id BIGINT;
ALTER TABLE leads ADD COLUMN amocrm_stage_id BIGINT;

CREATE INDEX idx_leads_amocrm_lead_id ON leads(amocrm_lead_id);
```

### –¢–∞–±–ª–∏—Ü–∞: `amocrm_pipeline_stages`

```sql
CREATE TABLE amocrm_pipeline_stages (
  id UUID PRIMARY KEY,
  user_account_id UUID REFERENCES user_accounts(id),
  pipeline_id BIGINT,
  pipeline_name TEXT,
  stage_id BIGINT,
  stage_name TEXT,
  stage_color TEXT,
  stage_sort INTEGER,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

---

## üì° API Endpoints

### OAuth & –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| `GET` | `/amocrm/auth` | –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é |
| `GET` | `/amocrm/callback` | Callback –ø–æ—Å–ª–µ OAuth |
| `GET` | `/amocrm/status` | –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è |
| `POST` | `/amocrm/disconnect` | –û—Ç–∫–ª—é—á–∏—Ç—å AmoCRM |

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| `GET` | `/amocrm/webhook-status` | –°—Ç–∞—Ç—É—Å webhook |
| `POST` | `/amocrm/register-webhook` | –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å webhook |
| `POST` | `/amocrm/sync-leads` | –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è |

### Webhooks

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| `POST` | `/webhooks/amocrm` | –ü—Ä–∏–µ–º —Å–æ–±—ã—Ç–∏–π –æ—Ç AmoCRM |

### –í–æ—Ä–æ–Ω–∫–∏

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| `GET` | `/amocrm/pipelines` | –°–ø–∏—Å–æ–∫ –≤–æ—Ä–æ–Ω–æ–∫ –∏ —ç—Ç–∞–ø–æ–≤ |

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**–§–∞–π–ª**: `env.agent.example`

```bash
# AmoCRM OAuth credentials
AMOCRM_CLIENT_ID=your_client_id
AMOCRM_CLIENT_SECRET=your_client_secret
AMOCRM_REDIRECT_URI=https://app.performanteaiagency.com/amocrm/callback

# App URL –¥–ª—è webhooks
APP_URL=https://app.performanteaiagency.com

# Cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
AMOCRM_LEADS_SYNC_CRON_SCHEDULE=0 */6 * * *
```

### Frontend API –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏

**–°–ª–µ–¥—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º**: `FRONTEND_API_CONVENTIONS.md`

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
import { API_BASE_URL } from '@/config/api';
fetch(`${API_BASE_URL}/amocrm/status?userAccountId=${userId}`);

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
fetch('/api/amocrm/status?userAccountId=${userId}');
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

**–§–∞–π–ª**: `check-amocrm-connection.sh`

```bash
#!/bin/bash
USER_ID="0f559eb0-53fa-4b6a-a51b-5d3e15e5864b"

curl -s "http://localhost:8082/amocrm/status?userAccountId=${USER_ID}" | jq .
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
curl "http://localhost:8082/amocrm/webhook-status?userAccountId=${USER_ID}" | jq .
```

### –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
curl -X POST "http://localhost:8082/amocrm/sync-leads?userAccountId=${USER_ID}" | jq .
```

### –õ–æ–≥–∏

```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ agent-service
docker-compose logs -f agent-service | grep amocrm

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ cron
docker-compose logs -f agent-brain | grep amocrm
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ"

**–ü—Ä–∏—á–∏–Ω–∞**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `API_BASE_URL`

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤ `Profile.tsx` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `${API_BASE_URL}/amocrm/...`
2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: `docker-compose build --no-cache frontend`
3. Hard refresh –±—Ä–∞—É–∑–µ—Ä–∞: `Cmd+Shift+R`

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: Webhook –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π URL

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
curl "http://localhost:8082/amocrm/webhook-status?userAccountId=${USER_ID}"

# 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ
curl -X POST "http://localhost:8082/amocrm/register-webhook?userAccountId=${USER_ID}"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å APP_URL –≤ env.agent
echo $APP_URL
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: https://app.performanteaiagency.com
```

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–∏–¥ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –≤ `workflows/amocrmSync.ts`
- –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤ AmoCRM –∫–æ–Ω—Ç–∞–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `docker-compose logs agent-service | grep "Found phone for lead"`

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

–ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ:

- [ ] –î–æ–±–∞–≤–∏—Ç—å `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (AMOCRM_CLIENT_ID, AMOCRM_CLIENT_SECRET, APP_URL)
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ AmoCRM
- [ ] –û–±–Ω–æ–≤–∏—Ç—å AMOCRM_REDIRECT_URI –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ APP_URL –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏ (–¥–ª—è webhooks)
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`028_amocrm_pipeline_stages.sql`)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å agent-brain (–¥–ª—è cron –∑–∞–¥–∞—á)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ‚Üí webhook ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 2025-11-08  
**–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 15+  
**–ù–æ–≤—ã—Ö endpoints**: 8  
**–ù–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü**: 2  

**–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è**:
- ‚úÖ OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ Real-time webhook —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ Fallback cron —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ –£–º–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ª–∏–¥–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- ‚úÖ UI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª—å
- ‚úÖ –°–ª–µ–¥—É–µ—Ç API –∫–æ–Ω–≤–µ–Ω—Ü–∏—è–º –ø—Ä–æ–µ–∫—Ç–∞

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `FRONTEND_API_CONVENTIONS.md` - –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å API
- `AMOCRM_FUNNEL_ANALYTICS.md` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–æ—Ä–æ–Ω–∫–∏ AmoCRM
- `env.agent.example` - –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

---

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!** üéâ







