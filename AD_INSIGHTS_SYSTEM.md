# Ad Insights System

–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ Meta Ads –¥–ª—è tech_admin. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã, –¥–µ—Ç–µ–∫—Ü–∏—é –∞–Ω–æ–º–∞–ª–∏–π, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≥–æ—Ä–∞–Ω–∏—è –∏ –≥–æ–¥–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              FRONTEND                                        ‚îÇ
‚îÇ  AdminAdInsights.tsx ‚Üí adInsightsApi.ts ‚Üí types/adInsights.ts               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           AGENT-SERVICE                                      ‚îÇ
‚îÇ  routes/adInsights.ts                                                        ‚îÇ
‚îÇ      ‚îÇ                                                                       ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ services/adInsightsSync.ts      (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)             ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ services/resultNormalizer.ts    (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)         ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ services/anomalyDetector.ts     (–¥–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π)                ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ services/burnoutAnalyzer.ts     (–ø—Ä–æ–≥–Ω–æ–∑ –≤—ã–≥–æ—Ä–∞–Ω–∏—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è) ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ services/yearlyAnalyzer.ts      (–≥–æ–¥–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã)                   ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ services/trackingHealth.ts      (–∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–∫–∏–Ω–≥–∞)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              SUPABASE                                        ‚îÇ
‚îÇ  meta_insights_weekly, meta_insights_daily, meta_weekly_results,            ‚îÇ
‚îÇ  ad_weekly_anomalies, ad_weekly_features, ad_burnout_predictions,           ‚îÇ
‚îÇ  lag_dependency_stats, yearly_audit_cache                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### `meta_insights_weekly`
Weekly –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ insights —Å Meta API.

```sql
CREATE TABLE meta_insights_weekly (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    user_account_id UUID,
    fb_ad_id TEXT NOT NULL,
    week_start_date DATE NOT NULL,
    impressions INTEGER,
    clicks INTEGER,
    link_clicks INTEGER,
    spend DECIMAL(12,2),
    reach INTEGER,
    frequency DECIMAL(6,3),
    ctr DECIMAL(6,4),
    cpc DECIMAL(10,4),
    cpm DECIMAL(10,4),
    link_ctr DECIMAL(8,6),           -- CTR –ø–æ —Å—Å—ã–ª–∫–∞–º (Migration 113)
    actions_json JSONB,
    quality_rank_score DECIMAL(5,2),
    engagement_rank_score DECIMAL(5,2),
    conversion_rank_score DECIMAL(5,2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, fb_ad_id, week_start_date)
);
```

#### `meta_weekly_results`
–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å–µ–º–µ–π—Å—Ç–≤–∞–º (messages, leads, purchases, etc.).

```sql
CREATE TABLE meta_weekly_results (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    user_account_id UUID,
    fb_ad_id TEXT NOT NULL,
    week_start_date DATE NOT NULL,
    result_family TEXT NOT NULL,  -- 'messages', 'leads', 'purchases', etc.
    result_count INTEGER,
    spend DECIMAL(12,2),
    cpr DECIMAL(10,4),            -- cost per result
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, fb_ad_id, week_start_date, result_family)
);
```

#### `ad_weekly_anomalies`
–î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏ CPR —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π.

```sql
CREATE TABLE ad_weekly_anomalies (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    user_account_id UUID,
    fb_ad_id TEXT NOT NULL,
    week_start_date DATE NOT NULL,
    result_family TEXT NOT NULL,
    anomaly_type TEXT NOT NULL,      -- 'cpr_spike' (–æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø)
    severity TEXT NOT NULL,          -- 'low', 'medium', 'high', 'critical'
    current_value DECIMAL(12,4),
    baseline_value DECIMAL(12,4),
    delta_pct DECIMAL(8,2),
    anomaly_score DECIMAL(5,3),
    confidence DECIMAL(4,3),
    likely_triggers JSONB,           -- —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ
    preceding_deviations JSONB,      -- –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞ 1-2 –Ω–µ–¥–µ–ª–∏ –¥–æ (Migration 113)
    status TEXT DEFAULT 'new',       -- 'new', 'acknowledged', 'resolved'
    spike_pct DECIMAL(8,2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    acknowledged_at TIMESTAMPTZ,
    UNIQUE(ad_account_id, fb_ad_id, week_start_date, result_family, anomaly_type)
);
```

#### `ad_burnout_predictions` (Migration 110)
–ü—Ä–æ–≥–Ω–æ–∑—ã –≤—ã–≥–æ—Ä–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π.

```sql
CREATE TABLE ad_burnout_predictions (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    user_account_id UUID,
    fb_ad_id TEXT NOT NULL,
    ad_name TEXT,
    result_family TEXT NOT NULL DEFAULT 'all',
    burnout_score DECIMAL(4,3),      -- 0.0-1.0
    burnout_level TEXT,              -- 'low', 'medium', 'high', 'critical'
    days_until_burnout INTEGER,
    confidence DECIMAL(4,3),
    contributing_factors JSONB,
    weekly_trend JSONB,
    recommendation TEXT,
    computed_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, fb_ad_id, result_family)
);
```

#### `lag_dependency_stats` (Migration 111)
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–∞–≥–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è.

```sql
CREATE TABLE lag_dependency_stats (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    user_account_id UUID,
    result_family TEXT NOT NULL DEFAULT 'all',
    metric_name TEXT NOT NULL,
    prediction_type TEXT DEFAULT 'burnout',
    corr_lag_1w DECIMAL(5,4),
    corr_lag_2w DECIMAL(5,4),
    avg_cpr_growth_when_triggered DECIMAL(8,2),
    trigger_frequency DECIMAL(4,3),
    predictive_power DECIMAL(4,3),
    recommended_threshold DECIMAL(6,3),
    time_lag_weeks INTEGER DEFAULT 2,
    quantile_analysis JSONB,
    sample_size INTEGER DEFAULT 0,
    computed_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, result_family, metric_name)
);
```

#### `yearly_audit_cache`
–ö—ç—à –≥–æ–¥–æ–≤—ã—Ö –∞—É–¥–∏—Ç–æ–≤.

```sql
CREATE TABLE yearly_audit_cache (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    result_family TEXT NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    top_ads_by_spend JSONB,
    top_ads_by_results JSONB,
    top_ads_by_efficiency JSONB,
    pareto_top10_pct DECIMAL(5,2),
    worst_cpr_weeks JSONB,
    best_cpr_weeks JSONB,
    zero_result_spend DECIMAL(12,2),
    zero_result_weeks INTEGER,
    anomaly_free_weeks_pct DECIMAL(5,2),
    total_spikes INTEGER,
    avg_spike_pct DECIMAL(8,2),
    total_spend DECIMAL(14,2),
    total_results INTEGER,
    avg_cpr DECIMAL(10,4),
    median_cpr DECIMAL(10,4),
    computed_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, result_family, period_start, period_end)
);
```

## API Endpoints

–í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç `x-user-id` header —Å ID tech_admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

#### `POST /admin/ad-insights/:accountId/sync`
–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö Meta Ads.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `weeks` (number, default: 12) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `includeCampaigns` (boolean) - –≤–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–∞–º–ø–∞–Ω–∏–π
- `includeAdsets` (boolean) - –≤–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∞–¥—Å–µ—Ç–æ–≤

**Response:**
```json
{
  "success": true,
  "accountId": "uuid",
  "insightsCount": 1383,
  "resultsCount": 3948,
  "anomaliesCount": 45,
  "burnoutPredictions": 51,
  "lagStats": 1
}
```

### –ê–Ω–æ–º–∞–ª–∏–∏

#### `GET /admin/ad-insights/:accountId/anomalies`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–Ω–æ–º–∞–ª–∏–π.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `severity` - 'low', 'medium', 'high', 'critical'
- `type` - 'cpr_spike', 'zero_results', 'performance_drop'
- `limit` (number, optional) - –ª–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π (–±–µ–∑ –ª–∏–º–∏—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `offset` (number, default: 0) - —Å–¥–≤–∏–≥ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- `acknowledged` (boolean) - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É

**Response:**
```json
{
  "anomalies": [
    {
      "id": "uuid",
      "ad_account_id": "uuid",
      "fb_ad_id": "120215...",
      "week_start_date": "2025-12-16",
      "anomaly_type": "cpr_spike",
      "severity": "high",
      "current_value": 12.50,
      "baseline_value": 5.00,
      "delta_pct": 150.00,
      "anomaly_score": 0.85,
      "confidence": 0.92,
      "status": "new"
    }
  ],
  "total": 45
}
```

#### `POST /admin/ad-insights/:accountId/anomalies/:anomalyId/acknowledge`
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (—Å–∫—Ä—ã—Ç—å) –∞–Ω–æ–º–∞–ª–∏—é.

#### `POST /admin/ad-insights/:accountId/enrich-daily-breakdown`
–û–±–æ–≥–∞—Ç–∏—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ –¥–Ω—è–º. –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î (–Ω–µ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ Facebook API).

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `forceRefresh` (boolean, default: false) - –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
- `limit` (number, optional) - –ª–∏–º–∏—Ç –∞–Ω–æ–º–∞–ª–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**Response:**
```json
{
  "success": true,
  "enriched": 45,
  "skipped": 5,
  "errors": 0
}
```

### Burnout Predictions

#### `GET /admin/ad-insights/:accountId/burnout/predictions`
–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã –≤—ã–≥–æ—Ä–∞–Ω–∏—è.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `minScore` (number, 0-1) - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π burnout score
- `level` - 'low', 'medium', 'high', 'critical'
- `limit` (number, default: 50)

**Response:**
```json
{
  "predictions": [
    {
      "id": "uuid",
      "fb_ad_id": "120215...",
      "ad_name": "–ù–æ–≤—ã–π –∑—É–± –∑–∞ 2500",
      "burnout_score": 0.75,
      "burnout_level": "high",
      "days_until_burnout": 14,
      "confidence": 0.88,
      "contributing_factors": {
        "cpr_trend": "increasing",
        "frequency_saturation": 0.6,
        "creative_fatigue": 0.7
      },
      "weekly_trend": [...],
      "recommendation": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤"
    }
  ],
  "total": 51
}
```

#### `GET /admin/ad-insights/:accountId/burnout/lag-stats`
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–∞–≥–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**Response:**
```json
{
  "stats": [
    {
      "metric_name": "cpr_growth",
      "corr_lag_1w": 0.72,
      "corr_lag_2w": 0.85,
      "avg_cpr_growth_when_triggered": 45.5,
      "trigger_frequency": 0.23,
      "predictive_power": 0.78,
      "recommended_threshold": 1.5,
      "time_lag_weeks": 2
    }
  ]
}
```

### Decay & Recovery

#### `GET /admin/ad-insights/:accountId/decay-recovery`
–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

**Response:**
```json
{
  "decay": {
    "highRiskAds": [
      {
        "fbAdId": "120215...",
        "adName": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "riskScore": 0.85,
        "riskLevel": "critical"
      }
    ]
  },
  "recovery": {
    "likelyRecoveryAds": [
      {
        "fbAdId": "120216...",
        "adName": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "recoveryScore": 0.72,
        "recoveryLevel": "likely",
        "currentStatus": "degraded"
      }
    ]
  }
}
```

### Yearly Analysis

#### `GET /admin/ad-insights/:accountId/yearly/audit`
–ì–æ–¥–æ–≤–æ–π –∞—É–¥–∏—Ç (Pareto, waste, stability).

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `family` (string, default: 'messages') - —Å–µ–º–µ–π—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `periodStart` (date) - –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
- `periodEnd` (date) - –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞

**Response:**
```json
{
  "success": true,
  "period": {
    "start": "2024-12-23",
    "end": "2025-12-23"
  },
  "totals": {
    "spend": 92303.40,
    "results": 15970,
    "avgCpr": 5.78,
    "medianCpr": 4.67,
    "weeks": 53
  },
  "pareto": {
    "top10PctAds": [...],
    "top10PctContribution": 68.5,
    "bottom50PctSpend": 12500.00
  },
  "bestWeeks": [
    { "week": "2025-03-10", "cpr": 3.20, "spend": 1500, "results": 469 }
  ],
  "worstWeeks": [
    { "week": "2025-08-05", "cpr": 9.80, "spend": 2100, "results": 214 }
  ],
  "waste": {
    "zeroResultSpend": 0,
    "zeroResultWeeks": 0,
    "zeroResultAds": []
  },
  "stability": {
    "anomalyFreeWeeksPct": 100,
    "totalSpikes": 0,
    "avgSpikePct": 0
  }
}
```

#### `GET /admin/ad-insights/:accountId/yearly/creatives`
–ê–Ω–∞–ª–∏–∑ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤.

#### `GET /admin/ad-insights/:accountId/yearly/waste`
–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ—Ä—å –±—é–¥–∂–µ—Ç–∞.

### Tracking Health

#### `GET /admin/ad-insights/:accountId/tracking-health`
–ê–Ω–∞–ª–∏–∑ –∑–¥–æ—Ä–æ–≤—å—è —Ç—Ä–µ–∫–∏–Ω–≥–∞.

**Response:**
```json
{
  "overallHealth": 95,
  "issues": [
    {
      "type": "clicks_no_results",
      "severity": "warning",
      "adId": "120215...",
      "description": "–ö–ª–∏–∫–∏ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Å–∏–π"
    }
  ]
}
```

### Cross-Account Patterns (–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–æ–º–∞–ª–∏–π)

–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ CPR –∞–Ω–æ–º–∞–ª–∏–π –ø–æ –≤—Å–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞–º. –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.

#### `GET /admin/ad-insights/patterns/summary`
–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.

**Response:**
```json
{
  "total_anomalies": 606,
  "total_eligible_weeks": 14500,
  "overall_anomaly_rate": 4.18,
  "top_month": {
    "bucket": "2025-03",
    "anomaly_rate": 6.2,
    "anomaly_count": 45
  },
  "top_precursors": [
    {
      "metric": "frequency",
      "week_offset": "week_minus_1",
      "significant_pct": 72,
      "avg_delta_pct": 38.5,
      "direction": "bad"
    }
  ],
  "family_breakdown": [
    {
      "result_family": "messages",
      "eligible_count": 8500,
      "anomaly_count": 380,
      "anomaly_rate": 4.47
    }
  ],
  "account_breakdown": [
    {
      "account_id": "uuid",
      "fb_account_id": "act_123456",
      "account_name": "Main Account",
      "anomaly_count": 120,
      "pct_of_total": 19.8
    }
  ],
  "period": {
    "from": "2024-01-01",
    "to": "2025-12-23"
  }
}
```

#### `GET /admin/ad-insights/patterns/seasonality`
–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∞–Ω–æ–º–∞–ª–∏–π (anomaly rate –ø–æ –º–µ—Å—è—Ü–∞–º/–Ω–µ–¥–µ–ª—è–º).

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `granularity` - 'month' | 'week' (default: 'month')

**Response:**
```json
{
  "buckets": [
    {
      "bucket": "2025-03",
      "eligible_count": 1200,
      "anomaly_count": 45,
      "anomaly_rate": 3.75,
      "avg_delta_pct": 42.5,
      "is_elevated": true
    }
  ],
  "summary": {
    "total_eligible": 14500,
    "total_anomalies": 606,
    "avg_rate": 4.18,
    "rate_stddev": 1.2
  }
}
```

#### `GET /admin/ad-insights/patterns/metrics`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ—Ç—Ä–∏–∫-–≤–∏–Ω–æ–≤–Ω–∏–∫–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º.

**Response:**
```json
{
  "week_0": [
    {
      "metric": "frequency",
      "occurrences": 606,
      "significant_count": 515,
      "significant_pct": 85,
      "avg_delta_pct": 42.3,
      "direction_breakdown": {
        "bad": 480,
        "good": 20,
        "neutral": 15
      }
    }
  ],
  "week_minus_1": [...],
  "week_minus_2": [...],
  "total_anomalies": 606
}
```

## Frontend

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### `AdminAdInsights.tsx`
–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏:
- **Anomalies** - —Ç–∞–±–ª–∏—Ü–∞ –∞–Ω–æ–º–∞–ª–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é acknowledge
- **Burnout** - –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –≤—ã–≥–æ—Ä–∞–Ω–∏—è
- **Decay/Recovery** - –∞–Ω–∞–ª–∏–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **Yearly** - –≥–æ–¥–æ–≤–æ–π –∞—É–¥–∏—Ç (Pareto, waste, stability)
- **Patterns** - cross-account –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–Ω–æ–º–∞–ª–∏–π (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–∞)

#### Patterns Components (`components/ad-insights/patterns/`)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `SeasonalityChart.tsx` | Bar chart anomaly_rate –ø–æ –º–µ—Å—è—Ü–∞–º/–Ω–µ–¥–µ–ª—è–º —Å baseline –ª–∏–Ω–∏–µ–π |
| `MetricsHeatmap.tsx` | –¢–∞–±–ª–∏—Ü–∞-heatmap: Metric √ó Week (0/-1/-2) ‚Üí significant_pct |
| `PrecursorsCard.tsx` | –¢–æ–ø-10 –º–µ—Ç—Ä–∏–∫-–ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–æ–≤ (week_-1, week_-2) |
| `FamilyBreakdown.tsx` | Breakdown –∞–Ω–æ–º–∞–ª–∏–π –ø–æ result_family |
| `AccountBreakdown.tsx` | Breakdown –∞–Ω–æ–º–∞–ª–∏–π –ø–æ ad accounts |
| `PatternsFilters.tsx` | –§–∏–ª—å—Ç—Ä—ã: granularity, period |

#### `AnomaliesTable.tsx`
–¢–∞–±–ª–∏—Ü–∞ –∞–Ω–æ–º–∞–ª–∏–π —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
- Ad ID / Name
- –¢–∏–ø –∞–Ω–æ–º–∞–ª–∏–∏
- Severity
- Current Value / Baseline
- Delta %
- –°—Ç–∞—Ç—É—Å
- –î–µ–π—Å—Ç–≤–∏—è (Acknowledge)

#### `BurnoutCard.tsx`
–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤—ã–≥–æ—Ä–∞–Ω–∏—è:
- Burnout Score (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä 0-100%)
- Burnout Level (low/medium/high/critical)
- Days Until Burnout
- Contributing Factors
- Recommendation

### API Client (`adInsightsApi.ts`)

```typescript
const adInsightsApi = {
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  sync(accountId, options?): Promise<SyncResponse>,

  // –ê–Ω–æ–º–∞–ª–∏–∏
  getAnomalies(accountId, options?): Promise<AnomaliesResponse>,
  acknowledgeAnomaly(accountId, anomalyId): Promise<boolean>,

  // Burnout
  getBurnoutPredictions(accountId, options?): Promise<BurnoutPredictionsResponse>,
  getLagStats(accountId): Promise<LagDependencyStat[]>,

  // Recovery
  getRecoveryPredictions(accountId): Promise<RecoveryPredictionsResponse>,
  getDecayRecoveryAnalysis(accountId): Promise<DecayRecoveryResponse>,

  // Yearly
  getYearlyAudit(accountId, year?): Promise<YearlyAudit | null>,

  // Tracking
  getTrackingHealth(accountId): Promise<TrackingHealthResponse | null>,

  // Dashboard
  getDashboardStats(accountId): Promise<AdInsightsDashboardStats | null>,
};
```

### –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ camelCase —Ñ–æ—Ä–º–∞—Ç–µ, frontend –æ–∂–∏–¥–∞–µ—Ç snake_case. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ `adInsightsApi.ts`:

#### Decay/Recovery
```typescript
// API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{ decay: { highRiskAds: [...] }, recovery: { likelyRecoveryAds: [...] } }

// –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤:
{ analysis: DecayRecoveryAnalysis[] }
```

#### Yearly Audit
```typescript
// API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
  pareto: { top10PctAds, top10PctContribution, bottom50PctSpend },
  stability: { anomalyFreeWeeksPct, totalSpikes, avgSpikePct },
  waste: { zeroResultSpend, zeroResultWeeks, zeroResultAds }
}

// –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤:
{
  pareto: { top20pct_ads, top20pct_results_share, bottom80pct_ads },
  stability: { avgWeeklyVariation, maxDrawdown, consistentWeeks },
  waste: { zeroResultsSpend, highCprSpend, totalWaste, wastePercentage }
}
```

## –°–µ—Ä–≤–∏—Å—ã

### `adInsightsSync.ts`
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å Meta API:
- `fullSync()` - –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (insights + campaigns + adsets + ads)
- `syncWeeklyInsights()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è weekly insights
- `syncCampaigns()` / `syncAdsets()` / `syncAds()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π

### `resultNormalizer.ts`
–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ `actions_json` –≤ —Å–µ–º–µ–π—Å—Ç–≤–∞.

**–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –û–î–ò–ù action_type –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ª–æ–≥–∏–∫–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ facebookApi.ts):

- `messages` - `onsite_conversion.total_messaging_connection` (—Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç!)
- `leadgen_form` - `onsite_conversion.lead_grouped` (—Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç!)
- `website_lead` - `offsite_conversion.fb_pixel_lead`, `fb_pixel_complete_registration`
- `purchase` - `offsite_conversion.fb_pixel_purchase`
- `click` - `link_click`, `landing_page_view`

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** (–¥—É–±–ª–∏—Ä—É—é—Ç –¥—Ä—É–≥–∏–µ action types):
- `lead` - –∞–≥—Ä–µ–≥–∞—Ç, –¥—É–±–ª–∏—Ä—É–µ—Ç `lead_grouped`
- `messaging_conversation_started_7d` - –¥—É–±–ª–∏—Ä—É–µ—Ç `total_messaging_connection`
- `messaging_first_reply` - –¥—É–±–ª–∏—Ä—É–µ—Ç `total_messaging_connection`

### `anomalyDetector.ts`
–î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π CPR —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π:

**–§–æ–∫—É—Å —Ç–æ–ª—å–∫–æ –Ω–∞ CPR spike** (—Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚â•20% –æ—Ç baseline).

–î–ª—è –∫–∞–∂–¥–æ–π –∞–Ω–æ–º–∞–ª–∏–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è **3 –Ω–µ–¥–µ–ª–∏:**
- `week_0` - **–Ω–µ–¥–µ–ª—è –∞–Ω–æ–º–∞–ª–∏–∏** (—Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è —Å CPR spike)
- `week_minus_1` - –Ω–µ–¥–µ–ª—è –ø–µ—Ä–µ–¥ –∞–Ω–æ–º–∞–ª–∏–µ–π
- `week_minus_2` - 2 –Ω–µ–¥–µ–ª–∏ –¥–æ –∞–Ω–æ–º–∞–ª–∏–∏

**Performance –º–µ—Ç—Ä–∏–∫–∏ (—Å –ø–æ—Ä–æ–≥–∞–º–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π):**
- `frequency` - —Ä–æ—Å—Ç —á–∞—Å—Ç–æ—Ç—ã –ø–æ–∫–∞–∑–æ–≤ (–ø–æ—Ä–æ–≥ 15%)
- `ctr` - –ø–∞–¥–µ–Ω–∏–µ CTR (–ø–æ—Ä–æ–≥ 15%)
- `link_ctr` - –ø–∞–¥–µ–Ω–∏–µ CTR –ø–æ —Å—Å—ã–ª–∫–∞–º (–ø–æ—Ä–æ–≥ 15%)
- `cpm` - —Ä–æ—Å—Ç CPM (–ø–æ—Ä–æ–≥ 15%)
- `spend` - —Ä–æ—Å—Ç —Ä–∞—Å—Ö–æ–¥–∞ (–ø–æ—Ä–æ–≥ 30%)
- `results` - –ø–∞–¥–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ—Ä–æ–≥ 20%)

**Ad Relevance Diagnostics (–∫–∞—á–µ—Å—Ç–≤–æ –∫—Ä–µ–∞—Ç–∏–≤–∞):**
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è **raw values** —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ (–±–µ–∑ –ø–æ—Ä–æ–≥–æ–≤):
- `quality_ranking` - –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫—Ä–µ–∞—Ç–∏–≤–∞
- `engagement_ranking` - –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
- `conversion_ranking` - –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∫—Ä–µ–∞—Ç–∏–≤–∞

**–ó–Ω–∞—á–µ–Ω–∏—è ranking scores –æ—Ç Facebook:**
- `+2` = Above Average (–∑–µ–ª—ë–Ω—ã–π)
- `0` = Average (–∂—ë–ª—Ç—ã–π)
- `-1`, `-2`, `-3` = Below Average (–∫—Ä–∞—Å–Ω—ã–π)

**–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π:**
| –ú–µ—Ç—Ä–∏–∫–∞ | –ü–ª–æ—Ö–æ (–∫—Ä–∞—Å–Ω—ã–π) | –•–æ—Ä–æ—à–æ (–∑–µ–ª—ë–Ω—ã–π) |
|---------|-----------------|------------------|
| frequency | –†–æ—Å—Ç ‚â•15% | –ü–∞–¥–µ–Ω–∏–µ ‚â•15% |
| ctr | –ü–∞–¥–µ–Ω–∏–µ ‚â•15% | –†–æ—Å—Ç ‚â•15% |
| link_ctr | –ü–∞–¥–µ–Ω–∏–µ ‚â•15% | –†–æ—Å—Ç ‚â•15% |
| cpm | –†–æ—Å—Ç ‚â•15% | –ü–∞–¥–µ–Ω–∏–µ ‚â•15% |
| spend | –†–æ—Å—Ç ‚â•30% | (–Ω–µ –æ—Ç–º–µ—á–∞–µ–º) |
| results | –ü–∞–¥–µ–Ω–∏–µ ‚â•20% | –†–æ—Å—Ç ‚â•20% |

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `preceding_deviations` (JSONB):**
```json
{
  "week_0": {
    "week_start": "2025-12-16",
    "week_end": "2025-12-22",
    "deviations": [
      {"metric": "results", "value": 10, "baseline": 15, "delta_pct": -33.3, "is_significant": true, "direction": "bad"}
    ],
    "quality_ranking": 2,
    "engagement_ranking": 0,
    "conversion_ranking": -1
  },
  "week_minus_1": {
    "week_start": "2025-12-09",
    "week_end": "2025-12-15",
    "deviations": [
      {"metric": "frequency", "value": 4.2, "baseline": 2.8, "delta_pct": 50.0, "is_significant": true, "direction": "bad"}
    ],
    "quality_ranking": 2,
    "engagement_ranking": 2,
    "conversion_ranking": 0
  },
  "week_minus_2": { ... }
}
```

### `dailyBreakdownEnricher.ts`
–û–±–æ–≥–∞—â–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ –¥–Ω—è–º:

**–§—É–Ω–∫—Ü–∏—è `enrichDailyBreakdown(adAccountId, options)`:**
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–Ω–æ–º–∞–ª–∏–∏ –≥–¥–µ `daily_breakdown IS NULL` (–∏–ª–∏ –≤—Å–µ –ø—Ä–∏ `forceRefresh=true`)
- –î–ª—è –∫–∞–∂–¥–æ–π –∞–Ω–æ–º–∞–ª–∏–∏:
  - –ß–∏—Ç–∞–µ—Ç `meta_insights_daily` –∑–∞ –Ω–µ–¥–µ–ª—é –∞–Ω–æ–º–∞–ª–∏–∏
  - –í—ã—á–∏—Å–ª—è–µ—Ç CPR –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
  - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å week_avg –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è deviations
  - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç worst/best –¥–Ω–∏ –ø–æ CPR
- Batch update –∞–Ω–æ–º–∞–ª–∏–π —Å `daily_breakdown` JSONB
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –ë–î ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∏–∑ Facebook API (async job)

**–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –¥–Ω—è–º:**
- `impressions`, `spend`, `results` ‚Äî –±–∞–∑–æ–≤—ã–µ
- `frequency = impressions / reach`
- `ctr = clicks / impressions * 100`
- `link_ctr = link_clicks / impressions * 100`
- `cpm = spend / impressions * 1000`
- `cpr = spend / results`

**–ü–æ—Ä–æ–≥–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π:**
| –ú–µ—Ç—Ä–∏–∫–∞ | –ü–æ—Ä–æ–≥ | –ü–ª–æ—Ö–æ | –•–æ—Ä–æ—à–æ |
|---------|-------|-------|--------|
| cpr | 15% | –†–æ—Å—Ç | –ü–∞–¥–µ–Ω–∏–µ |
| frequency | 15% | –†–æ—Å—Ç | –ü–∞–¥–µ–Ω–∏–µ |
| ctr | 15% | –ü–∞–¥–µ–Ω–∏–µ | –†–æ—Å—Ç |
| link_ctr | 15% | –ü–∞–¥–µ–Ω–∏–µ | –†–æ—Å—Ç |
| cpm | 15% | –†–æ—Å—Ç | –ü–∞–¥–µ–Ω–∏–µ |
| spend | 30% | –†–æ—Å—Ç | ‚Äî |
| results | 20% | –ü–∞–¥–µ–Ω–∏–µ | –†–æ—Å—Ç |

### `burnoutAnalyzer.ts`
–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≥–æ—Ä–∞–Ω–∏—è:
- Quantile analysis –ø–æ CPR —Ç—Ä–µ–Ω–¥—É
- Lag dependency correlations
- Burnout score (0-1) –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
- Recovery predictions

### `yearlyAnalyzer.ts`
–ì–æ–¥–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã:
- Pareto analysis (80/20 rule)
- Best/Worst weeks
- Waste analysis
- Stability metrics
- Creative lifecycle
- Goal drift

## –ú–∏–≥—Ä–∞—Ü–∏–∏

### Migration 110: `ad_burnout_predictions`
–¢–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –≤—ã–≥–æ—Ä–∞–Ω–∏—è.

### Migration 111: `fix_lag_dependency_stats`
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã `lag_dependency_stats` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏.

### Migration 113: `cpr_preceding_deviations`
–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–ª—è CPR –∞–Ω–æ–º–∞–ª–∏–π:
- –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `ad_weekly_features`: `cpm_lag1/2`, `spend_lag1/2`, `link_ctr`, `link_ctr_lag1/2`, `baseline_cpm/spend/link_ctr`, `cpm/spend/link_ctr_delta_pct`
- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –≤ `ad_weekly_anomalies`: `preceding_deviations` (JSONB)
- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –≤ `meta_insights_weekly`: `link_ctr`

### Migration 114: `ranking_deviations`
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∞–≥–æ–≤ –¥–ª—è Ad Relevance Diagnostics (–∫–∞—á–µ—Å—Ç–≤–æ –∫—Ä–µ–∞—Ç–∏–≤–∞):
- –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `ad_weekly_features`:
  - `quality_rank_lag1`, `quality_rank_lag2` - –ª–∞–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞
  - `engagement_rank_lag1`, `engagement_rank_lag2` - –ª–∞–≥–∏ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏
  - `conversion_rank_lag1`, `conversion_rank_lag2` - –ª–∞–≥–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏

### Migration 115: `daily_insights_pause_detection`
–î–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑ –≤ –¥–æ—Å—Ç–∞–≤–∫–µ —Ä–µ–∫–ª–∞–º—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–Ω–µ–π:

**–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `meta_insights_daily`:**
```sql
CREATE TABLE meta_insights_daily (
    id UUID PRIMARY KEY,
    ad_account_id UUID NOT NULL,
    fb_ad_id TEXT NOT NULL,
    date DATE NOT NULL,
    impressions INTEGER DEFAULT 0,
    clicks INTEGER DEFAULT 0,
    spend DECIMAL(12,2) DEFAULT 0,
    reach INTEGER DEFAULT 0,
    ctr DECIMAL(6,4),
    cpm DECIMAL(10,4),
    cpc DECIMAL(10,4),
    results_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(ad_account_id, fb_ad_id, date)
);
```

**–ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `ad_weekly_anomalies`:**
- `pause_days_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –Ω—É–ª–µ–≤—ã–º–∏ impressions
- `has_delivery_gap` - —Ñ–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞—É–∑—ã –≤ –¥–æ—Å—Ç–∞–≤–∫–µ

**–ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `ad_weekly_features`:**
- `active_days` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å impressions > 0 (–∏–∑ 7)
- `min_daily_impressions` - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ impressions –∑–∞ –¥–µ–Ω—å
- `max_daily_impressions` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ impressions –∑–∞ –¥–µ–Ω—å
- `daily_impressions_cv` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (std/mean)

**–õ–æ–≥–∏–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–∞—É–∑:**
- –ï—Å–ª–∏ spend > 0, –Ω–æ impressions = 0 ‚Üí –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø–∞—É–∑–∞ (–Ω–µ–æ–ø–ª–∞—Ç–∞, –º–æ–¥–µ—Ä–∞—Ü–∏—è, –ª–∏–º–∏—Ç—ã)
- Delivery gap = –µ—Å—Ç—å –¥–Ω–∏ —Å impressions –∏ –¥–Ω–∏ –±–µ–∑ impressions –≤ –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–µ
- –í—ã—Å–æ–∫–∏–π CV —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É

### Migration 116-118: Baseline columns
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ baseline –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫:

**Migration 116:** `baseline_conversion` –¥–ª—è ranking deviations
**Migration 117:** `baseline_quality`, `baseline_engagement` –¥–ª—è Ad Relevance
**Migration 118:** –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ baseline –∫–æ–ª–æ–Ω–∫–∏:
- `baseline_frequency`, `baseline_ctr`, `baseline_cpc`, `baseline_cpm`
- `baseline_spend`, `baseline_link_ctr`, `baseline_results`

### Migration 119: `add_missing_feature_columns`
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ features:
- `results_delta_pct` - –¥–µ–ª—å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ vs baseline
- `results_lag1`, `results_lag2` - –ª–∞–≥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `link_ctr`, `link_ctr_delta_pct` - Link CTR –∏ –µ–≥–æ –¥–µ–ª—å—Ç–∞

### Migration 120-121: `fix_decimal_precision`
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ precision –¥–ª—è –ø–æ–ª–µ–π –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%:
- –í—Å–µ `*_delta_pct` –ø–æ–ª—è: `DECIMAL(12,4)` (–±—ã–ª–æ `DECIMAL(8,2)`)
- `reach_growth_rate`, `freq_slope`, `ctr_slope`: —É–≤–µ–ª–∏—á–µ–Ω precision
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ lag –∫–æ–ª–æ–Ω–∫–∏: `cpm_lag1/2`, `spend_lag1/2`, `link_ctr_lag1/2`

### Migration 122: `fix_ranking_drops_to_decimal`
–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ ranking drop –∫–æ–ª–æ–Ω–æ–∫ —Å SMALLINT –Ω–∞ DECIMAL:
```sql
ALTER TABLE ad_weekly_features
ALTER COLUMN quality_drop TYPE DECIMAL(3,1),
ALTER COLUMN engagement_drop TYPE DECIMAL(3,1),
ALTER COLUMN conversion_drop TYPE DECIMAL(3,1),
ALTER COLUMN relevance_drop TYPE DECIMAL(4,1);
```
**–ü—Ä–∏—á–∏–Ω–∞:** baseline –¥–ª—è rankings - —ç—Ç–æ –º–µ–¥–∏–∞–Ω–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å 1.5), –ø–æ—ç—Ç–æ–º—É drop = score - baseline –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä–æ–±–Ω—ã–º.

### Migration 123: `daily_breakdown_enhancement`
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ daily insights –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ daily_breakdown –¥–ª—è –∞–Ω–æ–º–∞–ª–∏–π:

**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `meta_insights_daily`:**
```sql
ALTER TABLE meta_insights_daily
ADD COLUMN IF NOT EXISTS frequency DECIMAL(8,4),
ADD COLUMN IF NOT EXISTS link_clicks INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS link_ctr DECIMAL(8,6),
ADD COLUMN IF NOT EXISTS actions_json JSONB;
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ `daily_breakdown` –≤ `ad_weekly_anomalies`:**
```sql
ALTER TABLE ad_weekly_anomalies
ADD COLUMN IF NOT EXISTS daily_breakdown JSONB;
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `daily_breakdown` (JSONB):**
```json
{
  "days": [
    {
      "date": "2025-01-06",
      "metrics": {
        "impressions": 1500,
        "spend": 25.50,
        "frequency": 1.8,
        "ctr": 2.1,
        "link_ctr": 1.5,
        "cpm": 17.00,
        "cpr": 5.10,
        "results": 5
      },
      "deviations": [
        {"metric": "cpr", "value": 5.10, "week_avg": 4.20, "delta_pct": 21.4, "direction": "bad"}
      ]
    }
  ],
  "summary": {
    "worst_day": "2025-01-08",
    "best_day": "2025-01-06",
    "active_days": 6,
    "pause_days": 1
  }
}
```

## Multi-Account Support

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multi-account –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
- `ad_account_id` - ID —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–∏–∑ `ad_accounts` —Ç–∞–±–ª–∏—Ü—ã)
- `user_account_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–≤–ª–∞–¥–µ–ª—å—Ü–∞

–î–ª—è legacy –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–±–µ–∑ multi-account) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–π `ad_account_id`.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
psql < migrations/110_ad_burnout_predictions.sql
psql < migrations/111_fix_lag_dependency_stats.sql
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```bash
# –ß–µ—Ä–µ–∑ API
curl -X POST "http://localhost:8082/admin/ad-insights/{accountId}/sync?weeks=52" \
  -H "x-user-id: {adminUserId}"
```

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö

–û—Ç–∫—Ä—ã—Ç—å `/admin/ad-insights` –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è tech_admin).

## Changelog

### 2025-12-25 (v5): Cross-Account Patterns Dashboard
- **–ù–û–í–û–ï:** –¢–∞–± "–ü–∞—Ç—Ç–µ—Ä–Ω—ã" –¥–ª—è cross-account –∞–Ω–∞–ª–∏–∑–∞ –∞–Ω–æ–º–∞–ª–∏–π
  - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
  - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ 606 CPR spike –∞–Ω–æ–º–∞–ª–∏–π (—Ç–æ–ª—å–∫–æ delta_pct > 0)
- **–ù–û–í–û–ï:** API endpoints –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
  - `GET /admin/ad-insights/patterns/summary` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  - `GET /admin/ad-insights/patterns/seasonality` - anomaly rate –ø–æ –º–µ—Å—è—Ü–∞–º/–Ω–µ–¥–µ–ª—è–º
  - `GET /admin/ad-insights/patterns/metrics` - –º–µ—Ç—Ä–∏–∫–∏-–≤–∏–Ω–æ–≤–Ω–∏–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º
- **–ù–û–í–û–ï:** –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  - `SeasonalityChart` - bar chart anomaly_rate —Å baseline –∏ elevated buckets
  - `MetricsHeatmap` - —Ç–∞–±–ª–∏—Ü–∞ significant_pct –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º –∏ –Ω–µ–¥–µ–ª—è–º
  - `PrecursorsCard` - —Ç–æ–ø-10 –º–µ—Ç—Ä–∏–∫-–ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–æ–≤ (–∏—Å–∫–ª—é—á–µ–Ω—ã results, cpr)
  - `FamilyBreakdown` - breakdown –ø–æ result_family
  - `AccountBreakdown` - breakdown –ø–æ ad accounts —Å –∏–º–µ–Ω–∞–º–∏
- **–ù–û–í–û–ï:** Account names lookup
  - –î–ª—è multi-account: –∏–∑ `ad_accounts.name`
  - –î–ª—è legacy: –∏–∑ `user_accounts.username`
- **–ö–õ–Æ–ß–ï–í–´–ï –ò–ù–°–ê–ô–¢–´:**
  - Anomaly rate = anomalies / eligible_weeks (–Ω–µ –ø—Ä–æ—Å—Ç–æ count!)
  - Elevated buckets: rate > avg + 1œÉ
  - –ü—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∏: –º–µ—Ç—Ä–∏–∫–∏ week_-1 –∏ week_-2, –∏—Å–∫–ª—é—á–∞—è results –∏ cpr (—Å–ª–µ–¥—Å—Ç–≤–∏—è)

### 2025-12-25 (v4): Daily Breakdown –¥–ª—è –∞–Ω–æ–º–∞–ª–∏–π
- **–ù–û–í–û–ï:** –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
  - –î–ª—è –∫–∞–∂–¥–æ–π –∞–Ω–æ–º–∞–ª–∏–∏ (–Ω–µ–¥–µ–ª—è + –æ–±—ä—è–≤–ª–µ–Ω–∏–µ) –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –¥–Ω—é
  - –ú–µ—Ç—Ä–∏–∫–∏: impressions, spend, frequency, ctr, link_ctr, cpm, cpr, results
  - –û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è worst/best –¥–Ω–∏ –ø–æ CPR
  - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ –Ω–µ–¥–µ–ª—é
- **–ù–û–í–û–ï:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `meta_insights_daily` (–º–∏–≥—Ä–∞—Ü–∏—è 123)
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: frequency, link_clicks, link_ctr, actions_json
  - –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ syncDailyInsights()
- **–ù–û–í–û–ï:** –°–µ—Ä–≤–∏—Å `dailyBreakdownEnricher.ts`
  - –û–±–æ–≥–∞—â–∞–µ—Ç –∞–Ω–æ–º–∞–ª–∏–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ –¥–Ω—è–º
  - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î (–Ω–µ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ Facebook API)
- **–ù–û–í–û–ï:** Endpoint `POST /admin/ad-insights/:accountId/enrich-daily-breakdown`
  - Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `forceRefresh` (boolean), `limit` (number)
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{ success, enriched, skipped, errors }`
- **–ù–û–í–û–ï:** UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `DailyBreakdownTable`
  - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ expanded row –∞–Ω–æ–º–∞–ª–∏–π
  - –¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: –î–µ–Ω—å, Spend, Impr, CTR, CPM, Results, CPR, –°–∏–≥–Ω–∞–ª—ã
  - –ü–æ–¥—Å–≤–µ—Ç–∫–∞ worst (–∫—Ä–∞—Å–Ω—ã–π) –∏ best (–∑–µ–ª—ë–Ω—ã–π) –¥–Ω–µ–π
  - –ò–Ω–¥–∏–∫–∞—Ü–∏—è pause –¥–Ω–µ–π
- **–¢–†–ï–ë–£–ï–¢–°–Ø:**
  1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 123
  2. –ü–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ: `POST /admin/ad-insights/:accountId/sync`
  3. –û–±–æ–≥–∞—Ç–∏—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏: `POST /admin/ad-insights/:accountId/enrich-daily-breakdown`

### 2025-12-25 (v3): Complete Preceding Deviations + Schema Fixes
- **–ù–û–í–û–ï:** On-the-fly baseline calculation
  - –ï—Å–ª–∏ stored baselines = null, baseline –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 8 –Ω–µ–¥–µ–ª—å
  - –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –Ω–æ–≤—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö baselines
- **–ù–û–í–û–ï:** –í—Å–µ 7 –º–µ—Ç—Ä–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö 3 –Ω–µ–¥–µ–ª—å
  - –†–∞–Ω–µ–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (>15%)
  - –¢–µ–ø–µ—Ä—å: frequency, ctr, link_ctr, cpm, cpr, spend, results ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
  - CPR –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –≤ preceding_deviations
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** Schema fixes (–º–∏–≥—Ä–∞—Ü–∏–∏ 116-122)
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ baseline –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω precision –¥–ª—è delta –ø–æ–ª–µ–π (DECIMAL(12,4) –≤–º–µ—Å—Ç–æ DECIMAL(8,2))
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ lag –∫–æ–ª–æ–Ω–∫–∏ (cpm, spend, link_ctr)
  - Ranking drops –∏–∑–º–µ–Ω–µ–Ω—ã —Å SMALLINT –Ω–∞ DECIMAL(3,1) –¥–ª—è –¥—Ä–æ–±–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** weeklyData lookup
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª—é—á—É –¥–∞—Ç—ã –≤–º–µ—Å—Ç–æ lag columns
  - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç features –¥–ª—è week_minus_1 –∏ week_minus_2
- **–û–ë–ù–û–í–õ–ï–ù–û:** UI —Ç–∞–±–ª–∏—Ü—ã –∞–Ω–æ–º–∞–ª–∏–π
  - –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ delta = 0
  - –£–ª—É—á—à–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–∫–ª–∞–º—ã
- **–¢–†–ï–ë–£–ï–¢–°–Ø:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 116-122, –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø—É—Å—Ç–∏—Ç—å detect-anomalies –∏ update-preceding-deviations

### 2025-12-24 (v2): Week 0 + Results Metric + Raw Rankings
- **–ù–û–í–û–ï:** `week_0` –¥–æ–±–∞–≤–ª–µ–Ω –≤ preceding_deviations
  - –ù–µ–¥–µ–ª—è –∞–Ω–æ–º–∞–ª–∏–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞—Ä—è–¥—É —Å –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–µ–¥–µ–ª—è–º–∏
  - –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –Ω–µ–¥–µ–ª—é CPR spike
- **–ù–û–í–û–ï:** –ú–µ—Ç—Ä–∏–∫–∞ `results` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
  - –ü–æ—Ä–æ–≥ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏: 20%
  - –ü–∞–¥–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ = bad (–∫—Ä–∞—Å–Ω—ã–π)
- **–ù–û–í–û–ï:** Raw ranking values –≤ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–µ (week_0, week_-1, week_-2)
  - quality_ranking, engagement_ranking, conversion_ranking
  - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ë–ï–ó –ø–æ—Ä–æ–≥–æ–≤, –ø—Ä–æ—Å—Ç–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  - –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: +2=Above (–∑–µ–ª—ë–Ω—ã–π), 0=Average (–∂—ë–ª—Ç—ã–π), <0=Below (–∫—Ä–∞—Å–Ω—ã–π)
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –£–±—Ä–∞–Ω default limit=50 –∏–∑ endpoint anomalies
  - –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤—Å–µ –∞–Ω–æ–º–∞–ª–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **–û–ë–ù–û–í–õ–ï–ù–û:** UI —Ç–∞–±–ª–∏—Ü—ã - 3-–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ –Ω–µ–¥–µ–ª—å —Å rankings –ø–æ–¥ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–µ–π

### 2025-12-24: Preceding Deviations System + Ad Relevance Diagnostics
- **–ù–û–í–û–ï:** –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–ª—è CPR –∞–Ω–æ–º–∞–ª–∏–π
  - –§–æ–∫—É—Å —Ç–æ–ª—å–∫–æ –Ω–∞ CPR spike (—É–±—Ä–∞–Ω—ã `ctr_drop`, `freq_high`)
  - –î–ª—è –∫–∞–∂–¥–æ–π –∞–Ω–æ–º–∞–ª–∏–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∑–∞ 1-2 –Ω–µ–¥–µ–ª–∏ –¥–æ
  - Performance –º–µ—Ç—Ä–∏–∫–∏: frequency, CTR, link_ctr, CPM, spend
  - –ü–æ—Ä–æ–≥–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏: 15% (30% –¥–ª—è spend)
  - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: bad/good/neutral
- **–ù–û–í–û–ï:** Link CTR (CTR –ø–æ —Å—Å—ã–ª–∫–∞–º) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞
- **–ù–û–í–û–ï:** Ad Relevance Diagnostics (–∫–∞—á–µ—Å—Ç–≤–æ –∫—Ä–µ–∞—Ç–∏–≤–∞) –≤ preceding deviations
  - `quality_ranking` - –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫—Ä–µ–∞—Ç–∏–≤–∞ (Facebook)
  - `engagement_ranking` - –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
  - `conversion_ranking` - –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∫—Ä–µ–∞—Ç–∏–≤–∞
  - –ü–æ—Ä–æ–≥ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏: 20%
  - –ü–∞–¥–µ–Ω–∏–µ = –ø–ª–æ—Ö–æ, —Ä–æ—Å—Ç = —Ö–æ—Ä–æ—à–æ
- **–û–ë–ù–û–í–õ–ï–ù–û:** UI —Ç–∞–±–ª–∏—Ü—ã –∞–Ω–æ–º–∞–ª–∏–π —Å expandable rows
  - –ö–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫—É —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
  - –ù–µ–¥–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
  - –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: –∫—Ä–∞—Å–Ω—ã–π=–ø–ª–æ—Ö–æ, –∑–µ–ª—ë–Ω—ã–π=—Ö–æ—Ä–æ—à–æ
  - –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏ (‚òÖ –∫–∞—á–µ—Å—Ç–≤–æ, üëç –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å, üéØ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏)
- **–¢–†–ï–ë–£–ï–¢–°–Ø:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 113, 114 –∏ –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

### 2025-12-23 (v2)
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Yearly Audit
  - –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ action types –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞ –≤ `resultNormalizer.ts`
  - –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω action_type –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–∫–∞–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  - `messages` = —Ç–æ–ª—å–∫–æ `total_messaging_connection`
  - `leadgen_form` = —Ç–æ–ª—å–∫–æ `lead_grouped`
- **–£–õ–£–ß–®–ï–ù–û:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ "15 –¥–µ–∫ ‚Äî 21 –¥–µ–∫"
- **–¢–†–ï–ë–£–ï–¢–°–Ø:** –ü–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 2025-12-23
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ API –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è frontend expectations
- Burnout predictions endpoint —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î (snake_case)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ adInsightsApi.ts –¥–ª—è decay-recovery –∏ yearly-audit
- –û–±–Ω–æ–≤–ª—ë–Ω Anomaly interface —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (current_value, baseline_value, delta_pct)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω AnomaliesTable –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö API –ø–æ–ª–µ–π
