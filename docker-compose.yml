services:
  agent-brain:
    build: ./services/agent-brain
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./.env.brain
    environment:
      - BRAIN_DRY_RUN=false
      - BRAIN_MAX_ACTIONS_PER_RUN=100
      - BRAIN_DEBUG_LLM=true
      - BRAIN_MODEL=gpt-5.2
      - BRAIN_TEST_MODE=false
      - AGENT_SERVICE_URL=http://agent-service:8082
      - CRON_ENABLED=true
      - HOURLY_CRON_ENABLED=true
      - CRON_SCHEDULE=0 8 * * *
      - LOG_ALERT_TELEGRAM_BOT_TOKEN=${LOG_ALERT_TELEGRAM_BOT_TOKEN}
      - LOG_ALERT_TELEGRAM_CHAT_ID=${LOG_ALERT_TELEGRAM_CHAT_ID}
      - LOKI_URL=http://loki:3100
      - LOG_ALERT_LOKI_ENVIRONMENT=development
      - MONITORING_BOT_TOKEN=${MONITORING_BOT_TOKEN}
      - MONITORING_CHAT_ID=${MONITORING_CHAT_ID}
      - HOSTNAME=agent-brain-prod
      - OPENAI_MAX_RETRIES=3
      - HYBRID_ENABLED=true
      - ENABLE_LAYER_LOGGING=true
      # Claude Agent SDK (ANTHROPIC_API_KEY берётся из .env.brain)
      # Agent-brain использует прямое подключение к OpenAI/Anthropic для cron задач
      - LLM_PROVIDER=openai
      - LLM_FALLBACK=true
      - CLAUDE_MODEL=claude-sonnet-4-20250514
      - CLAUDE_MAX_TURNS=10
      - CLAUDE_TIMEOUT_MS=120000
      - MCP_ENABLED=true
      # Moltbot Gateway - НЕ используется agent-brain (только для Telegram)
      # - MOLTBOT_GATEWAY_URL=ws://moltbot:18789
      # - MOLTBOT_TOKEN=moltbot-dev-token-2026
    ports:
      - "7080:7080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    # Agent-brain no longer depends on moltbot directly
    # Moltbot calls agent-brain via HTTP API

  creative-analyzer:
    build: ./services/agent-brain
    env_file:
      - ./.env.brain
    environment:
      - ANALYZER_PORT=7081
    command: node src/analyzerService.js
    ports:
      - "7081:7081"
    restart: unless-stopped

  agent-service:
    build: ./services/agent-service
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - ./.env.agent
    environment:
      - AGENT_DRY_RUN=false
      - FB_VALIDATE_ONLY=false
      - CAMPAIGN_BUILDER_MODEL=gpt-4o
      - ANALYZER_URL=http://creative-analyzer:7081
      - CHATBOT_SERVICE_URL=http://chatbot-service:8083
      - CREATIVE_GENERATION_SERVICE_URL=http://creative-generation-service:8085
      # Вернуть легаси онбординг (Moltbot не работает на production)
      - ENABLE_LEGACY_ONBOARDING=true
    ports:
      - "8082:8082"
    restart: unless-stopped
    depends_on:
      - chatbot-service
      - creative-generation-service

  # Creative Generation Service (AI-powered creative generation with Gemini 3 Pro)
  creative-generation-service:
    build: ./services/creative-generation-service
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./services/creative-generation-service/.env
    environment:
      - PORT=8085
      - NODE_ENV=production
    ports:
      - "8085:8085"
    restart: unless-stopped

  # AI Chatbot Service
  chatbot-service:
    build: ./services/chatbot-service
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./.env.chatbot
    environment:
      - PORT=8083
      - NODE_ENV=production
      - REDIS_URL=redis://redis-chatbot:6379
      - EVOLUTION_API_URL=http://evolution-api:8080
      - CRM_BACKEND_URL=http://crm-backend:8084
      # Evolution PostgreSQL (for reading WhatsApp messages directly)
      - EVOLUTION_DB_HOST=evolution-postgres
      - EVOLUTION_DB_PORT=5432
      - EVOLUTION_DB_USER=evolution
      - EVOLUTION_DB_PASSWORD=${EVOLUTION_DB_PASSWORD}
      - EVOLUTION_DB_NAME=evolution
      # CAPI Analysis Cron (Level 2-3 qualification)
      - CAPI_CRON_ENABLED=true
      - CAPI_CRON_SCHEDULE=0 * * * *
      - CAPI_CRON_BATCH_SIZE=50
      - CAPI_CRON_ACTIVITY_WINDOW=60
    ports:
      - "8083:8083"
    restart: unless-stopped
    depends_on:
      - redis-chatbot
      - crm-backend
      - evolution-postgres

  # Redis for Chatbot (message queues, reactivation campaigns)
  redis-chatbot:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6381:6379"
    volumes:
      - redis-chatbot-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Chatbot Worker (reactivation campaigns, cron jobs)
  chatbot-worker:
    build: ./services/chatbot-service
    command: npm run worker
    labels:
      logging: "promtail"
    env_file:
      - ./.env.chatbot
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis-chatbot:6379
      - EVOLUTION_API_URL=http://evolution-api:8080
    restart: unless-stopped
    depends_on:
      - redis-chatbot
      - chatbot-service

  # CRM Backend Service (Dialog Analysis)
  crm-backend:
    build: ./services/crm-backend
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./.env.crm
    environment:
      - PORT=8084
      - NODE_ENV=production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8084:8084"
    restart: unless-stopped
    depends_on:
      - evolution-postgres

  # CRM Frontend
  crm-frontend:
    build:
      context: ./services/crm-frontend
      args:
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    environment:
      - NODE_ENV=production
    ports:
      - "3003:80"
    restart: unless-stopped
    depends_on:
      - crm-backend
      - chatbot-service

  # Production frontend (app.performanteaiagency.com)
  frontend:
    build:
      context: ./services/frontend
      args:
        BUILD_MODE: production
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    environment:
      - NODE_ENV=production
    ports:
      - "3001:80"
    restart: unless-stopped
    depends_on:
      - agent-service

  # App Review frontend (performanteaiagency.com)
  frontend-appreview:
    build:
      context: ./services/frontend
      args:
        BUILD_MODE: appreview
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    environment:
      - NODE_ENV=production
    ports:
      - "3002:80"
    restart: unless-stopped
    depends_on:
      - agent-service

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-production.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - frontend-appreview
      - agent-service
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.1
    command: ["-config.file=/etc/loki/local-config.yml"]
    ports:
      - "3100:3100"
    volumes:
      - ./logging/loki-config.yml:/etc/loki/local-config.yml:ro
      - loki-data:/loki
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.1
    command: ["-config.file=/etc/promtail/promtail-config.yml"]
    environment:
      - PROMTAIL_ENVIRONMENT=development
    volumes:
      - ./logging/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - loki
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.3
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_DATAPROXY_LOGGING=true
    volumes:
      - grafana-data:/var/lib/grafana
      - ./logging/grafana-provisioning:/etc/grafana/provisioning
    depends_on:
      - loki
    restart: unless-stopped

  # Evolution API - WhatsApp integration
  # ВАЖНО: Используется кастомный форк с патчем extractAdMetadata для извлечения sourceId из рекламных сообщений
  # Репозиторий: https://github.com/dengineproblem/evolution-api-fork
  # Обновление: cd ~/evolution-api && git pull origin main && docker build -t atendai/evolution-api:2.3.7-patched .
  evolution-api:
    image: atendai/evolution-api:2.3.7-patched
    container_name: evolution-api
    ports:
      - "8080:8080"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1  # Отключен для стабильности WhatsApp подключения
    environment:
      - SERVER_URL=https://evolution.performanteaiagency.com
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:${EVOLUTION_DB_PASSWORD}@evolution-postgres:5432/evolution
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution-redis:6379/0
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://agent-service:8082/webhooks/evolution
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - CONFIG_SESSION_PHONE_CLIENT=Evolution API
      - QRCODE_LIMIT=30
      - LOG_LEVEL=DEBUG
      - LOG_COLOR=false
      - LOG_BAILEYS=debug
      - WEBSOCKET_ENABLED=true
    depends_on:
      - evolution-redis
      - evolution-postgres
      - agent-service
    restart: unless-stopped

  evolution-redis:
    image: redis:7-alpine
    container_name: evolution-redis
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - evolution-redis-data:/data
    restart: unless-stopped

  evolution-postgres:
    image: postgres:15-alpine
    container_name: evolution-postgres
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=${EVOLUTION_DB_PASSWORD}
      - POSTGRES_DB=evolution
    ports:
      - "5433:5432"
    volumes:
      - evolution-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  # Moltbot - AI Agent Gateway
  # Uses beta channel (moltbot@beta) which has the CLI
  # Using Debian-slim for better native module support (vs Alpine/musl)
  # Telegram интеграция через channels add (не отдельный контейнер)
  # ❌ ОТКЛЮЧЕНО: moltbot заменён на telegram-claude-bot
  # moltbot:
  #   build: ./services/moltbot
  #   container_name: moltbot
  #   env_file:
  #     - ./.env.brain
  #   ports:
  #     - "18789:18789"
  #   environment:
  #     # Только переменные которых нет в env_file
  #     - AGENT_SERVICE_URL=http://agent-service:8082
  #     - MOLTBOT_TOKEN=moltbot-prod-token-2026
  #     # API Keys и MOLTBOT_TELEGRAM_BOT_TOKEN приходят из env_file (.env.brain)
  #     # Enable subagent tools
  #     - OPENCLAW_TOOLS_SANDBOX_ALLOW=sessions_*,system/*
  #     - MOLTBOT_AGENT_TOOLS_AUTO_REGISTER=true
  #     - OPENCLAW_GATEWAY_OPENAI_TOOL_SCHEMA=true
  #   volumes:
  #     - ./moltbot-workspace-router:/root/clawd/moltbot-workspace-router
  #     - ./moltbot-workspace-facebook:/root/clawd/moltbot-workspace-facebook
  #     - ./moltbot-workspace-creatives:/root/clawd/moltbot-workspace-creatives
  #     - ./moltbot-workspace-crm:/root/clawd/moltbot-workspace-crm
  #     - ./moltbot-workspace-tiktok:/root/clawd/moltbot-workspace-tiktok
  #     - ./moltbot-workspace-onboarding:/root/clawd/moltbot-workspace-onboarding
  #     - ./services/moltbot/moltbot-config-template.json:/root/clawd/moltbot-config-template.json
  #     - moltbot-config:/root/.moltbot
  #   restart: unless-stopped
  #   networks:
  #     - default
  #   depends_on:
  #     - agent-service

  telegram-claude-bot:
    build: ./services/telegram-claude-bot
    container_name: telegram-claude-bot
    labels:
      logging: "promtail"
    env_file:
      - ./services/telegram-claude-bot/.env
    environment:
      - NODE_ENV=production
      - BRAIN_SERVICE_URL=http://agent-brain:7080
    volumes:
      - telegram-bot-data:/app/data
      - telegram-bot-store:/app/store
    restart: unless-stopped
    depends_on:
      - agent-brain

  subscription-bot:
    build: ./services/subscription-bot
    container_name: subscription-bot
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./services/subscription-bot/.env
    environment:
      - NODE_ENV=production
      - PORT=8087
    ports:
      - "8087:8087"
    restart: unless-stopped

  fake-reports-service:
    build: ./services/fake-reports-service
    labels:
      logging: "promtail"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file:
      - ./services/fake-reports-service/.env
    environment:
      - PORT=8086
      - NODE_ENV=production
    ports:
      - "8086:8086"
    restart: unless-stopped

volumes:
  loki-data:
  grafana-data:
  evolution-redis-data:
  evolution-postgres-data:
  redis-chatbot-data:
  moltbot-config:
  telegram-bot-data:
  telegram-bot-store:
