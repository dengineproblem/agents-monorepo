# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Scoring Agent - 2025-11-20

## üéØ –¶–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

–£–±—Ä–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è Scoring Agent –∫ Facebook API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤. –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `creative_metrics_history`.

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `getCreativeMetricsFromDB()`**

**–§–∞–π–ª:** `services/agent-brain/src/scoring.js` (—Å—Ç—Ä–æ–∫–∞ ~700)

–§—É–Ω–∫—Ü–∏—è —á–∏—Ç–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∏–∑ `creative_metrics_history` –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30):

```javascript
async function getCreativeMetricsFromDB(supabase, userAccountId, fbCreativeId, days = 30)
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `null` - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∫—Ä–µ–∞—Ç–∏–≤–∞)
- `Object` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
  - impressions, spend, reach, clicks, leads
  - avg_cpl, avg_ctr, avg_cpm, avg_frequency
  - data_points (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏)

---

### 2. **–ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –≤ `runScoringAgent()`**

**–ë—ã–ª–æ:** 
```javascript
const stats = await fetchCreativeInsights(ad_account_id, access_token, fb_creative_id);
if (stats) {
  creatives.push({ ... });
}
```

**–°—Ç–∞–ª–æ:**
```javascript
const stats = await getCreativeMetricsFromDB(supabase, userAccountId, fb_creative_id, 30);
creatives.push({
  objective: 'MESSAGES',
  fb_creative_id: fb_creative_id,
  performance: stats,
  has_data: stats !== null  // –ù–û–í–û–ï: —Ñ–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
});
```

**–ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:** –ö—Ä–µ–∞—Ç–∏–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤ **–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫** (first run).

---

### 3. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –±–µ–∑ –º–µ—Ç—Ä–∏–∫**

–í `readyCreatives` —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:

```javascript
{
  ...
  has_data: creatives.some(c => c.has_data), // –ï—Å—Ç—å –ª–∏ –º–µ—Ç—Ä–∏–∫–∏
  risk_score: performance ? calculateRiskScoreWithROI(...) : null // null –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
}
```

---

### 4. **–õ–æ–≥–∏–∫–∞ `unused_creatives`**

–ö—Ä–µ–∞—Ç–∏–≤ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `unused_creatives` –µ—Å–ª–∏:

1. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö ads** (`isUnused = true`)
2. **–ò–õ–ò —É –Ω–µ–≥–æ –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –≤ –ë–î** (`has_data = false`) - **–ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö**

```javascript
const hasData = readyCreative?.has_data || false;
const isUnused = !creativeIds.some(id => activeCreativeIds.creativeIdsSet.has(id));

if (isUnused || !hasData) {
  unusedCreatives.push({
    ...
    first_run: !hasData,  // –§–õ–ê–ì –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    not_in_active_ads: isUnused
  });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `unused_creatives` —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç:
  - –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  - **+ –ö—Ä–µ–∞—Ç–∏–≤—ã –±–µ–∑ –º–µ—Ç—Ä–∏–∫ (–Ω–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)**

---

### 5. **–í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ**

```javascript
const creativesWithData = readyCreatives.filter(c => c.has_data);
const creativesWithoutData = readyCreatives.filter(c => !c.has_data);

return {
  adsets: adsetsWithTrends,
  ready_creatives: creativesWithData,  // –¢–æ–ª—å–∫–æ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
  unused_creatives: unusedCreatives    // –í–∫–ª—é—á–∞–µ—Ç first_run –∫—Ä–µ–∞—Ç–∏–≤—ã
};
```

---

### 6. **–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**

- `fetchCreativeInsights()` - –æ–±—Ä–∞—â–∞–ª–∞—Å—å –∫ FB API
- `saveCreativeMetricsToHistory()` - —Å–æ—Ö—Ä–∞–Ω—è–ª–∞ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ FB API

–¢–µ–ø–µ—Ä—å –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º** –∏ —É–∂–µ –µ—Å—Ç—å –≤ `creative_metrics_history`.

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –≤ –ë–î)

1. Scoring Agent –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –∏–∑ `user_creatives`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `creative_metrics_history`
3. **–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç** ‚Üí `has_data: false`
4. –ö—Ä–µ–∞—Ç–∏–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `unused_creatives` —Å —Ñ–ª–∞–≥–æ–º `first_run: true`
5. **LLM –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ unused_creatives** –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏—Ö

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ï—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î

1. Scoring Agent —á–∏—Ç–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ `creative_metrics_history`
2. –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
3. –ö—Ä–µ–∞—Ç–∏–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `ready_creatives` —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
4. **LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç performance** –∏ —Ä–µ—à–∞–µ—Ç:
   - –†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—É—á—à–∏–µ
   - –ò–ª–∏ –ø–∞—É–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–æ—Ö–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ö—Ä–µ–∞—Ç–∏–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ads

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `getActiveCreativeIds()` (FB API)
2. –ï—Å–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤ –Ω–µ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö ads ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `unused_creatives`
3. –î–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å historical –º–µ—Ç—Ä–∏–∫–∏

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### `ready_creatives` (—Ç–æ–ª—å–∫–æ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏):

```javascript
[
  {
    id: "uuid",
    title: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–∞",
    direction_id: "uuid",
    has_data: true,  // ‚úÖ –ï—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∏
    creatives: [
      {
        objective: 'MESSAGES',
        fb_creative_id: "120201234567890",
        performance: {
          impressions: 50000,
          spend: 120.5,
          avg_cpl: 2.41,
          avg_ctr: 3.2,
          total_leads: 50,
          data_points: 28
        },
        has_data: true
      }
    ],
    risk_score: 65,
    roi_data: { ... }
  }
]
```

### `unused_creatives` (–≤–∫–ª—é—á–∞—è first_run):

```javascript
[
  {
    id: "uuid",
    title: "–ù–æ–≤—ã–π –∫—Ä–µ–∞—Ç–∏–≤",
    direction_id: "uuid",
    fb_creative_id_whatsapp: "120201234567890",
    recommended_objective: "WhatsApp",
    first_run: true,        // üÜï –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –≤ –ë–î
    not_in_active_ads: true // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ads
  },
  {
    id: "uuid2",
    title: "–°—Ç–∞—Ä—ã–π –∫—Ä–µ–∞—Ç–∏–≤",
    first_run: false,        // –ï—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∏
    not_in_active_ads: true  // –ü—Ä–æ—Å—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
  }
]
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ë—ã—Å—Ç—Ä–µ–µ** - –Ω–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ FB API –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞
2. **–ù–∞–¥–µ–∂–Ω–µ–µ** - –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç rate limits FB API
3. **–ü—Ä–æ—â–µ** - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–ë–î)
4. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫** - –∫—Ä–µ–∞—Ç–∏–≤—ã –±–µ–∑ –º–µ—Ç—Ä–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ unused
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

–¢–µ–ø–µ—Ä—å –Ω–µ–æ–±—Ö–æ–¥–∏–º **–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å** –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –≤ `creative_metrics_history`:

```javascript
// –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (cron job)
// –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
// –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö ads –∏–∑ FB API
// –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ creative_metrics_history
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ads

`getActiveCreativeIds()` **–≤—Å—ë –µ—â—ë –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ FB API**, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–∞–∫–∏–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö ads.

–≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è `unused_creatives`.

### 3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å AdSets

–ß–∞—Å—Ç—å –∫–æ–¥–∞ –¥–ª—è **AdSets** –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FB API:
- `fetchAdsets()`
- `fetchAdsetDiagnostics()`

–≠—Ç–æ **–ù–ï –∏–∑–º–µ–Ω—è–ª–æ—Å—å** –≤ —ç—Ç–æ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:**
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫—Ä–µ–∞—Ç–∏–≤
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å brain/run
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫—Ä–µ–∞—Ç–∏–≤ –ø–æ–ø–∞–ª –≤ `unused_creatives` —Å `first_run: true`

2. **–° –º–µ—Ç—Ä–∏–∫–∞–º–∏:**
   - –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `creative_metrics_history`
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å brain/run
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫—Ä–µ–∞—Ç–∏–≤ –≤ `ready_creatives` —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

3. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫—Ä–µ–∞—Ç–∏–≤:**
   - –ö—Ä–µ–∞—Ç–∏–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏, –Ω–æ –Ω–µ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö ads
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ `unused_creatives` —Å `first_run: false`

---

## üìù TODO (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

- [ ] –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –≤ `creative_metrics_history`
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ `creative_metrics_history`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –≤ –ë–î)

---

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** AI Agent  
**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** `services/agent-brain/src/scoring.js`

