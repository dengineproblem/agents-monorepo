# Спецификация для фронтенд-разработчика: Направления бизнеса

## 📍 Расположение в интерфейсе

**Путь:** Личный кабинет → Меню → **Направления**

```
┌─────────────────────────────────────────┐
│  Личный кабинет                         │
├─────────────────────────────────────────┤
│  Меню:                                  │
│    • Креативы                           │
│    • Кампании                           │
│  ► • Направления  ← НОВАЯ ВКЛАДКА       │
│    • Статистика                         │
│    • Настройки                          │
└─────────────────────────────────────────┘
```

---

## 🎨 UI компоненты

### 1. **Страница "Направления" (`/directions`)**

#### **Пустое состояние (когда направлений нет):**

```
┌────────────────────────────────────────────────────┐
│  Направления бизнеса                               │
├────────────────────────────────────────────────────┤
│                                                     │
│         🎯                                          │
│                                                     │
│      У вас пока нет направлений                    │
│                                                     │
│  Направления помогают разделить рекламу            │
│  по разным услугам или продуктам                   │
│                                                     │
│         [+ Создать направление]                    │
│                                                     │
└────────────────────────────────────────────────────┘
```

#### **Список направлений (когда есть данные):**

```
┌────────────────────────────────────────────────────────────────┐
│  Направления бизнеса                      [+ Создать направление] │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🦷 Имплантация                           [Активно ✓]    │   │
│  │ Тип: WhatsApp                                           │   │
│  │ Бюджет: $50/день  •  Целевой CPL: $2.00                │   │
│  │ Facebook Campaign ID: 123456789                         │   │
│  │                                      [Изменить] [❌]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🦷 Виниры                             [Неактивно ☐]     │   │
│  │ Тип: Instagram Traffic                                  │   │
│  │ Бюджет: $30/день  •  Целевой CPL: $1.50                │   │
│  │ Facebook Campaign ID: 987654321                         │   │
│  │                                      [Изменить] [❌]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🦷 Брекеты                               [Активно ✓]    │   │
│  │ Тип: Site Leads                                         │   │
│  │ Бюджет: $40/день  •  Целевой CPL: $3.00                │   │
│  │ Facebook Campaign ID: 555666777                         │   │
│  │                                      [Изменить] [❌]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

**Дизайн карточки направления:**
- Иконка эмодзи (можно фиксированную 🎯 или пусть пользователь выбирает)
- Название направления (крупный текст)
- Чекбокс "Активно" (зелёный) / "Неактивно" (серый)
- Тип кампании: WhatsApp / Instagram Traffic / Site Leads
- Бюджет и целевой CPL
- Facebook Campaign ID (мелким шрифтом, для отладки)
- Кнопки: [Изменить] [Удалить ❌]

---

### 2. **Модальное окно "Создать направление"**

Открывается при клике на **[+ Создать направление]**

```
┌──────────────────────────────────────────────────┐
│  Создать направление                        [×]  │
├──────────────────────────────────────────────────┤
│                                                   │
│  Название направления *                          │
│  ┌─────────────────────────────────────────┐     │
│  │ Имплантация                             │     │
│  └─────────────────────────────────────────┘     │
│  Например: "Имплантация", "Виниры", "Брекеты"   │
│                                                   │
│  Тип кампании *                                  │
│  ┌─────────────────────────────────────────┐     │
│  │ ○ WhatsApp (переписки)                  │     │
│  │ ○ Instagram Traffic (переходы)          │     │
│  │ ○ Site Leads (заявки на сайте)          │     │
│  └─────────────────────────────────────────┘     │
│                                                   │
│  Суточный бюджет *                               │
│  ┌──────┐                                        │
│  │  50  │  $ / день                              │
│  └──────┘                                        │
│  Минимум: $10/день                               │
│                                                   │
│  Целевая стоимость заявки (CPL) *                │
│  ┌──────┐                                        │
│  │ 2.00 │  $ / заявка                            │
│  └──────┘                                        │
│  Минимум: $0.50/заявка                           │
│                                                   │
│                                                   │
│            [Отмена]      [Создать]               │
└──────────────────────────────────────────────────┘
```

**Поля:**

1. **Название направления** (обязательное)
   - Тип: текст
   - Минимум: 2 символа
   - Максимум: 100 символов
   - Плейсхолдер: "Например: Имплантация"

2. **Тип кампании** (обязательное, радио-кнопки)
   - `whatsapp` → "WhatsApp (переписки)"
   - `instagram_traffic` → "Instagram Traffic (переходы)"
   - `site_leads` → "Site Leads (заявки на сайте)"

3. **Суточный бюджет** (обязательное)
   - Тип: число
   - Минимум: 10 (долларов)
   - Шаг: 1
   - Суффикс: "$ / день"

4. **Целевой CPL** (обязательное)
   - Тип: число
   - Минимум: 0.50 (долларов)
   - Шаг: 0.01
   - Суффикс: "$ / заявка"

**Кнопка "Создать":**
- Активна только если все поля заполнены
- При клике: показать loader, вызвать API, закрыть модалку, обновить список

---

### 3. **Модальное окно "Изменить направление"**

Открывается при клике на **[Изменить]** у существующего направления

```
┌──────────────────────────────────────────────────┐
│  Изменить направление: Имплантация          [×]  │
├──────────────────────────────────────────────────┤
│                                                   │
│  Название направления *                          │
│  ┌─────────────────────────────────────────┐     │
│  │ Имплантация                             │     │
│  └─────────────────────────────────────────┘     │
│                                                   │
│  Тип кампании                                    │
│  WhatsApp (переписки)                            │
│  ⚠️ Тип кампании нельзя изменить                 │
│                                                   │
│  Суточный бюджет *                               │
│  ┌──────┐                                        │
│  │  70  │  $ / день                              │
│  └──────┘                                        │
│                                                   │
│  Целевая стоимость заявки (CPL) *                │
│  ┌──────┐                                        │
│  │ 2.50 │  $ / заявка                            │
│  └──────┘                                        │
│                                                   │
│  Статус                                          │
│  [✓] Активное направление                        │
│                                                   │
│                                                   │
│            [Отмена]      [Сохранить]             │
└──────────────────────────────────────────────────┘
```

**Отличия от создания:**
- Название можно изменить
- **Тип кампании НЕ РЕДАКТИРУЕТСЯ** (показать как текст)
- Бюджет и CPL можно изменить
- Добавлен чекбокс "Активное направление"

---

### 4. **Интеграция с загрузкой креативов**

Когда пользователь загружает креатив, добавить выбор направления:

```
┌────────────────────────────────────────────────────┐
│  Загрузить креатив                                 │
├────────────────────────────────────────────────────┤
│                                                     │
│  Название *                                        │
│  ┌──────────────────────────────────────────────┐  │
│  │ Акция на имплантацию                         │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  Видео *                                           │
│  [📁 Выбрать файл]  video.mp4 (3.2 MB)            │
│                                                     │
│  Направление *                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │ [v] Имплантация (WhatsApp)              ▼   │  │
│  └──────────────────────────────────────────────┘  │
│      ↑                                             │
│      └─ Выпадающий список направлений              │
│                                                     │
│  ⚠️ Креатив будет использоваться для кампании      │
│     типа WhatsApp                                  │
│                                                     │
│  [✓] Активный креатив                              │
│                                                     │
│                                                     │
│              [Отмена]      [Загрузить]             │
└────────────────────────────────────────────────────┘
```

**Логика:**
1. При загрузке страницы → загрузить список активных направлений
2. Показать выпадающий список: `{name} ({objective_readable})`
   - Например: "Имплантация (WhatsApp)", "Виниры (Instagram Traffic)"
3. При выборе направления → показать предупреждение о типе кампании
4. При сохранении → отправить `direction_id` в API

---

## 📡 API Endpoints

### **1. GET `/api/directions?userAccountId={uuid}`**

Получить все направления пользователя.

**Request:**
```javascript
fetch('http://localhost:3000/api/directions?userAccountId=YOUR_UUID')
```

**Response 200:**
```json
{
  "success": true,
  "directions": [
    {
      "id": "uuid-1",
      "user_account_id": "YOUR_UUID",
      "name": "Имплантация",
      "objective": "whatsapp",
      "fb_campaign_id": "123456789",
      "campaign_status": "ACTIVE",
      "daily_budget_cents": 5000,
      "target_cpl_cents": 200,
      "is_active": true,
      "created_at": "2025-10-12T10:00:00Z",
      "updated_at": "2025-10-12T10:00:00Z"
    },
    {
      "id": "uuid-2",
      "name": "Виниры",
      "objective": "instagram_traffic",
      "fb_campaign_id": "987654321",
      "campaign_status": "ACTIVE",
      "daily_budget_cents": 3000,
      "target_cpl_cents": 150,
      "is_active": false,
      "created_at": "2025-10-11T15:30:00Z",
      "updated_at": "2025-10-12T09:15:00Z"
    }
  ]
}
```

**Маппинг для UI:**
- `daily_budget_cents` → разделить на 100 → `$50/день`
- `target_cpl_cents` → разделить на 100 → `$2.00/заявка`
- `objective`:
  - `"whatsapp"` → "WhatsApp (переписки)"
  - `"instagram_traffic"` → "Instagram Traffic (переходы)"
  - `"site_leads"` → "Site Leads (заявки на сайте)"
- `is_active`:
  - `true` → показать зелёный чекбокс "Активно ✓"
  - `false` → показать серый чекбокс "Неактивно ☐"

---

### **2. POST `/api/directions`**

Создать новое направление.

⚠️ **ВАЖНО:** При создании направления автоматически создаётся Facebook Campaign в статусе **ACTIVE** (включена). Это означает что направление сразу готово к работе, как только пользователь добавит креативы.

**Request:**
```javascript
fetch('http://localhost:3000/api/directions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userAccountId: "YOUR_UUID",
    name: "Имплантация",
    objective: "whatsapp",              // "whatsapp" | "instagram_traffic" | "site_leads"
    daily_budget_cents: 5000,            // $50 * 100
    target_cpl_cents: 200                // $2.00 * 100
  })
})
```

**Response 201:**
```json
{
  "success": true,
  "direction": {
    "id": "uuid",
    "name": "Имплантация",
    "objective": "whatsapp",
    "fb_campaign_id": "123456789",
    "campaign_status": "ACTIVE",
    "daily_budget_cents": 5000,
    "target_cpl_cents": 200,
    "is_active": true,
    "created_at": "2025-10-12T12:00:00Z",
    "updated_at": "2025-10-12T12:00:00Z"
  }
}
```

**Response 400 (ошибка валидации):**
```json
{
  "success": false,
  "error": "Validation error",
  "details": [
    {
      "code": "too_small",
      "minimum": 1000,
      "path": ["daily_budget_cents"],
      "message": "Number must be greater than or equal to 1000"
    }
  ]
}
```

**Response 500 (ошибка Facebook API):**
```json
{
  "success": false,
  "error": "Failed to create Facebook campaign",
  "details": "Facebook API error: ..."
}
```

**Обработка в UI:**
- При успехе (201):
  - Закрыть модалку
  - Показать уведомление: "Направление создано!"
  - Обновить список направлений
  - Автоматически создана кампания в Facebook с названием `[Имплантация] WhatsApp`
  
- При ошибке (400, 500):
  - Показать сообщение об ошибке над кнопкой "Создать"
  - Не закрывать модалку

---

### **3. PATCH `/api/directions/{id}`**

Обновить существующее направление.

**Request:**
```javascript
fetch('http://localhost:3000/api/directions/uuid-1', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: "Имплантация Premium",      // опционально
    daily_budget_cents: 7000,         // опционально ($70)
    target_cpl_cents: 250,            // опционально ($2.50)
    is_active: false                  // опционально
  })
})
```

**Response 200:**
```json
{
  "success": true,
  "direction": {
    "id": "uuid-1",
    "name": "Имплантация Premium",
    "objective": "whatsapp",
    "daily_budget_cents": 7000,
    "target_cpl_cents": 250,
    "is_active": false,
    "updated_at": "2025-10-12T13:30:00Z"
  }
}
```

**Обработка в UI:**
- При успехе:
  - Закрыть модалку
  - Показать уведомление: "Направление обновлено!"
  - Обновить карточку в списке

- При ошибке:
  - Показать сообщение об ошибке

**⚠️ ВАЖНО:** Поле `objective` НЕЛЬЗЯ изменить! Не отправляй его в PATCH запросе.

---

### **4. DELETE `/api/directions/{id}`**

Удалить направление (архивирует кампанию в Facebook).

**Request:**
```javascript
fetch('http://localhost:3000/api/directions/uuid-1', {
  method: 'DELETE'
})
```

**Response 200:**
```json
{
  "success": true
}
```

**Response 404:**
```json
{
  "success": false,
  "error": "Direction not found"
}
```

**Обработка в UI:**
- Перед удалением показать подтверждение:
  ```
  ⚠️ Удалить направление "Имплантация"?
  
  Это действие нельзя отменить.
  Кампания в Facebook будет заархивирована.
  Все креативы этого направления потеряют связь.
  
  [Отмена]  [Удалить]
  ```

- При успехе:
  - Удалить карточку из списка
  - Показать уведомление: "Направление удалено"

---

## 🎨 Стили и консистентность

### **Цветовая схема:**

1. **Активное направление:**
   - Бордюр карточки: зелёный (#10b981)
   - Чекбокс "Активно": зелёный фон
   - Иконка: 🟢

2. **Неактивное направление:**
   - Бордюр карточки: серый (#d1d5db)
   - Чекбокс "Неактивно": серый фон
   - Иконка: ⚪
   - Текст: полупрозрачный (opacity: 0.6)

3. **Кнопки:**
   - Первичная (Создать, Сохранить): синий (#3b82f6)
   - Вторичная (Изменить): серый (#6b7280)
   - Опасная (Удалить): красный (#ef4444)

### **Типографика:**
- Название направления: 20px, жирный
- Тип кампании: 14px, обычный, серый
- Бюджет/CPL: 14px, обычный
- Facebook Campaign ID: 12px, моноширинный шрифт, серый

---

## 📋 Чеклист для разработчика

### **Обязательно:**
- [ ] Создать страницу `/directions` в Личном кабинете
- [ ] Добавить вкладку "Направления" в меню
- [ ] Показать пустое состояние когда направлений нет
- [ ] Реализовать список направлений (карточки)
- [ ] Модальное окно "Создать направление"
- [ ] Модальное окно "Изменить направление"
- [ ] Диалог подтверждения удаления
- [ ] Интегрировать GET `/api/directions` при загрузке
- [ ] Интегрировать POST `/api/directions` при создании
- [ ] Интегрировать PATCH `/api/directions/{id}` при редактировании
- [ ] Интегрировать DELETE `/api/directions/{id}` при удалении
- [ ] Конвертировать центы ↔ доллары (× 100 / ÷ 100)
- [ ] Валидация полей (минимумы, максимумы)
- [ ] Показывать loader при запросах к API
- [ ] Обрабатывать ошибки API (показывать сообщения)
- [ ] Обновлять список после создания/изменения/удаления
- [ ] Добавить выбор направления в форму загрузки креатива

### **Опционально (для улучшения UX):**
- [ ] Анимации при открытии/закрытии модалок
- [ ] Transition при удалении карточки из списка
- [ ] Skeleton loader при загрузке направлений
- [ ] Toast уведомления (успех/ошибка)
- [ ] Кнопка "Обновить" для перезагрузки списка
- [ ] Поиск по названию направления
- [ ] Фильтр: показать только активные/неактивные
- [ ] Сортировка: по дате создания / по названию

---

## 🧪 Тестирование

### **Сценарии для тестирования:**

1. **Создание направления:**
   - Открыть модалку, заполнить поля, создать → должна появиться карточка
   - Попробовать создать с пустыми полями → должна быть валидация
   - Попробовать создать с бюджетом < $10 → должна быть ошибка

2. **Редактирование направления:**
   - Открыть модалку, изменить бюджет, сохранить → бюджет обновился
   - Снять чекбокс "Активно", сохранить → карточка стала серой

3. **Удаление направления:**
   - Кликнуть на удалить → должен появиться диалог подтверждения
   - Подтвердить → карточка исчезла из списка

4. **Интеграция с креативами:**
   - Создать направление "Тест" с objective=whatsapp
   - Загрузить креатив, выбрать направление "Тест"
   - Креатив должен сохраниться с `direction_id`

---

## 🚀 Готово!

Если будут вопросы по API или UI — пиши!

## 🌐 API URLs

### Локальная разработка:
```
http://localhost:8082
```

### Production:
```
https://agents.performanteaiagency.com
```

⚠️ **ВАЖНО:** 
- Backend сервис работает на порту **8082** локально
- На production через Nginx всё проксируется через стандартный HTTPS (443)
- Подробная настройка API конфига — см. **DIRECTIONS_FRONTEND_INTEGRATION.md**

**Нужна помощь?**
- Backend разработчик: проверь что сервис `agent-service` запущен
- Если API возвращает 404 → сервис не пересобран после добавления routes

