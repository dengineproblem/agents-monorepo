# WhatsApp CAPI Setup

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Conversions API (CAPI) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤ Meta –ø—Ä–∏ WhatsApp –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è—Ö. –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ "–ù–∞—Å—Ç—Ä–æ–π CAPI", "–ü–æ–¥–∫–ª—é—á–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏", "–ù–∞—Å—Ç—Ä–æ–π –ø–∏–∫—Å–µ–ª—å –¥–ª—è –≤–æ—Ç—Å–∞–ø–∞".

---

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- WhatsApp –ø–æ–¥–∫–ª—é—á—ë–Ω (–ø—Ä–æ–≤–µ—Ä—å `openclaw channels status`)
- Facebook Pixel ID (–∏–∑ Events Manager)
- Access Token —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º `ads_management` (—Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ pixel-specific)

---

## Workflow

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```sql
SELECT * FROM capi_settings WHERE is_active = true;
```

–ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –ø–æ–∫–∞–∂–∏ –∏ —Å–ø—Ä–æ—Å–∏ –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å.

### –®–∞–≥ 2: –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. **Pixel ID** ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä `123456789012345`
2. **Access Token** ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –∏–∑ Events Manager
3. **Event names** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
   - L1: `LeadSubmitted` (–ø–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä–µ—Å, –ø–æ—Ä–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π)
   - L2: `CompleteRegistration` (–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–∏–¥)
   - L3: `Purchase` (–∑–∞–ø–∏—Å–∞–ª—Å—è/–∫—É–ø–∏–ª)
4. **L1 Threshold** ‚Äî –º–∏–Ω–∏–º—É–º –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ L1 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)

### –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```sql
-- –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
UPDATE capi_settings SET is_active = false WHERE is_active = true;

-- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ
INSERT INTO capi_settings (
  channel, pixel_id, access_token,
  l1_event_name, l2_event_name, l3_event_name,
  l1_threshold, is_active
) VALUES (
  'whatsapp', '{pixel_id}', '{access_token}',
  '{l1_event}', '{l2_event}', '{l3_event}',
  {threshold}, true
);
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

```bash
send-capi.sh 1 77001234567
```

–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç:
- **–£—Å–ø–µ—Ö:** `events_received: 1` ‚Äî CAPI —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–û—à–∏–±–∫–∞:** –ø–æ–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥

```sql
SELECT event_name, event_level, status, error_text, sent_at
FROM capi_events_log ORDER BY sent_at DESC LIMIT 5;
```

---

## AI –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è L2/L3 –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è AI-–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```sql
UPDATE capi_settings SET
  ai_l2_description = '{–æ–ø–∏—Å–∞–Ω–∏–µ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–∏–¥–∞}',
  ai_l3_description = '{–æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∞–≤—à–µ–≥–æ—Å—è –∫–ª–∏–µ–Ω—Ç–∞}'
WHERE is_active = true;
```

–ü—Ä–∏–º–µ—Ä—ã:
- L2: "–ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–µ, —É—Å–ª—É–≥–µ –∏–ª–∏ –∑–∞–ø–∏—Å–∏"
- L3: "–ö–ª–∏–µ–Ω—Ç –Ω–∞–∑–≤–∞–ª –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–ø–∏—Å—å"

---

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

```
‚ö° *CAPI –Ω–∞—Å—Ç—Ä–æ–µ–Ω*

üìä Pixel: {pixel_id}
üì§ L1: {l1_event} (–ø–æ—Ä–æ–≥: {threshold} —Å–æ–æ–±—â–µ–Ω–∏–π)
üì§ L2: {l2_event} (–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è AI)
üì§ L3: {l3_event} (–∑–∞–ø–∏—Å—å/–ø–æ–∫—É–ø–∫–∞)

‚úÖ –¢–µ—Å—Ç: —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ WhatsApp –¥–∏–∞–ª–æ–≥–∞—Ö CAPI —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- L1 –ø–æ—Å–ª–µ {threshold} –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- L2 –∫–æ–≥–¥–∞ AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
- L3 –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—à–µ—Ç—Å—è/–∫—É–ø–∏—Ç
```
