# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Analyzer - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### 1. LLM –æ—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –≤–µ—Å—å endpoint ‚ùå
**–°–∏–º–ø—Ç–æ–º**: –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É completed —Ç–µ—Å—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ:
```json
{
  "error": "OpenAI API error: 429 - insufficient_quota"
}
```

**–ü—Ä–∏—á–∏–Ω–∞**: Analyzer –ø—ã—Ç–∞–ª—Å—è —Å–¥–µ–ª–∞—Ç—å LLM –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ OpenAI, –Ω–æ –∫–≤–æ—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –û—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å, –∏ –≤–µ—Å—å endpoint –ø–∞–¥–∞–ª.

**–ù–∞ production —Ä–∞–±–æ—Ç–∞–ª–æ**: –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–º –∞–Ω–∞–ª–∏–∑ —É–∂–µ –±—ã–ª —Å–¥–µ–ª–∞–Ω —Ä–∞–Ω–µ–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è –∏–∑ –∫–µ—à–∞.

### 2. Cancelled —Ç–µ—Å—Ç—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å ‚ùå
**–°–∏–º–ø—Ç–æ–º**: –¢–µ—Å—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `cancelled` –∏ impressions > 0 –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞**: –í —Å—Ç—Ä–æ–∫–µ 565 `analyzerService.js` –Ω–µ –±—ã–ª–æ —É—Å–ª–æ–≤–∏—è –¥–ª—è cancelled:
```javascript
// –ë–´–õ–û:
if (test.status === 'completed' || (test.status === 'running' && test.impressions > 0)) {
  dataSource = 'test';
}
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: `dataSource = 'none'` ‚Üí —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª –¥–∞–Ω–Ω—ã–µ

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: Try-catch –¥–ª—è LLM –∞–Ω–∞–ª–∏–∑–∞ ‚úÖ

**–§–∞–π–ª**: `services/agent-brain/src/analyzerService.js`
**–°—Ç—Ä–æ–∫–∏**: 662-677

**–ë—ã–ª–æ**:
```javascript
if (shouldAnalyze) {
  fastify.log.info({ user_creative_id, data_source: dataSource }, 'Analyzing with LLM');
  
  analysis = await analyzeCreativeTest(metricsForAnalysis, transcriptText);
  // ‚ùå –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ OpenAI - –ø–∞–¥–∞–µ—Ç –≤–µ—Å—å endpoint
}
```

**–°—Ç–∞–ª–æ**:
```javascript
if (shouldAnalyze) {
  fastify.log.info({ user_creative_id, data_source: dataSource }, 'Analyzing with LLM');
  
  try {
    analysis = await analyzeCreativeTest(metricsForAnalysis, transcriptText);
    
    fastify.log.info({ 
      user_creative_id, 
      llm_score: analysis.score,
      llm_verdict: analysis.verdict
    }, 'LLM analysis complete');
  } catch (error) {
    fastify.log.warn({ 
      user_creative_id, 
      error: error.message 
    }, 'LLM analysis failed, continuing without analysis');
    // ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞
    analysis = null;
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—à–∏–±–∫–µ OpenAI –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ –±–µ–∑ LLM –∞–Ω–∞–ª–∏–∑–∞:
```json
{
  "creative": {...},
  "data_source": "test",
  "test": {
    "status": "completed",
    "metrics": {
      "impressions": 1024,
      "reach": 945,
      "leads": 4,
      "cpl_cents": 228
    }
  },
  "analysis": null  // ‚Üê –ù–µ—Ç –∞–Ω–∞–ª–∏–∑–∞, –Ω–æ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å ‚úÖ
}
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cancelled —Ç–µ—Å—Ç–æ–≤ ‚úÖ

**–§–∞–π–ª**: `services/agent-brain/src/analyzerService.js`
**–°—Ç—Ä–æ–∫–∏**: 565-567

**–ë—ã–ª–æ**:
```javascript
// –ï—Å–ª–∏ –Ω–µ—Ç production, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç (completed –∏–ª–∏ running —Å –¥–∞–Ω–Ω—ã–º–∏)
if (!productionMetrics && test) {
  if (test.status === 'completed' || (test.status === 'running' && test.impressions > 0)) {
    dataSource = 'test';
  }
}
```

**–°—Ç–∞–ª–æ**:
```javascript
// –ï—Å–ª–∏ –Ω–µ—Ç production, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç (completed, cancelled –∏–ª–∏ running —Å –¥–∞–Ω–Ω—ã–º–∏)
if (!productionMetrics && test) {
  if (test.status === 'completed' || 
      (test.status === 'running' && test.impressions > 0) ||
      (test.status === 'cancelled' && test.impressions > 0)) {  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    dataSource = 'test';
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å cancelled —Ç–µ—Å—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è:
- ‚úÖ `cancelled` + impressions > 0 ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ `cancelled` + impressions = 0 ‚Üí –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚ùå
```bash
$ curl "http://localhost:8081/api/analyzer/creative-analytics/5b5f5d1b.../..."

{
  "error": "OpenAI API error: 429 - insufficient_quota"
}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ
```bash
$ curl "http://localhost:8081/api/analyzer/creative-analytics/5b5f5d1b.../..."

{
  "creative": "–ú–µ–º 1504_1.mp4",
  "data_source": "test",
  "test": {
    "status": "completed",
    "metrics": {
      "impressions": 1024,
      "leads": 4,
      "cpl_cents": 228
    }
  },
  "analysis": null  ‚úÖ –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ—Ç (–æ–∂–∏–¥–∞–µ–º–æ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ OpenAI quota)
}
```

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Production

### Production (—Ä–∞–±–æ—Ç–∞–ª–æ –≤—Å–µ–≥–¥–∞)
- –ê–Ω–∞–ª–∏–∑ –±—ã–ª —Å–¥–µ–ª–∞–Ω —Ä–∞–Ω–µ–µ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞
- `from_cache: true` ‚Üí OpenAI –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### Local (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- –ü—ã—Ç–∞–ª—Å—è —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ ‚Üí OpenAI 429 ‚Üí –≤–µ—Å—å endpoint –ø–∞–¥–∞–ª

### Local (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- –ü—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏–∑ ‚Üí OpenAI 429 ‚Üí **catch –ª–æ–≤–∏—Ç –æ—à–∏–±–∫—É** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ ‚úÖ

---

## –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

| –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∞ | Impressions | data_source | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
|-------------|-------------|-------------|-------------|
| `running` | 0 | `none` | ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∞–≤–∏–ª—å–Ω–æ) |
| `running` | > 0 | `test` | ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è |
| `completed` | > 0 | `test` | ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ + –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å) |
| `cancelled` | 0 | `none` | ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∞–≤–∏–ª—å–Ω–æ) |
| `cancelled` | > 0 | `test` | ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è *(–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)* |

---

## –ß—Ç–æ –ù–ï –∏—Å–ø—Ä–∞–≤–ª—è–ª–æ—Å—å

### Running —Ç–µ—Å—Ç—ã —Å impressions = 0
**–í–æ–ø—Ä–æ—Å**: –ü–æ—á–µ–º—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å "–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω"?

**–û—Ç–≤–µ—Ç**: –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (impressions = 0)
- –ù–∞ production —Ç–æ–∂–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- –ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è impressions ‚Üí —Å—Ä–∞–∑—É –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ**: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è running —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞.

---

## –ò—Ç–æ–≥–æ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
1. **LLM –æ—à–∏–±–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ** - try-catch –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ OpenAI
2. **Cancelled —Ç–µ—Å—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** - –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ –≤ dataSource

### üìã –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `services/agent-brain/src/analyzerService.js` (2 –∏–∑–º–µ–Ω–µ–Ω–∏—è)

### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç
- Completed —Ç–µ—Å—Ç—ã: –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–∞–∂–µ –±–µ–∑ LLM –∞–Ω–∞–ª–∏–∑–∞ ‚úÖ
- Cancelled —Ç–µ—Å—Ç—ã: –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å impressions ‚úÖ
- Running —Ç–µ—Å—Ç—ã: –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏ –µ—Å–ª–∏ impressions > 0 ‚úÖ

---

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**24 –æ–∫—Ç—è–±—Ä—è 2025, 17:35 (UTC+5)**

–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å OpenAI! üéâ

