# üéØ –ó–ê–î–ê–ß–ê: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è Ad Sets –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏

> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ú—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ–º—Å—è —Å —á–∞—Å—Ç—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ad sets —á–µ—Ä–µ–∑ Meta API —Å —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ WhatsApp. –≠—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ Meta, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è. –ú—ã –Ω–∞—à–ª–∏ –æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å ad sets –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Facebook UI —Å –Ω—É–∂–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –∑–∞—Ä–∞–Ω–µ–µ, –∞ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ad sets –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã](#—Å—É—Ç—å-–ø—Ä–æ–±–ª–µ–º—ã)
2. [–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ](#–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ-—Ä–µ—à–µ–Ω–∏–µ)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–¢–µ–∫—É—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã —Å–æ–∑–¥–∞–Ω–∏—è ad sets](#—Ç–µ–∫—É—â–∏–µ-—Å–µ—Ä–≤–∏—Å—ã-—Å–æ–∑–¥–∞–Ω–∏—è-ad-sets)
5. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
6. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ-–∑–∞–¥–∞–Ω–∏–µ)
7. [–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è](#–∫–ª—é—á–µ–≤—ã–µ-–≤–æ–ø—Ä–æ—Å—ã-–¥–ª—è-–æ–±—Å—É–∂–¥–µ–Ω–∏—è)
8. [–°—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã](#—Å—Å—ã–ª–∫–∏-–Ω–∞-–≤–∞–∂–Ω—ã–µ-—Ñ–∞–π–ª—ã)

---

## üî¥ –°–£–¢–¨ –ü–†–û–ë–õ–ï–ú–´

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ad sets —á–µ—Ä–µ–∑ Meta Graph API —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º `whatsapp_phone_number` –≤ `promoted_object` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:

```json
{
  "error": {
    "message": "Invalid parameter",
    "type": "OAuthException",
    "code": 100,
    "error_subcode": 2446885,
    "error_user_title": "–¢—Ä–µ–±—É–µ—Ç—Å—è –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º WhatsApp Business",
    "error_user_msg": "–ù–æ–º–µ—Ä WhatsApp, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤–∞—à–µ–π –°—Ç—Ä–∞–Ω–∏—Ü–µ–π, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ª–∏—á–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É..."
  }
}
```

**–ö—Ç–æ —Å—Ç—Ä–∞–¥–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å **–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏** (directions), –∫–∞–∂–¥–æ–µ —Å–æ —Å–≤–æ–∏–º –Ω–æ–º–µ—Ä–æ–º WhatsApp
- –ù–∞–ø—Ä–∏–º–µ—Ä: –∫–ª–∏–Ω–∏–∫–∞ —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ "–ò–º–ø–ª–∞–Ω—Ç–∞—Ü–∏—è", "–í–∏–Ω–∏—Ä—ã", "–ë—Ä–µ–∫–µ—Ç—ã" ‚Äî —É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π –Ω–æ–º–µ—Ä –¥–ª—è –ø—Ä–∏–µ–º–∞ –∑–∞—è–≤–æ–∫

**–ö—Ç–æ –ù–ï —Å—Ç—Ä–∞–¥–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å **–æ–¥–Ω–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º** ‚Äî –º–æ–∂–Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–æ–º–µ—Ä —è–≤–Ω–æ, Facebook —Å–∞–º –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞

–≠—Ç–∞ –æ—à–∏–±–∫–∞:
- ‚úÖ **–ò–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞–≤–Ω–æ** (—Å–º. `WHATSAPP_ERROR_2446885_FIX.md`)
- ‚úÖ **–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
- ‚ùå **–ù–µ —Ä–µ—à–∞–µ—Ç—Å—è** –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Meta (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∏—Ö —Å—Ç–æ—Ä–æ–Ω—ã)
- ‚úÖ **–û–±—Ö–æ–¥–∏—Ç—Å—è** —á–µ—Ä–µ–∑ —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ ad sets –≤ Facebook UI

---

## üí° –ü–†–ï–î–õ–ê–ì–ê–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

1. **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–Ω–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º** ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å:
   - –°–æ–∑–¥–∞–µ–º ad sets —á–µ—Ä–µ–∑ API
   - –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä —è–≤–Ω–æ
   - Facebook —Å–∞–º –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

2. **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏** ‚Äî –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–∑–∞—Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–µ—Ç ad sets –≤—Ä—É—á–Ω—É—é** —á–µ—Ä–µ–∑ Facebook Ads Manager UI
   - –í –∫–∞–∂–¥–æ–º ad set —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π –Ω–æ–º–µ—Ä WhatsApp
   - –í –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç —ç—Ç–∏ ad sets —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
   - –ù–∞—à–∏ —Å–µ—Ä–≤–∏—Å—ã **–∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ad sets**, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è –Ω–æ–≤—ã–µ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–±—é–¥–∂–µ—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã) –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π (ads) –≤–Ω—É—Ç—Ä–∏ ad sets ‚Äî —á–µ—Ä–µ–∑ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–û–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—É Meta API** –ø–æ–ª–Ω–æ—Å—Ç—å—é  
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –æ–¥–Ω–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã  
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏  
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** ‚Äî –∞–≥–µ–Ω—Ç –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –±—é–¥–∂–µ—Ç–∞–º–∏, —Å–æ–∑–¥–∞–≤–∞—Ç—å ads, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å/–∑–∞–ø—É—Å–∫–∞—Ç—å ad sets

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
/root/agents-monorepo/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ frontend/              # React (Vite) - UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ agent-service/         # Backend API (Fastify, TypeScript)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/        # API endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions.ts          # AgentBrain actions
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ campaignBuilder.ts  # Auto-launch, Manual-launch
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ creativeTest.ts     # Creative testing
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ directions.ts       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workflows/     # Workflows —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–π/adsets
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ createAdSetInDirection.ts       # Brain Agent workflow
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ createCampaignWithCreative.ts   # Legacy workflow
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ creativeTest.ts                 # Creative test workflow
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ campaignBuilder.ts    # createAdSetInCampaign() - –æ–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ settingsHelpers.ts    # getWhatsAppPhoneNumber() - 4-tier fallback
‚îÇ   ‚îî‚îÄ‚îÄ agent-brain/           # AI Agent (Node.js)
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ server.js      # –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç + cron
‚îÇ           ‚îî‚îÄ‚îÄ scoring.js     # Scoring agent
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ nginx-production.conf
```

### –¢–µ–∫—É—â–∏–µ –¥–æ–º–µ–Ω—ã (production)

- `https://app.performanteaiagency.com` ‚Äî Production frontend
- `https://performanteaiagency.com` ‚Äî App Review frontend (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
- Backend API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –æ–±–æ–∏—Ö –¥–æ–º–µ–Ω–∞—Ö —á–µ—Ä–µ–∑ `/api/*`

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: Supabase PostgreSQL

–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î —á–µ—Ä–µ–∑ Supabase Service Role (–≤ –∫–æ–¥–µ —Å–µ—Ä–≤–∏—Å–æ–≤)

---

## üìä –¢–ï–ö–£–©–ò–ï –°–ï–†–í–ò–°–´ –°–û–ó–î–ê–ù–ò–Ø AD SETS

### 1. **AgentBrain** (Automatic Management)

**–§–∞–π–ª:** `services/agent-brain/src/server.js`  
**Workflow:** `services/agent-service/src/workflows/createAdSetInDirection.ts`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cron –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 (Asia/Almaty)
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç actions (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Direction.CreateAdSetWithCreatives`)
- Agent-service –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ `routes/actions.ts`

**–°–æ–∑–¥–∞–Ω–∏–µ ad set:**
```javascript
// Brain –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç action:
{
  "type": "Direction.CreateAdSetWithCreatives",
  "params": {
    "direction_id": "uuid",
    "user_creative_ids": ["uuid1", "uuid2"],
    "daily_budget_cents": 5000,
    "adset_name": "My AdSet - 2025-11-06"
  }
}

// Agent-service –≤—ã–∑—ã–≤–∞–µ—Ç:
workflowCreateAdSetInDirection(params, context, accessToken)
  ‚Üí –°–æ–∑–¥–∞–µ—Ç ad set —á–µ—Ä–µ–∑ Meta API
  ‚Üí –°–æ–∑–¥–∞–µ—Ç ads –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 4-tier fallback –¥–ª—è WhatsApp –Ω–æ–º–µ—Ä–∞ (`getWhatsAppPhoneNumber`)
- ‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π campaign (`direction.fb_campaign_id`)
- ‚ùå **–°–û–ó–î–ê–ï–¢ –ù–û–í–´–ô ad set** —á–µ—Ä–µ–∑ API

---

### 2. **Auto-Launch V2** (Batch Launch for All Directions)

**–§–∞–π–ª:** `services/agent-service/src/routes/campaignBuilder.ts`  
**Endpoint:** `POST /api/campaign-builder/auto-launch-v2`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - –ë–µ—Ä–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤—ã (–¥–æ 5 —à—Ç.)
  - –°–æ–∑–¥–∞–µ—Ç ad set –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π campaign
  - –°–æ–∑–¥–∞–µ—Ç ads

**–°–æ–∑–¥–∞–Ω–∏–µ ad set:**
```typescript
const adset = await createAdSetInCampaign({
  campaignId: direction.fb_campaign_id,
  adAccountId: userAccount.ad_account_id,
  accessToken: userAccount.access_token,
  name: `${direction.name} - ${new Date().toISOString().split('T')[0]}`,
  dailyBudget: direction.daily_budget_cents,
  targeting,
  optimization_goal,
  billing_event,
  promoted_object,
  start_mode: 'midnight_almaty'
});
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getWhatsAppPhoneNumber` –¥–ª—è –Ω–æ–º–µ—Ä–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
- ‚ùå **–°–û–ó–î–ê–ï–¢ –ù–û–í–´–ô ad set** —á–µ—Ä–µ–∑ API

---

### 3. **Manual Launch** (Single Direction Launch)

**–§–∞–π–ª:** `services/agent-service/src/routes/campaignBuilder.ts`  
**Endpoint:** `POST /api/campaign-builder/manual-launch`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫—Ä–µ–∞—Ç–∏–≤—ã –≤ UI
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∑–∞–¥–∞–µ—Ç –±—é–¥–∂–µ—Ç –∏ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥
- –°–æ–∑–¥–∞–µ—Ç—Å—è ad set –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ Auto-Launch V2
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—é–¥–∂–µ—Ç –∏ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥
- ‚ùå **–°–û–ó–î–ê–ï–¢ –ù–û–í–´–ô ad set** —á–µ—Ä–µ–∑ API

---

### 4. **Creative Test** (A/B Testing)

**–§–∞–π–ª:** `services/agent-service/src/routes/creativeTest.ts`  
**Endpoint:** `POST /api/creative-test/start`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é campaign
- –°–æ–∑–¥–∞–µ—Ç ad set —Å –±—é–¥–∂–µ—Ç–æ–º $20/–¥–µ–Ω—å
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –∫—Ä–µ–∞—Ç–∏–≤

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getWhatsAppPhoneNumber`
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –û–¢–î–ï–õ–¨–ù–£–Æ campaign (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `direction.fb_campaign_id`)
- ‚ùå **–°–û–ó–î–ê–ï–¢ –ù–û–í–´–ô ad set** —á–µ—Ä–µ–∑ API

---

## üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–•

### –¢–∞–±–ª–∏—Ü–∞ `account_directions`

**–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:** `migrations/008_account_directions.sql`

```sql
CREATE TABLE account_directions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_account_id UUID NOT NULL REFERENCES user_accounts(id) ON DELETE CASCADE,
  
  -- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  name TEXT NOT NULL CHECK (char_length(name) >= 2 AND char_length(name) <= 100),
  objective TEXT NOT NULL CHECK (objective IN ('whatsapp', 'instagram_traffic', 'site_leads')),
  
  -- Facebook Campaign
  fb_campaign_id TEXT,  -- ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞–º–ø–∞–Ω–∏–∏ –≤ Facebook
  campaign_status TEXT DEFAULT 'PAUSED',
  
  -- –ë—é–¥–∂–µ—Ç
  daily_budget_cents INTEGER NOT NULL DEFAULT 1000 CHECK (daily_budget_cents >= 1000),
  target_cpl_cents INTEGER NOT NULL DEFAULT 50,
  
  -- –°—Ç–∞—Ç—É—Å
  is_active BOOLEAN DEFAULT true,
  
  -- WhatsApp (–¥–ª—è objective='whatsapp')
  whatsapp_phone_number_id UUID REFERENCES whatsapp_phone_numbers(id) ON DELETE SET NULL,
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT unique_direction_name_per_user UNIQUE (user_account_id, name)
);
```

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `fb_campaign_id` ‚Äî ID Facebook Campaign (—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- `whatsapp_phone_number_id` ‚Äî FK –Ω–∞ —Ç–∞–±–ª–∏—Ü—É WhatsApp –Ω–æ–º–µ—Ä–æ–≤ (–¥–ª—è multi-number setup)

---

### –¢–∞–±–ª–∏—Ü–∞ `whatsapp_phone_numbers`

**–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:** `migrations/012_whatsapp_phone_numbers_table.sql`

```sql
CREATE TABLE whatsapp_phone_numbers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_account_id UUID NOT NULL REFERENCES user_accounts(id) ON DELETE CASCADE,
  
  phone_number TEXT NOT NULL CHECK (phone_number ~ '^\+[1-9][0-9]{7,14}$'),
  label TEXT CHECK (label IS NULL OR char_length(label) <= 100),
  
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT unique_phone_per_user UNIQUE (user_account_id, phone_number)
);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ WhatsApp –Ω–æ–º–µ—Ä–æ–≤
- –ö–∞–∂–¥–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
- Fallback –ª–æ–≥–∏–∫–∞: direction ‚Üí Facebook Page API ‚Üí default from table ‚Üí legacy field

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `WHATSAPP_NUMBERS_LOGIC.md`

---

### –¢–∞–±–ª–∏—Ü–∞ `user_creatives`

```sql
CREATE TABLE user_creatives (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES user_accounts(id),
  direction_id UUID REFERENCES account_directions(id),  -- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
  
  title TEXT,
  media_type TEXT,  -- 'image' –∏–ª–∏ 'video'
  media_url TEXT,
  
  -- Facebook Creative IDs –¥–ª—è —Ä–∞–∑–Ω—ã—Ö objectives
  fb_creative_id_whatsapp TEXT,
  fb_creative_id_instagram_traffic TEXT,
  fb_creative_id_site_leads TEXT,
  
  status TEXT DEFAULT 'ready',  -- 'ready', 'archived', 'testing'
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**–ö–ª—é—á–µ–≤–æ–µ:** –ö—Ä–µ–∞—Ç–∏–≤—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º —á–µ—Ä–µ–∑ `direction_id`

---

### –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è WhatsApp –Ω–æ–º–µ—Ä–∞ (4-tier fallback)

**–§–∞–π–ª:** `services/agent-service/src/lib/settingsHelpers.ts`  
**–§—É–Ω–∫—Ü–∏—è:** `getWhatsAppPhoneNumber(direction, userAccountId, supabaseClient, accessToken?, pageId?)`

```typescript
// Priority 1: –ù–æ–º–µ—Ä –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
if (direction.whatsapp_phone_number_id) {
  // –ß–∏—Ç–∞–µ–º –∏–∑ whatsapp_phone_numbers
  return phoneNumber;
}

// Priority 2: –ù–æ–º–µ—Ä –∏–∑ Facebook Page —á–µ—Ä–µ–∑ Graph API
const response = await fetch(
  `https://graph.facebook.com/v20.0/${pageId}?fields=whatsapp_number&access_token=${accessToken}`
);

// Priority 3: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑ –ë–î
const { data: defaultNumber } = await supabase
  .from('whatsapp_phone_numbers')
  .select('phone_number')
  .eq('user_account_id', userAccountId)
  .eq('is_default', true)
  .single();

// Priority 4: Legacy –ø–æ–ª–µ user_accounts.whatsapp_phone_number
return userAccount.whatsapp_phone_number || null;
```

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `null` (–ù–ï –æ—à–∏–±–∫–∞!) ‚Äî Facebook —Å–∞–º –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π.

---

## üéØ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï

### –ó–∞–¥–∞—á–∞ 1: –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –≤ `account_directions`

**–¶–µ–ª—å:** –†–∞–∑–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–Ω–∏–º/–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏

#### 1.1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É `account_directions`:

```sql
ALTER TABLE account_directions
ADD COLUMN adset_creation_mode TEXT DEFAULT 'api_create' 
CHECK (adset_creation_mode IN ('api_create', 'use_existing'));

COMMENT ON COLUMN account_directions.adset_creation_mode IS 
  '–†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è ad sets:
   - api_create: —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ ad sets —á–µ—Ä–µ–∑ API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   - use_existing: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ ad sets (–¥–ª—è multiple directions —Å —Ä–∞–∑–Ω—ã–º–∏ WhatsApp –Ω–æ–º–µ—Ä–∞–º–∏)';
```

**–ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```sql
ALTER TABLE user_accounts
ADD COLUMN default_adset_mode TEXT DEFAULT 'api_create'
CHECK (default_adset_mode IN ('api_create', 'use_existing'));
```

**–í–æ–ø—Ä–æ—Å –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è:**
- –°—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –Ω–∞ —É—Ä–æ–≤–Ω–µ `user_accounts` (–≥–ª–æ–±–∞–ª—å–Ω–æ) –∏–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ `account_directions` (per-direction)?
- **–ú–æ–µ –º–Ω–µ–Ω–∏–µ:** –ù–∞ —É—Ä–æ–≤–Ω–µ `user_accounts` ‚Äî –ø—Ä–æ—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–¥–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å

---

#### 1.2. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–≤—è–∑–∏ ad sets —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏

```sql
CREATE TABLE direction_adsets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  direction_id UUID NOT NULL REFERENCES account_directions(id) ON DELETE CASCADE,
  
  -- Facebook Ad Set ID (—Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤—Ä—É—á–Ω—É—é)
  fb_adset_id TEXT NOT NULL,
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  adset_name TEXT,  -- –ù–∞–∑–≤–∞–Ω–∏–µ ad set (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI)
  daily_budget_cents INTEGER,  -- –¢–µ–∫—É—â–∏–π –±—é–¥–∂–µ—Ç (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑ Facebook)
  status TEXT,  -- ACTIVE/PAUSED (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è)
  
  -- –ö–æ–≥–¥–∞ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É
  linked_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- –°—Ç–∞—Ç—É—Å –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ
  is_active BOOLEAN DEFAULT true,  -- –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ ad set
  
  CONSTRAINT unique_adset_per_direction UNIQUE (direction_id, fb_adset_id)
);

CREATE INDEX idx_direction_adsets_direction ON direction_adsets(direction_id) WHERE is_active = true;
CREATE INDEX idx_direction_adsets_fb ON direction_adsets(fb_adset_id);
```

**–õ–æ–≥–∏–∫–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç ad sets –≤—Ä—É—á–Ω—É—é –≤ Facebook
- –ö–æ–ø–∏—Ä—É–µ—Ç ID ad set –∏–∑ Facebook Ads Manager
- –í—Å—Ç–∞–≤–ª—è–µ—Ç –≤ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ ad sets –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö

---

### –ó–∞–¥–∞—á–∞ 2: API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ ad sets

#### 2.1. Endpoint: –ü—Ä–∏–≤—è–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ad set –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é

```typescript
// POST /api/directions/:directionId/link-adset
{
  "fb_adset_id": "120232923985510449",
  "user_account_id": "uuid"
}

// Response:
{
  "success": true,
  "direction_adset": {
    "id": "uuid",
    "direction_id": "uuid",
    "fb_adset_id": "120232923985510449",
    "adset_name": "–ò–º–ø–ª–∞–Ω—Ç–∞—Ü–∏—è - –ë–∞–∑–æ–≤—ã–π",
    "daily_budget_cents": 5000,
    "status": "ACTIVE"
  }
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ direction —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ad set –∏–∑ Facebook API (validate ID + –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ/–±—é–¥–∂–µ—Ç)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ad set –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π campaign (`direction.fb_campaign_id`)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `direction_adsets`

**–§–∞–π–ª:** `services/agent-service/src/routes/directions.ts` (–Ω–æ–≤—ã–π endpoint)

---

#### 2.2. Endpoint: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö ad sets

```typescript
// GET /api/directions/:directionId/adsets?user_account_id=uuid

// Response:
{
  "success": true,
  "adsets": [
    {
      "id": "uuid",
      "fb_adset_id": "120232923985510449",
      "adset_name": "–ò–º–ø–ª–∞–Ω—Ç–∞—Ü–∏—è - –ë–∞–∑–æ–≤—ã–π",
      "daily_budget_cents": 5000,
      "status": "ACTIVE",
      "is_active": true,
      "linked_at": "2025-11-06T10:00:00Z"
    }
  ]
}
```

---

#### 2.3. Endpoint: –û—Ç–≤—è–∑–∞—Ç—å ad set –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```typescript
// DELETE /api/directions/:directionId/adsets/:adsetId?user_account_id=uuid

// Response:
{
  "success": true,
  "message": "Ad set unlinked successfully"
}
```

**–õ–æ–≥–∏–∫–∞:**
- –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ `direction_adsets`
- **–ù–ï —É–¥–∞–ª—è—Ç—å —Å–∞–º ad set –≤ Facebook** (–æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º)

---

### –ó–∞–¥–∞—á–∞ 3: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö workflows

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å–æ–∑–¥–∞–Ω–∏—è ad sets –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º.

#### 3.1. –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ (–ø—Å–µ–≤–¥–æ–∫–æ–¥)

```typescript
async function createOrUseAdSet(direction, context) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
  const mode = await getAdSetMode(direction.user_account_id);
  
  if (mode === 'api_create') {
    // –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê: —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π ad set
    return await createNewAdSet(direction, context);
  }
  
  if (mode === 'use_existing') {
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ad set
    const adset = await getAvailableAdSet(direction.id);
    
    if (!adset) {
      throw new Error(
        `No pre-created ad sets available for direction "${direction.name}". ` +
        `Please create ad sets manually in Facebook Ads Manager and link them.`
      );
    }
    
    return adset;
  }
}

async function getAvailableAdSet(directionId) {
  // –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–π ad set —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
  const adsets = await supabase
    .from('direction_adsets')
    .select('*')
    .eq('direction_id', directionId)
    .eq('is_active', true)
    .eq('status', 'ACTIVE');
  
  if (adsets.length === 0) return null;
  
  // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞:
  // - –°–∞–º—ã–π –Ω–æ–≤—ã–π
  // - –° –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º ads
  // - Round-robin
  
  return adsets[0];
}
```

---

#### 3.2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `workflowCreateAdSetInDirection.ts`

**–§–∞–π–ª:** `services/agent-service/src/workflows/createAdSetInDirection.ts`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ):**
```typescript
export async function workflowCreateAdSetInDirection(params, context, accessToken) {
  // 1. –ü–æ–ª—É—á–∏—Ç—å direction
  const direction = await getDirection(params.direction_id);
  
  // 2. –ü–æ–ª—É—á–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã
  const creatives = await getCreatives(params.user_creative_ids);
  
  // 3. –°–æ–∑–¥–∞—Ç—å ad set —á–µ—Ä–µ–∑ API
  const adsetResult = await graph('POST', `${ad_account_id}/adsets`, accessToken, adsetBody);
  
  // 4. –°–æ–∑–¥–∞—Ç—å ads –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞
  for (const creative of creatives) {
    await graph('POST', `${ad_account_id}/ads`, accessToken, adBody);
  }
}
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```typescript
export async function workflowCreateAdSetInDirection(params, context, accessToken) {
  // 1. –ü–æ–ª—É—á–∏—Ç—å direction
  const direction = await getDirection(params.direction_id);
  
  // 2. –ü–æ–ª—É—á–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã
  const creatives = await getCreatives(params.user_creative_ids);
  
  // 3. –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∂–∏–º
  const userAccount = await getUserAccount(context.user_account_id);
  
  let adset_id: string;
  
  if (userAccount.default_adset_mode === 'use_existing') {
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ad set
    const linkedAdSet = await getAvailableLinkedAdSet(direction.id);
    
    if (!linkedAdSet) {
      throw new Error(
        `No pre-created ad sets available for direction "${direction.name}". ` +
        `Please link ad sets in settings.`
      );
    }
    
    adset_id = linkedAdSet.fb_adset_id;
    
    log.info({
      directionId: direction.id,
      adsetId: adset_id,
      mode: 'use_existing'
    }, 'Using pre-created ad set');
    
  } else {
    // –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê: —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π ad set
    const adsetResult = await graph('POST', `${ad_account_id}/adsets`, accessToken, adsetBody);
    adset_id = adsetResult.id;
    
    log.info({
      directionId: direction.id,
      adsetId: adset_id,
      mode: 'api_create'
    }, 'Created new ad set via API');
  }
  
  // 4. –°–æ–∑–¥–∞—Ç—å ads (–û–î–ò–ù–ê–ö–û–í–û –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤)
  for (const creative of creatives) {
    await graph('POST', `${ad_account_id}/ads`, accessToken, {
      name: adName,
      adset_id: adset_id,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID (–Ω–æ–≤—ã–π –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
      creative: { creative_id: creative.fb_creative_id },
      status: 'ACTIVE'
    });
  }
}
```

---

#### 3.3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è Auto-Launch V2

**–§–∞–π–ª:** `services/agent-service/src/routes/campaignBuilder.ts`  
**Endpoint:** `POST /api/campaign-builder/auto-launch-v2`

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ —Ü–∏–∫–ª–µ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º:

```typescript
for (const direction of directions) {
  const mode = userAccount.default_adset_mode;
  
  let adset_id;
  
  if (mode === 'use_existing') {
    const linkedAdSet = await getAvailableLinkedAdSet(direction.id);
    if (!linkedAdSet) {
      log.warn({ directionId: direction.id }, 'No linked ad sets, skipping');
      continue;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    }
    adset_id = linkedAdSet.fb_adset_id;
  } else {
    const adset = await createAdSetInCampaign({...});
    adset_id = adset.id;
  }
  
  // –°–æ–∑–¥–∞–µ–º ads
  await createAdsInAdSet({ adsetId: adset_id, ... });
}
```

---

#### 3.4. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è Manual Launch

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Auto-Launch V2**

---

#### 3.5. Creative Test ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å?

**–í–æ–ø—Ä–æ—Å:** Creative Test —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é campaign. –ù—É–∂–Ω–æ –ª–∏ –µ–≥–æ —Ç—Ä–æ–≥–∞—Ç—å?

**–ú–æ–µ –º–Ω–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å ‚Äî —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ ad sets.

---

### –ó–∞–¥–∞—á–∞ 4: Frontend UI

#### 4.1. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –≤ Settings

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `services/frontend/src/pages/Profile.tsx` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è Settings

```tsx
<div className="setting-item">
  <h3>Ad Set Creation Mode</h3>
  <p>Choose how ad sets are created for your campaigns:</p>
  
  <RadioGroup value={adsetMode} onChange={setAdsetMode}>
    <Radio value="api_create">
      <strong>Single Direction Mode (Default)</strong>
      <p>Automatically create ad sets through Facebook API. 
         Recommended for users with one business direction.</p>
    </Radio>
    
    <Radio value="use_existing">
      <strong>Multiple Directions Mode</strong>
      <p>Use pre-created ad sets with specific WhatsApp numbers. 
         Required for users with multiple directions and separate phone numbers.</p>
    </Radio>
  </RadioGroup>
  
  {adsetMode === 'use_existing' && (
    <Alert type="info">
      You'll need to create ad sets manually in Facebook Ads Manager 
      and link them to your directions.
    </Alert>
  )}
</div>
```

---

#### 4.2. –°–µ–∫—Ü–∏—è "Linked Ad Sets" –≤ Directions

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```tsx
{userSettings.default_adset_mode === 'use_existing' && (
  <div className="linked-adsets-section">
    <h3>Linked Ad Sets</h3>
    <p>These ad sets were pre-created in Facebook and linked to this direction:</p>
    
    <table>
      <thead>
        <tr>
          <th>Ad Set Name</th>
          <th>Facebook ID</th>
          <th>Daily Budget</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {linkedAdSets.map(adset => (
          <tr key={adset.id}>
            <td>{adset.adset_name}</td>
            <td>{adset.fb_adset_id}</td>
            <td>${adset.daily_budget_cents / 100}</td>
            <td>{adset.status}</td>
            <td>
              <button onClick={() => unlinkAdSet(adset.id)}>Unlink</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
    
    <button onClick={openLinkAdSetDialog}>+ Link New Ad Set</button>
  </div>
)}
```

---

#### 4.3. Dialog –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ ad set

```tsx
<Dialog open={linkAdSetDialogOpen} onClose={closeLinkAdSetDialog}>
  <h2>Link Pre-Created Ad Set</h2>
  
  <p>Create an ad set in Facebook Ads Manager first, then paste its ID here:</p>
  
  <ol>
    <li>Go to <a href="https://business.facebook.com/adsmanager" target="_blank">Facebook Ads Manager</a></li>
    <li>Create a new ad set in campaign: <strong>{direction.fb_campaign_id}</strong></li>
    <li>Set your WhatsApp number in the ad set settings</li>
    <li>Copy the ad set ID (format: 120232923985510449)</li>
    <li>Paste it below:</li>
  </ol>
  
  <input 
    type="text" 
    placeholder="120232923985510449"
    value={fbAdSetId}
    onChange={e => setFbAdSetId(e.target.value)}
  />
  
  <button onClick={linkAdSet}>Link Ad Set</button>
</Dialog>
```

---

### –ó–∞–¥–∞—á–∞ 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞–º–∏ –≤ —Ä–µ–∂–∏–º–µ `use_existing`

**–í–æ–ø—Ä–æ—Å:** AgentBrain –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –±—é–¥–∂–µ—Ç—ã ad sets —á–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏–µ `UpdateAdSetDailyBudget`. –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –¥–ª—è pre-created ad sets?

**–û—Ç–≤–µ—Ç:** –î–ê, —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ! AgentBrain –¥–æ–ª–∂–µ–Ω —É–ø—Ä–∞–≤–ª—è—Ç—å –±—é–¥–∂–µ—Ç–∞–º–∏.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –î–µ–π—Å—Ç–≤–∏–µ `UpdateAdSetDailyBudget` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å `fb_adset_id`
- –ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è api_create, –∏ –¥–ª—è use_existing

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** `services/agent-service/src/routes/actions.ts` ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ `UpdateAdSetDailyBudget`

---

### –ó–∞–¥–∞—á–∞ 6: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ad sets

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –±—é–¥–∂–µ—Ç/—Å—Ç–∞—Ç—É—Å ad set –≤ Facebook –Ω–∞–ø—Ä—è–º—É—é, –Ω–∞—à–∞ –ë–î –±—É–¥–µ—Ç out of sync.

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```typescript
// –ù–æ–≤—ã–π endpoint: POST /api/directions/:directionId/sync-adsets

async function syncLinkedAdSets(directionId: string, accessToken: string) {
  const linkedAdSets = await supabase
    .from('direction_adsets')
    .select('*')
    .eq('direction_id', directionId);
  
  for (const linkedAdSet of linkedAdSets) {
    // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Facebook
    const fbData = await graph('GET', linkedAdSet.fb_adset_id, accessToken, {
      fields: 'name,daily_budget,status'
    });
    
    // –û–±–Ω–æ–≤–∏—Ç—å –≤ –ë–î
    await supabase
      .from('direction_adsets')
      .update({
        adset_name: fbData.name,
        daily_budget_cents: parseInt(fbData.daily_budget),
        status: fbData.status
      })
      .eq('id', linkedAdSet.id);
  }
}
```

**–ö–æ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ UI
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ Auto-Launch (–ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ad set)
- –ü–æ –∫–Ω–æ–ø–∫–µ "Sync" –≤ UI

---

## ‚ùì –ö–õ–Æ–ß–ï–í–´–ï –í–û–ü–†–û–°–´ –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø

### 1. –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞?

**–í–∞—Ä–∏–∞–Ω—Ç A:** –ù–∞ —É—Ä–æ–≤–Ω–µ `user_accounts` (–≥–ª–æ–±–∞–ª—å–Ω–æ)
```sql
ALTER TABLE user_accounts ADD COLUMN default_adset_mode TEXT DEFAULT 'api_create';
```

‚úÖ **–ü–ª—é—Å—ã:**
- –ü—Ä–æ—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–¥–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
- –õ–æ–≥–∏—á–Ω–æ: –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏, —Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è

‚ùå **–ú–∏–Ω—É—Å—ã:**
- –ú–µ–Ω–µ–µ –≥–∏–±–∫–æ ‚Äî –Ω–µ–ª—å–∑—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è api_create, –¥–ª—è –¥—Ä—É–≥–æ–≥–æ use_existing

---

**–í–∞—Ä–∏–∞–Ω—Ç B:** –ù–∞ —É—Ä–æ–≤–Ω–µ `account_directions` (per-direction)
```sql
ALTER TABLE account_directions ADD COLUMN adset_creation_mode TEXT DEFAULT 'api_create';
```

‚úÖ **–ü–ª—é—Å—ã:**
- –ì–∏–±—á–µ ‚Äî –º–æ–∂–Ω–æ –º–∏–∫—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º—ã

‚ùå **–ú–∏–Ω—É—Å—ã:**
- –°–ª–æ–∂–Ω–µ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π —Ä–µ–∂–∏–º

---

**–ú–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** –í–∞—Ä–∏–∞–Ω—Ç A (`user_accounts`) ‚Äî –ø—Ä–æ—â–µ –∏ –ª–æ–≥–∏—á–Ω–µ–µ.

---

### 2. –ö–∞–∫ –≤—ã–±–∏—Ä–∞—Ç—å ad set –∏–∑ –ø—É–ª–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö?

–ï—Å–ª–∏ –∫ –æ–¥–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–∏–≤—è–∑–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ ad sets, –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. **–°–∞–º—ã–π –Ω–æ–≤—ã–π** (–ø–æ `linked_at`)
2. **–° –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º ads** (—á—Ç–æ–±—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É)
3. **Round-robin** (–ø–æ –æ—á–µ—Ä–µ–¥–∏)
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç** –≤ UI (–ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)

**–ú–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** –ù–∞—á–∞—Ç—å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞ 1 (—Å–∞–º—ã–π –Ω–æ–≤—ã–π), –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É.

---

### 3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ad sets?

–ö–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç ad set –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ `use_existing`, –Ω–æ –∏—Ö –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—Å–µ `is_active = false`:

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. **–í—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å ad set
2. **Fallback –Ω–∞ api_create** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ API
3. **–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** ‚Äî –≤ Auto-Launch –ø—Ä–æ—Å—Ç–æ skip

**–ú–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
- –í AgentBrain / Auto-Launch ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥
- –í Manual Launch ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

### 4. –ù—É–∂–Ω–æ –ª–∏ —Ç—Ä–æ–≥–∞—Ç—å Creative Test?

Creative Test —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é campaign —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º ad set.

**–í–æ–ø—Ä–æ—Å:** –ü—Ä–∏–º–µ–Ω—è—Ç—å –ª–∏ —Ä–µ–∂–∏–º `use_existing` –∫ Creative Test?

**–ú–æ–µ –º–Ω–µ–Ω–∏–µ:** –ù–ï–¢, –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å. Creative Test ‚Äî —ç—Ç–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–∞–º –Ω–µ –Ω—É–∂–Ω—ã pre-created ad sets.

---

### 5. –ß—Ç–æ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞–º–∏?

AgentBrain –º–æ–∂–µ—Ç:
- –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å/—É–º–µ–Ω—å—à–∞—Ç—å –±—é–¥–∂–µ—Ç—ã ad sets (`UpdateAdSetDailyBudget`)
- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å/–∑–∞–ø—É—Å–∫–∞—Ç—å ad sets (`PauseAdSet` / `ActivateAdSet`)

**–í–æ–ø—Ä–æ—Å:** –î–æ–ª–∂–Ω–æ –ª–∏ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è pre-created ad sets?

**–û—Ç–≤–µ—Ç:** –î–ê! –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≥–µ–Ω—Ç–∞.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –≠—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Facebook API —Å `fb_adset_id`, –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

### 6. UI/UX –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ ad sets

**–í–æ–ø—Ä–æ—Å—ã:**
- –ì–¥–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–Ω–æ–ø–∫–∞ "Link Ad Set"? (–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è? –ù–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ?)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å ad set –≤ Facebook?
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ª–∏ `fb_adset_id` —á–µ—Ä–µ–∑ API –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º?

**–ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:**
- –ö–Ω–æ–ø–∫–∞ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–µ–∂–∏–º `use_existing` –≤–∫–ª—é—á–µ–Ω)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å step-by-step –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ dialog
- –î–ê, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API + –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ad set –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π campaign

---

## üìö –°–°–´–õ–ö–ò –ù–ê –í–ê–ñ–ù–´–ï –§–ê–ô–õ–´

### Backend (agent-service)

**Workflows —Å–æ–∑–¥–∞–Ω–∏—è ad sets:**
- `services/agent-service/src/workflows/createAdSetInDirection.ts` ‚Äî Brain Agent workflow
- `services/agent-service/src/workflows/createCampaignWithCreative.ts` ‚Äî Legacy workflow
- `services/agent-service/src/workflows/creativeTest.ts` ‚Äî Creative test workflow

**Routes:**
- `services/agent-service/src/routes/actions.ts` ‚Äî Brain Agent actions handler
- `services/agent-service/src/routes/campaignBuilder.ts` ‚Äî Auto-launch, Manual-launch
- `services/agent-service/src/routes/creativeTest.ts` ‚Äî Creative test endpoints
- `services/agent-service/src/routes/directions.ts` ‚Äî Directions CRUD

**Helpers:**
- `services/agent-service/src/lib/campaignBuilder.ts` ‚Äî `createAdSetInCampaign()` —Ñ—É–Ω–∫—Ü–∏—è
- `services/agent-service/src/lib/settingsHelpers.ts` ‚Äî `getWhatsAppPhoneNumber()` —Ñ—É–Ω–∫—Ü–∏—è

---

### Frontend

**Pages:**
- `services/frontend/src/pages/Profile.tsx` ‚Äî User settings (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞)
- `services/frontend/src/components/VideoUpload.tsx` ‚Äî Directions management UI

**Services:**
- `services/frontend/src/services/manualLaunchApi.ts` ‚Äî Manual launch API calls
- `services/frontend/src/services/directionsApi.ts` ‚Äî Directions API calls (–º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)

---

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**Migrations:**
- `migrations/008_account_directions.sql` ‚Äî –¢–∞–±–ª–∏—Ü–∞ directions
- `migrations/012_whatsapp_phone_numbers_table.sql` ‚Äî –¢–∞–±–ª–∏—Ü–∞ WhatsApp –Ω–æ–º–µ—Ä–æ–≤

---

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ–∫–∏:**
- `PROJECT_OVERVIEW_RU.md` ‚Äî –û–±—â–∏–π –æ–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞
- `INFRASTRUCTURE.md` ‚Äî –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –¥–µ–ø–ª–æ–π, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `WHATSAPP_ERROR_2446885_FIX.md` ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å WhatsApp –Ω–æ–º–µ—Ä–∞–º–∏
- `WHATSAPP_NUMBERS_LOGIC.md` ‚Äî –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
- `CAMPAIGN_BUILDER_DIRECTIONS_LOGIC.md` ‚Äî –õ–æ–≥–∏–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ Campaign Builder
- `MANUAL_LAUNCH_FRONTEND_SPEC.md` ‚Äî –°–ø–µ–∫–∞ Manual Launch –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

---

## üéØ –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)

### Phase 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ Backend API (2-3 –¥–Ω—è)

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:**
   - –î–æ–±–∞–≤–∏—Ç—å `default_adset_mode` –≤ `user_accounts`
   - –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `direction_adsets`

2. **API endpoints:**
   - `POST /api/directions/:directionId/link-adset` ‚Äî –ø—Ä–∏–≤—è–∑–∞—Ç—å ad set
   - `GET /api/directions/:directionId/adsets` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö ad sets
   - `DELETE /api/directions/:directionId/adsets/:adsetId` ‚Äî –æ—Ç–≤—è–∑–∞—Ç—å ad set
   - `POST /api/directions/:directionId/sync-adsets` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

3. **Helper —Ñ—É–Ω–∫—Ü–∏–∏:**
   - `getAdSetMode(userAccountId)` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `getAvailableLinkedAdSet(directionId)` ‚Äî –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–π ad set
   - `validateAndFetchAdSet(fbAdSetId, accessToken)` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Facebook API

---

### Phase 2: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è workflows (3-4 –¥–Ω—è)

1. **–û–±–Ω–æ–≤–∏—Ç—å `workflowCreateAdSetInDirection.ts`:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∂–∏–º–∞
   - –í–µ—Ç–≤–ª–µ–Ω–∏–µ: api_create vs use_existing
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–û–±–Ω–æ–≤–∏—Ç—å Auto-Launch V2:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `campaignBuilder.ts`

3. **–û–±–Ω–æ–≤–∏—Ç—å Manual Launch:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Auto-Launch

4. **–û–±–Ω–æ–≤–∏—Ç—å AgentBrain actions:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `UpdateAdSetDailyBudget` —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å `SYSTEM_PROMPT` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - Unit —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - Integration —Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ API

---

### Phase 3: Frontend UI (2-3 –¥–Ω—è)

1. **Settings:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –≤ Profile/Settings

2. **Directions Management:**
   - –°–µ–∫—Ü–∏—è "Linked Ad Sets" –≤ —Ñ–æ—Ä–º–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - Dialog –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ ad set
   - –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

3. **API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `services/directionsApi.ts`
   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã TypeScript

4. **UX:**
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º
   - Error handling

---

### Phase 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (2 –¥–Ω—è)

1. **E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å 2 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
   - –°–æ–∑–¥–∞—Ç—å ad sets –≤ Facebook –≤—Ä—É—á–Ω—É—é
   - –ü—Ä–∏–≤—è–∑–∞—Ç—å —á–µ—Ä–µ–∑ UI
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å Auto-Launch ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç pre-created ad sets
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ads —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - User guide: –∫–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å ad sets
   - Developer docs: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
   - –û–±–Ω–æ–≤–∏—Ç—å `PROJECT_OVERVIEW_RU.md`

3. **–î–µ–ø–ª–æ–π:**
   - Stage environment ‚Üí —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - Production deployment
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

---

## üíº –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–û–û–ë–†–ê–ñ–ï–ù–ò–Ø

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `default_adset_mode = 'api_create'`

---

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å `fb_adset_id` —á–µ—Ä–µ–∑ Facebook API –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ ad set –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—á–µ—Ä–µ–∑ `ad_account_id`)
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ ad set –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π campaign (`direction.fb_campaign_id`)

---

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `direction_adsets` –ø–æ `direction_id` –∏ `fb_adset_id`
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `getAvailableLinkedAdSet()` (Redis?)

---

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pre-created ad set (–≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ)
- –ö–æ–≥–¥–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ad sets (skip direction)
- –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `fb_adset_id`

---

## ü§ù –§–ò–ù–ê–õ–¨–ù–´–ô –í–û–ü–†–û–°

**–°–æ–≥–ª–∞—Å–µ–Ω –ª–∏ —Ç—ã —Å —ç—Ç–∏–º –ø–æ–¥—Ö–æ–¥–æ–º?**

–ï—Å–ª–∏ –¥–∞ ‚Äî –∫–∞–∫–∏–µ –µ—Å—Ç—å –∏–¥–µ–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã?

–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∫–∞–∫–æ–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å?

---

## üìû –ö–û–ù–¢–ê–ö–¢–´

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:

1. **–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏**
2. **–û—Ç–≤–µ—Ç—å –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã** (—Ä–∞–∑–¥–µ–ª "–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è")
3. **–ü—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** (–∏–ª–∏ —Å–æ–≥–ª–∞—Å–∏—Å—å —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º)
4. **–£–∫–∞–∂–∏ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**, –∫–æ—Ç–æ—Ä—ã–µ —è –º–æ–≥ —É–ø—É—Å—Ç–∏—Ç—å
5. **–û—Ü–µ–Ω–∏ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã** –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-06  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** Awaiting Feedback

üöÄ **–ì–æ—Ç–æ–≤ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã!**








