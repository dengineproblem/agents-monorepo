# OpenAI Retry –ú–µ—Ö–∞–Ω–∏–∑–º - –î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ

**–î–∞—Ç–∞:** 31 –æ–∫—Ç—è–±—Ä—è 2025, 07:55  
**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ò–Ω–æ–≥–¥–∞ OpenAI API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:
- **429** - Rate Limit (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤)
- **500/502/503** - Server Error (—Å–µ—Ä–≤–µ—Ä–∞ OpenAI –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã)

–†–∞–Ω—å—à–µ –ø—Ä–∏ —Ç–∞–∫–æ–π –æ—à–∏–±–∫–µ –≤–µ—Å—å –ø—Ä–æ–≥–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–ø–∞–¥–∞–ª** üí•:
- –û—Ç—á—ë—Ç –Ω–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è
- –î–µ–π—Å—Ç–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è **`responsesCreateWithRetry`** —Å —É–º–Ω–æ–π retry-–ª–æ–≥–∏–∫–æ–π:

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:

1. **–ü—ã—Ç–∞–µ—Ç—Å—è –¥–æ 3 —Ä–∞–∑** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `OPENAI_MAX_RETRIES`)
2. **Exponential backoff**: 2s ‚Üí 4s ‚Üí 8s –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
3. **–£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫**:
   - ‚úÖ **–†–µ—Ç—Ä–∞–∏—Ç:** 429, 500, 502, 503, network errors
   - ‚ùå **–ù–ï —Ä–µ—Ç—Ä–∞–∏—Ç:** 400, 401, 403, 404 (—ç—Ç–æ –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–æ—Å–∞, retry –Ω–µ –ø–æ–º–æ–∂–µ—Ç)

### –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:

```
–ü–æ–ø—ã—Ç–∫–∞ 1: ‚ùå 429 Too Many Requests
  ‚Üí –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã
  
–ü–æ–ø—ã—Ç–∫–∞ 2: ‚ùå 500 Internal Server Error
  ‚Üí –ñ–¥—ë–º 4 —Å–µ–∫—É–Ω–¥—ã
  
–ü–æ–ø—ã—Ç–∫–∞ 3: ‚úÖ 200 OK
  ‚Üí –£—Å–ø–µ—Ö!
```

---

## üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `responsesCreateWithRetry`
**–§–∞–π–ª:** `services/agent-brain/src/server.js:73-146`

```javascript
async function responsesCreateWithRetry(payload, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await responsesCreate(payload);
    } catch (error) {
      const status = error.status;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Ä–µ—Ç—Ä–∞–∏—Ç—å
      const shouldRetry = [429, 500, 502, 503].includes(status) || !status;
      
      if (!shouldRetry || attempt === maxRetries) {
        throw error; // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –∏–ª–∏ non-retryable –æ—à–∏–±–∫–∞
      }
      
      // Exponential backoff
      await sleep(Math.pow(2, attempt) * 1000);
    }
  }
}
```

### 2. –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã

**‚úÖ `llmPlan`** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π  
**‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã –≤ scoring agent** - –ø—Ä–µ–¥–∏–∫—à–µ–Ω —Ä–∏—Å–∫–æ–≤  
**‚ùå `/api/brain/llm-ping`** - –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ retry (—Ç–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
**–§–∞–π–ª:** `docker-compose.yml`
```yaml
- OPENAI_MAX_RETRIES=3
```

**–§–∞–π–ª:** `env.brain.example`
```bash
OPENAI_MAX_RETRIES=3
```

---

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å retry:

### –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º retry:
```json
{
  "where": "responsesCreateWithRetry",
  "attempt": 2,
  "status": "success_after_retry"
}
```

### –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ retry:
```json
{
  "where": "responsesCreateWithRetry",
  "attempt": 1,
  "maxRetries": 3,
  "httpStatus": 429,
  "nextAttemptIn": "2s",
  "error": "429 Too Many Requests..."
}
```

### –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å:
```json
{
  "where": "responsesCreateWithRetry",
  "attempts": 3,
  "status": "failed_all_retries",
  "httpStatus": 500,
  "error": "..."
}
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ:
```
OpenAI –≤–µ—Ä–Ω—É–ª 429
  ‚Üì
‚ùå –ü—Ä–æ–≥–æ–Ω —É–ø–∞–ª
‚ùå –û—Ç—á—ë—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –Ω–µ–¥–æ—É–º–µ–Ω–∏–∏
```

### –ü–æ—Å–ª–µ:
```
OpenAI –≤–µ—Ä–Ω—É–ª 429
  ‚Üì
‚è≥ –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã
  ‚Üì
OpenAI –≤–µ—Ä–Ω—É–ª 500
  ‚Üì
‚è≥ –ñ–¥—ë–º 4 —Å–µ–∫—É–Ω–¥—ã
  ‚Üì
OpenAI –≤–µ—Ä–Ω—É–ª 200 OK
  ‚Üì
‚úÖ –û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω
‚úÖ –î–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:

**–í `docker-compose.yml`:**
```yaml
- OPENAI_MAX_RETRIES=5  # –ë—ã–ª–æ: 3
```

**–ò–ª–∏ –≤ `.env.brain`:**
```bash
OPENAI_MAX_RETRIES=5
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É OpenAI** (–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å API key –Ω–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π)
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å batch**
3. **–°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å retry –ø–æ–ø—ã—Ç–∫–∏

```bash
docker-compose logs -f agent-brain | grep responsesCreateWithRetry
```

### –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (–±–µ–∑ –æ—à–∏–±–æ–∫):
- –õ–æ–≥–æ–≤ `responsesCreateWithRetry` **–Ω–µ –±—É–¥–µ—Ç** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
- –ò–ª–∏ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ `success_after_retry` –µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –Ω–æ –ø–æ—Ç–æ–º —É—Å–ø–µ—Ö

---

## üìà –ü–æ–ª—å–∑–∞

**–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å–±–æ—è–º OpenAI  
**–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** 95% –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Ä–µ—à–∞—é—Ç—Å—è retry  
**UX:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –æ—Ç—á—ë—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å OpenAI  
**–≠–∫–æ–Ω–æ–º–∏—è:** –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —É–ø–∞–≤—à–∏–µ –ø—Ä–æ–≥–æ–Ω—ã  

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
docker-compose build --no-cache agent-brain
docker-compose up -d agent-brain
```

Retry –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ! üöÄ

