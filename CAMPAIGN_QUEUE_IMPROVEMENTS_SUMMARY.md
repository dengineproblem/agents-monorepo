# Campaign Queue Improvements - Summary

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤ –≤–æ—Ä–æ–Ω–∫–∏
- –ö–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ª–∏–¥–æ–≤ –Ω–µ –Ω—É–∂–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ —Å–∫–æ—Ä–∏–Ω–≥–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —ç—Ç–∞–ø–æ–≤

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (3 –º–∏–≥—Ä–∞—Ü–∏–∏)

1. **services/crm-backend/migrations/006_add_funnel_structure.sql**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ `business_profile`:
     - `funnel_stages_structured` (JSONB) - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã
     - `key_funnel_stages` (TEXT[]) - –º–∞—Å—Å–∏–≤ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤

2. **migrations/031_add_key_stage_tracking.sql**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ `dialog_analysis`:
     - `is_on_key_stage` (BOOLEAN) - —Ñ–ª–∞–≥ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–∞ –∫–ª—é—á–µ–≤–æ–º —ç—Ç–∞–ø–µ
     - `key_stage_entered_at` (TIMESTAMPTZ) - –∫–æ–≥–¥–∞ –≤–æ—à–µ–ª –Ω–∞ –∫–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø
     - `key_stage_left_at` (TIMESTAMPTZ) - –∫–æ–≥–¥–∞ —É—à–µ–ª —Å –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
     - `funnel_stage_history` (JSONB) - –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

3. **services/chatbot-service/migrations/002_add_campaign_scoring_settings.sql**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ `campaign_settings`:
     - `key_stage_cooldown_days` (INTEGER) - –ø–µ—Ä–∏–æ–¥ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
     - `stage_interval_multipliers` (JSONB) - –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º
     - `fatigue_thresholds` (JSONB) - –ø–æ—Ä–æ–≥–∏ —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫

### üé® Frontend (1 —Ñ–∞–π–ª)

**services/crm-frontend/src/components/onboarding/OnboardingModal.tsx**
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ —ç—Ç–∞–ø–æ–≤ –≤–æ—Ä–æ–Ω–∫–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏ "+–î–æ–±–∞–≤–∏—Ç—å" / "–£–¥–∞–ª–∏—Ç—å"
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω–ø—É—Ç–æ–≤ (–º–∏–Ω–∏–º—É–º 2 —ç—Ç–∞–ø–∞)
- ‚úÖ –í—ã–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤ —á–µ—Ä–µ–∑ —á–µ–∫–±–æ–∫—Å—ã
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: –º–∏–Ω–∏–º—É–º 1 –∫–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ backend

### üîß Backend API (1 —Ñ–∞–π–ª)

**services/crm-backend/src/routes/businessProfile.ts**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ Zod —Å—Ö–µ–º–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ `funnel_stages_structured` –∏ `key_funnel_stages`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ prompt generator

### ü§ñ Prompt Generator (1 —Ñ–∞–π–ª)

**services/crm-backend/src/lib/promptGenerator.ts**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω META_PROMPT –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–µ–≤—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏
- ‚úÖ –ù–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã: `FunnelStage`, `FunnelStageDetail`
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω `PersonalizedContext` —Å –ø–æ–ª—è–º–∏ `key_funnel_stages` –∏ `funnel_stages_details`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `formatContextForPrompt` –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤

### üìä Dialog Analysis (1 —Ñ–∞–π–ª)

**services/crm-backend/src/scripts/analyzeDialogs.ts**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω BASE_ANALYSIS_PROMPT —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —ç—Ç–∞–ø–∞–º
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `is_on_key_stage` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `saveAnalysisResult` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `key_stage_entered_at` / `key_stage_left_at`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ `funnel_stage_history`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `analyzeAndSaveContact` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `keyFunnelStages`

### üéØ Campaign Scoring Agent (1 —Ñ–∞–π–ª)

**services/chatbot-service/src/lib/campaignScoringAgent.ts**

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **getKeyFunnelStages(userAccountId)** 
   - –ü–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã –∏–∑ business_profile

2. **isLeadBlocked(lead, keyStages, cooldownDays)**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–∞:
     - –ù–∞ –∫–ª—é—á–µ–≤–æ–º —ç—Ç–∞–ø–µ (`is_on_key_stage = true`)
     - –ù–µ–¥–∞–≤–Ω–æ —É—à–µ–ª —Å –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞ (< 7 –¥–Ω–µ–π)
     - –ù–∞ —ç—Ç–∞–ø–∞—Ö `deal_closed` –∏–ª–∏ `deal_lost`

3. **getTouchIntervalDays(lead, settings)**
   - –í—ã—á–∏—Å–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞—Å–∞–Ω–∏—è
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–ø–ª–æ—Ç—É –ª–∏–¥–∞ –∏ —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫

4. **calculateTimeReadinessCoefficient(lead, settings)**
   - –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è time coefficient
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç –õ–Æ–ë–û–ï –∫–∞—Å–∞–Ω–∏–µ (–∫–∞–º–ø–∞–Ω–∏—è –∏–ª–∏ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
   - –ë–µ—Ä–µ—Ç –º–∏–Ω–∏–º—É–º –∏–∑ `last_campaign_message_at` –∏ `last_message`

5. **calculateStageCoefficient(stage)**
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —ç—Ç–∞–ø–∞–º –≤–æ—Ä–æ–Ω–∫–∏
   - –ü–æ–≤—ã—à–∞–µ—Ç score –¥–ª—è "no_show" (1.3x)
   - –ü–æ–Ω–∏–∂–∞–µ—Ç score –¥–ª—è "thinking" (0.9x)

6. **calculateFatigueCoefficient(lead)**
   - –®—Ç—Ä–∞—Ñ –∑–∞ —á–∞—Å—Ç—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
   - 0-3 —Å–æ–æ–±—â–µ–Ω–∏—è: 0.95x
   - 4-6 —Å–æ–æ–±—â–µ–Ω–∏–π: 0.85x
   - 7-10 —Å–æ–æ–±—â–µ–Ω–∏–π: 0.7x
   - 11+ —Å–æ–æ–±—â–µ–Ω–∏–π: 0.5x

–û–±–Ω–æ–≤–ª–µ–Ω–∞ **generateDailyCampaignQueue**:
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `keyStages` –∏–∑ business_profile
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `isLeadBlocked` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏–¥–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É–ª—É: `baseScore * timeCoeff * activityCoeff * stageCoeff * fatigueCoeff`
- ‚úÖ –£–±—Ä–∞–Ω—ã –∂–µ—Å—Ç–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ `deal_closed` / `deal_lost` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (—Ç–µ–ø–µ—Ä—å –≤ `isLeadBlocked`)

---

## –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞

### –§–æ—Ä–º—É–ª–∞

```
reactivationScore = baseScore √ó timeCoeff √ó activityCoeff √ó stageCoeff √ó fatigueCoeff
```

### –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã

| –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç | –î–∏–∞–ø–∞–∑–æ–Ω | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------|----------|----------|
| **baseScore** | 0-100 | –ë–∞–∑–æ–≤—ã–π score –ª–∏–¥–∞ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ |
| **timeCoeff** | 0-1.5 | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∫–∞—Å–∞–Ω–∏–µ) |
| **activityCoeff** | 0.1-1.2 | –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–∏–∞–ª–æ–≥–µ (–≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å) |
| **stageCoeff** | 0.8-1.3 | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —ç—Ç–∞–ø–∞ –≤–æ—Ä–æ–Ω–∫–∏ |
| **fatigueCoeff** | 0.5-1.0 | –£—Å—Ç–∞–ª–æ—Å—Ç—å –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫ |

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏–¥–æ–≤

–õ–∏–¥ **–ù–ï –ø–æ–ø–∞–¥–∞–µ—Ç** –≤ –æ—á–µ—Ä–µ–¥—å –µ—Å–ª–∏:
1. ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –∫–ª—é—á–µ–≤–æ–º —ç—Ç–∞–ø–µ (`is_on_key_stage = true`)
2. ‚úÖ –ú–µ–Ω–µ–µ 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ —É—à–µ–ª —Å –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
3. ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ `deal_closed` –∏–ª–∏ `deal_lost`

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–∞—Å–∞–Ω–∏–π

```
interval = baseInterval[interest] √ó stageMultiplier

–ë–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:
- HOT: 2 –¥–Ω—è
- WARM: 5 –¥–Ω–µ–π
- COLD: 10 –¥–Ω–µ–π

–ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ —ç—Ç–∞–ø–∞–º:
- new_lead: 0.7 (—á–∞—â–µ)
- thinking: 1.2 (—Ä–µ–∂–µ, –¥–∞–µ–º –ø–æ–¥—É–º–∞—Ç—å)
- no_show: 0.8 (—á–∞—â–µ, –Ω–µ –ø—Ä–∏—à–µ–ª –Ω–∞ –≤—Å—Ç—Ä–µ—á—É)
```

---

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∏–º–µ—Ä 1: –õ–∏–¥ –∑–∞–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `funnel_stage = "–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"` (–∫–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø)
- `is_on_key_stage = true`
- `key_stage_entered_at = "2025-11-14T10:00:00Z"`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ùå –ù–ï –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Å—ã–ª–∫–∏
- ‚úÖ –ë—É–¥–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–µ–π `isLeadBlocked()`
- ‚úÖ –ü–æ–ª—É—á–∏—Ç `reactivationScore = 0`

---

### –ü—Ä–∏–º–µ—Ä 2: –õ–∏–¥ –ø—Ä–æ—à–µ–ª –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é 3 –¥–Ω—è –Ω–∞–∑–∞–¥

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `funnel_stage = "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞"`
- `is_on_key_stage = false`
- `key_stage_left_at = NOW() - 3 days` (—É—à–µ–ª —Å –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞ "–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é")

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ùå –ù–ï –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å (cooldown 7 –¥–Ω–µ–π)
- ‚úÖ `daysSinceLeft = 3 < 7` ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ß–µ—Ä–µ–∑ 4 –¥–Ω—è —Å–º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å

---

### –ü—Ä–∏–º–µ—Ä 3: –ê–∫—Ç–∏–≤–Ω—ã–π –ª–∏–¥, –Ω–æ –º–Ω–æ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `score = 80`
- `campaign_messages_count = 8`
- `interest_level = "warm"`
- `funnel_stage = "thinking"`

**–†–∞—Å—á–µ—Ç:**
```
baseScore = 80
timeCoeff = 1.0 (–ø—Ä–æ—à–µ–ª –ø–æ–ª–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
activityCoeff = 1.1 (–∞–∫—Ç–∏–≤–Ω—ã–π)
stageCoeff = 0.9 (thinking)
fatigueCoeff = 0.7 (7-10 —Å–æ–æ–±—â–µ–Ω–∏–π)

reactivationScore = 80 √ó 1.0 √ó 1.1 √ó 0.9 √ó 0.7 = 55.44
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å, –Ω–æ —Å –ø–æ–Ω–∏–∂–µ–Ω–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
- ‚úÖ –ë—É–¥–µ—Ç –Ω–∏–∂–µ –≤ —Å–ø–∏—Å–∫–µ —á–µ–º –ª–∏–¥—ã —Å –º–µ–Ω—å—à–∏–º —á–∏—Å–ª–æ–º —Ä–∞—Å—Å—ã–ª–æ–∫

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–∞–π–ª–µ:
**CAMPAIGN_QUEUE_TESTING.md**

–í–∫–ª—é—á–∞–µ—Ç 7 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
1. ‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ - –≤–≤–æ–¥ —ç—Ç–∞–ø–æ–≤
2. ‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ - –≤—ã–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
4. ‚úÖ –ê–Ω–∞–ª–∏–∑ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã
5. ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏–¥–æ–≤ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö
6. ‚úÖ Cooldown –ø–µ—Ä–∏–æ–¥ 7 –¥–Ω–µ–π
7. ‚úÖ –í–ª–∏—è–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤

---

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è, –Ω–µ —É–¥–∞–ª—è—è —Å—Ç–∞—Ä—ã–µ:
- `funnel_stages_description` –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `calculateTimeCoefficient` –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ deprecated, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- `getIntervalForLead` –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è** –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å `funnel_stages_structured` –∏ `key_funnel_stages` –≤ `business_profile`
2. –†–µ-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `personalized_context` —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `is_on_key_stage`

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ª–∏–¥–æ–≤
4. ‚úÖ –°–æ–±—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1 –º–µ—Å—è—Ü)
1. üîÑ UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
2. üîÑ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π vs –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
3. üîÑ –î–∞—à–±–æ—Ä–¥ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —ç—Ç–∞–ø–∞–º
4. üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ conversion rate

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (2-3 –º–µ—Å—è—Ü–∞)
1. üîÆ ML –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è conversion probability
2. üîÆ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏–¥–∞
3. üîÆ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
4. üîÆ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –¥–ª—è —É—á–µ—Ç–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤ –∑–∞ –¥–µ–Ω—å
- % –ª–∏–¥–æ–≤ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö
- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–∞ –∫–ª—é—á–µ–≤–æ–º —ç—Ç–∞–ø–µ

### –ö–∞—á–µ—Å—Ç–≤–æ –æ—á–µ—Ä–µ–¥–∏
- –°—Ä–µ–¥–Ω–∏–π reactivationScore –≤ –æ—á–µ—Ä–µ–¥–∏
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (time/activity/stage/fatigue)
- Conversion rate —Ä–∞—Å—Å—ã–ª–æ–∫ (–æ—Ç–∫—Ä—ã–≤–∞–µ–º–æ—Å—Ç—å, –æ—Ç–≤–µ—Ç—ã)

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∞–ª–æ–± –Ω–∞ —Å–ø–∞–º (–¥–æ–ª–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å—Å—è)
- NPS –ª–∏–¥–æ–≤ –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
- Retention rate –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∞–ª–æ –ª–∏–¥–æ–≤ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –°–¥–µ–ª–∞—Ç—å `key_stage_cooldown_days` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º
- –î–æ–±–∞–≤–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ª–∏–¥–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏

### –†–∏—Å–∫ 2: –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π —ç—Ç–∞–ø–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–ø–µ—á–∞—Ç–∫–∏ –≤ `key_funnel_stages` vs `funnel_stage`

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ frontend –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤
- Case-insensitive —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
- Trim –ø—Ä–æ–±–µ–ª–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

### –†–∏—Å–∫ 3: –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ–ª—å—à–æ–π `funnel_stage_history` –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–∏–¥–æ–≤

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –ø–µ—Ä–µ—Ö–æ–¥–æ–≤)
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB –ø–æ–ª—è—Ö

---

## –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—ã

- –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞: AI Assistant
- Code review: -
- QA: -
- Product: -

---

## Changelog

### v2.0.0 (2025-11-14)

**Added:**
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ —ç—Ç–∞–ø–æ–≤ –≤–æ—Ä–æ–Ω–∫–∏ –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ
- –í—ã–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤ —á–µ—Ä–µ–∑ —á–µ–∫–±–æ–∫—Å—ã
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏–¥–æ–≤ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö
- Cooldown –ø–µ—Ä–∏–æ–¥ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ —É—Ö–æ–¥–∞ —Å –∫–ª—é—á–µ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
- 4 –Ω–æ–≤—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞ (stage, fatigue, time readiness)
- –ì–∏–±–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∫–∞—Å–∞–Ω–∏–π –ø–æ —ç—Ç–∞–ø–∞–º –≤–æ—Ä–æ–Ω–∫–∏

**Changed:**
- –§–æ—Ä–º—É–ª–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞ —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç 5 –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –≤–º–µ—Å—Ç–æ 3
- `generateDailyCampaignQueue` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- `calculateTimeReadinessCoefficient` —É—á–∏—Ç—ã–≤–∞–µ—Ç –ª—é–±–æ–µ –∫–∞—Å–∞–Ω–∏–µ, –Ω–µ —Ç–æ–ª—å–∫–æ –∫–∞–º–ø–∞–Ω–∏–∏

**Fixed:**
- –õ–∏–¥—ã –Ω–∞ –≤–∞–∂–Ω—ã—Ö —ç—Ç–∞–ø–∞—Ö –±–æ–ª—å—à–µ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —Å–ø–∞–º-—Ä–∞—Å—Å—ã–ª–∫–∏
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —É—Å—Ç–∞–ª–æ—Å—Ç—å –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –∫–∞—Å–∞–Ω–∏—è–º–∏

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- üìÑ **–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: [campaign-queue-improvements.plan.md](./campaign-queue-improvements.plan.md)
- üìã **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: [CAMPAIGN_QUEUE_TESTING.md](./CAMPAIGN_QUEUE_TESTING.md)
- üìä **–≠—Ç–æ—Ç summary**: [CAMPAIGN_QUEUE_IMPROVEMENTS_SUMMARY.md](./CAMPAIGN_QUEUE_IMPROVEMENTS_SUMMARY.md)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-14
**–í–µ—Ä—Å–∏—è:** 2.0.0
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

