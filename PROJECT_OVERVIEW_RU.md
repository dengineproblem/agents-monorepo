## –ê–≥–µ–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ä–µ–∫–ª–∞–º–æ–π ‚Äî –æ–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (RU)

–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥—Ä—É–≥–æ–º—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é: –≥–¥–µ —á—Ç–æ –ª–µ–∂–∏—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∫–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–∏—Å–ø—Ä–∞–≤–∏—Ç—å.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–Ω–æ—Ä–µ–ø–æ
- –î–≤–∞ —Å–µ—Ä–≤–∏—Å–∞:
  - services/agent-brain ‚Äî ¬´–º–æ–∑–≥¬ª (Node.js, Fastify, JS). –§–∞–π–ª –≤—Ö–æ–¥–∞: src/server.js
    - Scoring Agent (src/scoring.js) ‚Äî –ø—Ä–µ–¥–∏–∫—à–µ–Ω –∏ –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ —Ä–æ—Å—Ç–∞ CPL
  - services/agent-service ‚Äî ¬´–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª (TypeScript, Fastify). –†–∞–±–æ—Ç–∞–µ—Ç —Å Facebook Graph API –∏ –æ—Ä–∫–µ—Å—Ç—Ä—É–µ—Ç workflow'—ã
- docker-compose.yml –ø–æ–¥–Ω–∏–º–∞–µ—Ç –æ–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ

### Agent Brain (services/agent-brain)
- –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - GET /api/brain/llm-ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ LLM
  - POST /api/brain/run ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞/–ø–ª–∞–Ω–∞ (inputs.dispatch=false –¥–ª—è dry-–∑–∞–ø—É—Å–∫–∞)
  - POST /api/brain/cron/run-batch ‚Äî —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏/–ª–æ–≥–∏–∫–∞ –≤ src/server.js:
  - Cron-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤ 08:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (Asia/Almaty)
    - –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Supabase (WHERE active = true)
    - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ (–Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
    - –î–ª—è –∫–∞–∂–¥–æ–≥–æ: —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –≤ Telegram
    - –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: —É—Å–ø–µ—à–Ω–æ/–Ω–µ—É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  - –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö: Supabase (—É—á—ë—Ç–∫–∞, —Ç–æ–∫–µ–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏), Facebook Graph Insights (adset/ad/campaign; –≤—á–µ—Ä–∞/—Å–µ–≥–æ–¥–Ω—è/3/7/30 –¥–Ω–µ–π)
  - **–î–∞–Ω–Ω—ã–µ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º (ads)**: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ ad set –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è ads (–≤—á–µ—Ä–∞) —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
    - ad_id, ad_name, spend, impressions, actions
    - –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–µ–π –±—é–¥–∂–µ—Ç–∞"
  - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Health Score (HS) –Ω–∞ —É—Ä–æ–≤–Ω–µ ad set (–æ—Ç -100 –¥–æ +100), –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ CPL/QCPL, —Ç—Ä–µ–Ω–¥—ã, CTR/CPM/Frequency, —Å—Ç–∞–¥–∏—è –æ–±—É—á–µ–Ω–∏—è, –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è ¬´—Å–µ–≥–æ–¥–Ω—è¬ª
  - **–õ–æ–≥–∏–∫–∞ "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–µ–π –±—é–¥–∂–µ—Ç–∞"**: –µ—Å–ª–∏ –≤ ad set ‚â•2 –æ–±—ä—è–≤–ª–µ–Ω–∏–π:
    - –ù–∞—Ö–æ–¥–∏—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏ (‚â•50% –æ—Ç total spend)
    - –ï—Å–ª–∏ –µ–≥–æ CPL/QCPL > target √ó 1.3 ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PauseAd action
    - LLM –ø—Ä–∏–º–µ–Ω—è–µ—Ç —ç—Ç—É –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è ad set —Å –∫–ª–∞—Å—Å–∞–º–∏ neutral/slightly_bad/bad
  - LLM ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π ¬´decision maker¬ª: —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç planNote, actions, reportText –ø–æ —Å—Ç—Ä–æ–≥–æ–º—É —à–∞–±–ª–æ–Ω—É (JSON). –ú–æ–¥–µ–ª—å: gpt-5
  - –§–æ–ª–±—ç–∫: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞, –µ—Å–ª–∏ LLM —É–ø–∞–ª –∏–ª–∏ USE_LLM=false
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∑–∞ –ø—Ä–æ–≥–æ–Ω: BRAIN_MAX_ACTIONS_PER_RUN
  - **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ –≤ Telegram**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç telegram_id –∏ telegram_bot_token –∏–∑ user_accounts
    - –§–æ—Ä–º–∞—Ç: Markdown, –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫ –±–µ–∑ –∞–Ω–≥–ª–∏—Ü–∏–∑–º–æ–≤
  - SYSTEM_PROMPT —Ä–∞—Å—à–∏—Ä–µ–Ω —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π v1.2+, –≤–∫–ª—é—á–∞—è:
    - –ü—Ä–∞–≤–∏–ª–∞ –±—é–¥–∂–µ—Ç–æ–≤, HS, –º–∞—Ç—Ä–∏—Ü—É –¥–µ–π—Å—Ç–≤–∏–π
    - –°—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –ø–æ ads –∏ –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–µ–π"
    - –¢—Ä–∏–≥–≥–µ—Ä—ã ¬´–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å LAL3 IG Engagers 365d¬ª
    - –®–∞–±–ª–æ–Ω –æ—Ç—á—ë—Ç–∞, self-check
    - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±—é–¥–∂–µ—Ç—ã –∏–∑ Supabase (plan_daily_budget_cents, default_cpl_target_cents)
  - LLM-–≤—ã–∑–æ–≤—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ –ø—Ä—è–º–æ–π OpenAI Responses API (–≤ –æ–±—Ö–æ–¥ SDK), –±–µ–∑ max_tokens/max_output_tokens

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω—ã–µ):
- BRAIN_MODEL=gpt-5
- BRAIN_DRY_RUN, BRAIN_DEBUG_LLM, BRAIN_MAX_ACTIONS_PER_RUN, BRAIN_TEST_MODE
- AGENT_SERVICE_URL
- SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, OPENAI_API_KEY
- **CRON_ENABLED=true** ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å cron (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω)
- **CRON_SCHEDULE="0 8 * * *"** ‚Äî —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 08:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)
- **SCORING_ENABLED=true** ‚Äî –≤–∫–ª—é—á–∏—Ç—å scoring agent
- **SCORING_MIN_IMPRESSIONS=1000** ‚Äî –º–∏–Ω–∏–º—É–º –ø–æ–∫–∞–∑–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **SCORING_PREDICTION_DAYS=3** ‚Äî –Ω–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–∏–∫—à–Ω
- **SCORING_MODEL=gpt-5** ‚Äî –º–æ–¥–µ–ª—å LLM –¥–ª—è scoring

### üÜï Scoring Agent (services/agent-brain/src/scoring.js) ‚Äî 2025-10-04

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ —Ä–æ—Å—Ç–∞ CPL –∏ –ø—Ä–µ–¥–∏–∫—à–µ–Ω–∞ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ü–ï–†–ï–î –æ—Å–Ω–æ–≤–Ω—ã–º brain agent (–ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º –≤ `/api/brain/run`)
2. –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ Facebook API:
   - Insights –∑–∞ 3d –∏ 7d (CPM, CTR, Frequency)
   - Diagnostics rankings (quality, engagement, conversion) –Ω–∞ —É—Ä–æ–≤–Ω–µ ad
   - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—é–¥–∂–µ—Ç–æ–≤ (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è budget jump)
3. –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∏—Å–∫-—Å–∫–æ—Ä (0-100) –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
   ```
   risk = 30√ó(CPM3/CPM7-1) + 25√ó(1-CTR3/CTR7) + 20√ó(FREQ-1.9)/0.8 + 
          15√óI[budget_jump] + 10√óI[rank_drop]
   ```
4. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç risk level: Low (0-19), Medium (20-39), High (40+)
5. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM –¥–ª—è:
   - –ê–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ (improving/stable/declining)
   - –ü—Ä–µ–¥–∏–∫—à–µ–Ω–∞ CPL –Ω–∞ 3 –¥–Ω—è
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
   - –û—Ü–µ–Ω–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –∏–∑ `user_creatives`
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `scoring_output`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `llmInput` –¥–ª—è main brain

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "summary": {
    "high_risk_count": 2,
    "medium_risk_count": 3,
    "low_risk_count": 5,
    "overall_trend": "declining",
    "alert_level": "warning"
  },
  "items": [
    {
      "level": "campaign|adset|ad",
      "id": "...",
      "name": "...",
      "risk_score": 52,
      "risk_level": "High",
      "trend": "declining",
      "prediction": {
        "days": 3,
        "cpl_current": 2.10,
        "cpl_predicted": 2.85,
        "change_pct": 35.7
      },
      "recommendations": ["–°–Ω–∏–∑–∏—Ç—å –±—é–¥–∂–µ—Ç", "–†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã"]
    }
  ],
  "active_creatives_ready": [
    {
      "user_creative_id": "uuid",
      "name": "–û—Å–µ–Ω–Ω—è—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞",
      "risk_score": 12,
      "suitable_for": ["whatsapp", "site_leads"]
    }
  ],
  "recommendations_for_brain": [
    "–°–†–û–ß–ù–û: –∫–∞–º–ø–∞–Ω–∏—è X –≤ High risk ‚Äî —Å–Ω–∏–∑–∏—Ç—å –±—é–¥–∂–µ—Ç",
    "–í–∫–ª—é—á–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã Y –∏ Z"
  ]
}
```

**–¢–∞–±–ª–∏—Ü—ã Supabase (–Ω–æ–≤—ã–µ):**
- `creative_metrics_history` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ –ø–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º/–æ–±—ä—è–≤–ª–µ–Ω–∏—è–º
- `budget_audit` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—é–¥–∂–µ—Ç–æ–≤ (–¥–ª—è BUDGET_JUMP)
- `risk_scoring_config` ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –ø–æ—Ä–æ–≥–∏ (global/user/campaign)
- `scoring_executions` ‚Äî –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–æ–≤ scoring agent
- `creative_scores` ‚Äî —Ç–µ–∫—É—â–∏–µ —Å–∫–æ—Ä—ã –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ defaults –≤ `risk_scoring_config` (scope='global')
- Per-user overrides (scope='user')
- Per-campaign overrides (scope='campaign')
- –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: global ‚Üí user ‚Üí campaign

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å main brain:**
- Main brain –ø–æ–ª—É—á–∞–µ—Ç `scoring_output` –≤ `llmInput.scoring`
- SYSTEM_PROMPT –æ–±–Ω–æ–≤–ª–µ–Ω —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é scoring –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –µ—Å–ª–∏ scoring –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç High risk ‚Üí –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–∞–∂–µ –ø—Ä–∏ neutral HS
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã: scoring –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω: [SCORING_AGENT_PLAN.md](./SCORING_AGENT_PLAN.md)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: [SCORING_SETUP.md](./SCORING_SETUP.md)
- SQL –º–∏–≥—Ä–∞—Ü–∏–∏: [migrations/001_scoring_agent_tables.sql](./migrations/001_scoring_agent_tables.sql)

### Agent Service (services/agent-service)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –±–∞—Ç—á–∏ –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç Brain: src/routes/actions.ts
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π:
  - GetCampaignStatus, PauseCampaign, UpdateAdSetDailyBudget, PauseAd
  - Workflow.DuplicateAndPauseOriginal, Workflow.DuplicateKeepOriginalActive
  - Audience.DuplicateAdSetWithAudience (–¥—É–±–ª–∏–∫–∞—Ç ad set —Å –∑–∞–º–µ–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏)
- –ê–¥–∞–ø—Ç–µ—Ä Facebook (src/adapters/facebook.ts): FB_API_VERSION=v20.0; –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ execution_options=["validate_only"] –ø—Ä–∏ FB_VALIDATE_ONLY=true
- Workflow –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (src/workflows/campaignDuplicate.ts):
  - –£—á–∏—Ç—ã–≤–∞–µ—Ç validate_only (–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö id –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–º–ø–∞–Ω–∏–∏)
  - –ö–æ–ø–∏—Ä—É–µ—Ç promoted_object, targeting (–≤ —Ç.—á. geo_locations), —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Advantage+
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Audience.DuplicateAdSetWithAudience

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω—ã–µ):
- AGENT_DRY_RUN, FB_VALIDATE_ONLY, FB_API_VERSION, SUPABASE_URL/KEY

### Supabase (—Å—Ö–µ–º–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ)
- user_accounts: access_token, ad_account_id, page_id, instagram_id, —Ç–µ–ª–µ–≥—Ä–∞–º –ø–æ–ª—è, –ø–ª–∞–Ω–æ–≤—ã–µ –±—é–¥–∂–µ—Ç—ã/–ª–∏–º–∏—Ç—ã
- account_directions: per-direction –±—é–¥–∂–µ—Ç—ã/—Ü–µ–ª–µ–≤—ã–µ CPL
- asset_directions: —Å–≤—è–∑–∏ –∫–∞–º–ø–∞–Ω–∏–π/ad set —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏

### –ö–ª—é—á–µ–≤–∞—è –ø—Ä–µ–¥–º–µ—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
- –°—Ç—Ä–æ–≥–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ HS –∏ CPL/QCPL
- –ñ—ë—Å—Ç–∫–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –∫–≤–æ—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (LAL 3% –æ—Ç IG Engagers 365d):
  - –¢—Ä–∏–≥–≥–µ—Ä—ã: CPL_ratio ‚â• 2.0, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –ø–æ–∫–∞–∑—ã, HS –≤ [neutral|slightly_bad|bad]
  - –ë—é–¥–∂–µ—Ç –¥—É–±–ª—è: min(original_daily_budget, $10), –Ω–æ –Ω–µ –Ω–∏–∂–µ $3
  - Advantage+ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è; –∏–º—è –¥—É–±–ª—è: <AS_NAME> ‚Äî DUP LAL3 IG365 ‚Äî <DATE>
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –Ω–µ –±–æ–ª–µ–µ 1 –¥—É–±–ª—è –Ω–∞ ad set –≤ –¥–µ–Ω—å –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
  - –í–∞—Ä–∏–∞–Ω—Ç—ã: —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏–ª–∏ –±–µ–∑ ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç HS/–∏—Å—Ç–æ—Ä–∏–∏

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1) Facebook: execution_options –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–µ—Ä–µ–¥–∞—ë–º ["validate_only"]
2) PauseAd: –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ad_id vs adId
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ä–æ—É—Ç–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞, –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç status='PAUSED'
3) validate_only –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–π: –Ω–µ—Ç id –Ω–∞ create
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: workflow –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π id –ø—Ä–∏ validate_only
4) –ü–ª–∞–Ω –º–æ–≥ –±—ã—Ç—å undefined –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –≤—Å–µ–≥–¥–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç plan
5) –¢–µ–ª–µ–≥—Ä–∞–º: —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ/–º–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–æ–≤, –Ω–µ–≤–µ—Ä–Ω—ã–π account_id
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä finalizeReportText; –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø—Ä–æ—à–ª—ã–µ –æ—Ç—á—ë—Ç—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
6) LLM –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã/429/–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å SDK —Å gpt-5
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–º–µ–Ω–∞ –∫–ª—é—á–∞; –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Responses API (–ø—Ä—è–º–æ–π fetch), –±–µ–∑ max_tokens

### ‚úÖ –†–µ—à–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å LLM (2025-09-30)

**–°–∏–º–ø—Ç–æ–º—ã:** 
- GET /api/brain/llm-ping –≤–æ–∑–≤—Ä–∞—â–∞–ª 400/500 —Å –æ—à–∏–±–∫–∞–º–∏:
  - ¬´Unsupported parameter: 'max_tokens'‚Ä¶¬ª
  - ¬´Invalid value: 'text'. Supported values are: 'input_text'...¬ª
- –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç LLM (raw:"")

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞**
   - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ –æ–±—Ä–∞–∑
   - –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ SDK, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–ª max_tokens

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Responses API**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `type: 'text'` –≤–º–µ—Å—Ç–æ `type: 'input_text'`
   - Responses API —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞**
   - –ü—ã—Ç–∞–ª–∏—Å—å –ø–æ–ª—É—á–∏—Ç—å `resp.output_text` (–ø–æ–ª–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: `output[type='message'].content[type='output_text'].text`

**–†–µ—à–µ–Ω–∏–µ:**

```javascript
// 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞
input: [
  { role: 'system', content: [ { type: 'input_text', text: '...' } ] },
  { role: 'user', content: [ { type: 'input_text', text: '...' } ] }
]

// 2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
const message = resp.output.find(o => o.type === 'message');
const textContent = message.content.find(c => c.type === 'output_text');
const text = textContent?.text || '';
```

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose build --no-cache agent-brain && docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
curl localhost:7080/api/brain/llm-ping
# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"ok":true,"model":"gpt-5","raw":"ok"}
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–µ—Ä–Ω–µ—Ç—Å—è):**
```bash
lsof -n -P -i :7080  # –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç
docker logs agents-monorepo-agent-brain-1 --tail 50  # –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
docker-compose build --no-cache agent-brain && docker-compose up -d  # –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
```

### –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
```
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–Ω—è—Ç–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 7080
lsof -n -P -i :7080

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ brain –Ω–∞ 7091
cd services/agent-brain
BRAIN_PORT=7091 BRAIN_MODEL=gpt-5 OPENAI_API_KEY=... node src/server.js

# –ü–∏–Ω–≥
curl -sS localhost:7091/api/brain/llm-ping

# –ü—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–æ–Ω –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π
curl -sS -X POST localhost:7091/api/brain/run \
  -H 'content-type: application/json' \
  -d '{"userAccountId":"<UUID>","inputs":{"dispatch":false}}'
```

### üÜï Cron-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (2025-10-01)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫:**
- Cron –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 (Asia/Almaty)
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `active = true` –∏–∑ Supabase `user_accounts`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ:
  1. –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
  2. –ó–∞–ø—É—Å–∫–∞–µ—Ç Brain –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
  3. –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ agent-service
  4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –≤ Telegram

**–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```bash
curl -X POST localhost:7080/api/brain/cron/run-batch
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:**
```bash
# –í docker-compose.yml –∏–ª–∏ .env
CRON_ENABLED=true                # –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å
CRON_SCHEDULE="0 8 * * *"        # –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (cron syntax)
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ user_accounts –≤ Supabase:**
- `active = true` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
- `telegram_id` –∏ `telegram_bot_token` ‚Äî –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
- `plan_daily_budget_cents` –∏ `default_cpl_target_cents` ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–∞—Ä–≥–µ—Ç—ã

### üÜï –î–∞–Ω–Ω—ã–µ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º –∏ "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–∏ –±—é–¥–∂–µ—Ç–∞" (2025-10-01)

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- LLM —Ç–µ–ø–µ—Ä—å –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä—è–≤–ª–µ–Ω–∏—é (ads) –≤–Ω—É—Ç—Ä–∏ ad set
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–µ–π –±—é–¥–∂–µ—Ç–∞":
  - –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ç–∏—Ç ‚â•50% –±—é–¥–∂–µ—Ç–∞ ad set
  - –ò–º–µ–µ—Ç CPL/QCPL –≤—ã—à–µ —Ü–µ–ª–µ–≤–æ–≥–æ √ó 1.3
  - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç action `PauseAd` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ads –≤ llmInput:**
```json
{
  "adsets": [{
    "adset_id": "...",
    "name": "...",
    "ads": [
      {
        "ad_id": "...",
        "ad_name": "...",
        "spend": 12.50,
        "impressions": 1000,
        "actions": [...]
      }
    ]
  }]
}
```

### üÜï –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (2025-10-01)

**–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç:**

1. **Audience.DuplicateAdSetWithAudience** ‚Äî –¥—É–±–ª—å ad set —Å –Ω–æ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–º–µ–Ω—ã –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ LAL 3% IG Engagers 365d
   - –¢—Ä–∏–≥–≥–µ—Ä—ã: CPL_ratio ‚â• 2.0, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –ø–æ–∫–∞–∑—ã, HS –≤ [neutral|slightly_bad|bad]
   - –ë—é–¥–∂–µ—Ç –¥—É–±–ª—è: min(original_budget, $10), –Ω–æ –Ω–µ –Ω–∏–∂–µ $3
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç Advantage+ –∏ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

2. **Workflow.DuplicateAndPauseOriginal** ‚Äî –¥—É–±–ª—å –∫–∞–º–ø–∞–Ω–∏–∏ + –ø–∞—É–∑–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
   - –î–ª—è "—Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏" –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

3. **Workflow.DuplicateKeepOriginalActive** ‚Äî –¥—É–±–ª—å –∫–∞–º–ø–∞–Ω–∏–∏, –æ—Ä–∏–≥–∏–Ω–∞–ª –∞–∫—Ç–∏–≤–µ–Ω
   - –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –í—Å–µ actions –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –≤ agent-service —á–µ—Ä–µ–∑ zod schemas
- –í —Ä–µ–∂–∏–º–µ `FB_VALIDATE_ONLY=true` Facebook API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –í —Ä–µ–∂–∏–º–µ `BRAIN_TEST_MODE=true` –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º –ø—Ä–æ–º—Ç–æ–º

### –ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –ø—Ä–∏ –¥–µ–ø–ª–æ–µ/—Ç–µ—Å—Ç–∞—Ö
- **Cron –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 08:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- **–î–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è cron**: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `CRON_ENABLED=false`
- **–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ batch**: `POST /api/brain/cron/run-batch`
- –í–∞–ª–∏–¥–∞—Ü–∏—è FB: –≤–∫–ª—é—á–∞–π—Ç–µ `FB_VALIDATE_ONLY=true` –¥–æ ¬´–±–æ–µ–≤–æ–≥–æ¬ª –∑–∞–ø—É—Å–∫–∞; –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤-—Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –ø—Ä–æ–¥ `.env.agent` —Å—Ç–æ–∏—Ç `FB_VALIDATE_ONLY=false`
- –î–ª—è —Ä–µ–ø–æ—Ä—Ç–∞ –≤ Telegram –Ω—É–∂–Ω—ã telegram_bot_token/telegram_id –≤ user_accounts
- –û—Ç—á—ë—Ç ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∫–∞–º–ø–∞–Ω–∏—è–º —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å, –æ–¥–∏–Ω –±–ª–æ–∫
- **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `active = true` –≤ Supabase user_accounts
- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∏ –ø–∞—É–∑–∏—Ç —Ç–æ–ª—å–∫–æ ad set'—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π.
- –ö—Ä–µ–∞—Ç–∏–≤-—Ç–µ—Å—Ç—ã: `/api/creative-test/start` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `force: true`, –∞ `DELETE /api/creative-test/:id?user_id` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–µ—Å—Ç.

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞ cron (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫):**
```bash
curl -X POST localhost:7080/api/brain/cron/run-batch
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```bash
curl -X POST localhost:7080/api/brain/run \
  -H 'Content-Type: application/json' \
  -d '{"userAccountId":"<UUID>","inputs":{"dispatch":false}}'
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ ads:**
```bash
curl -X POST localhost:7080/api/brain/run \
  -H 'Content-Type: application/json' \
  -d '{"userAccountId":"<UUID>","inputs":{"dispatch":false}}' \
  | jq '.llm.input.analysis.adsets[0].ads'
```

**–õ–æ–≥–∏ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```bash
docker logs agents-monorepo-agent-brain-1 --tail 100 | grep -i "batch\|processUser"
```

### üÜï Scoring Agent (–∞–≥–µ–Ω—Ç –ø—Ä–µ–¥–∏–∫—à–µ–Ω–∞) ‚Äî 2025-10-04

**–§–∞–π–ª**: `services/agent-brain/src/scoring.js`

**–ó–∞–¥–∞—á–∞**: –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ ad sets –∏ –∫—Ä–µ–∞—Ç–∏–≤—ã, –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∏—Å–∫ —Ä–æ—Å—Ç–∞ CPL –Ω–∞ 3 –¥–Ω—è, –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ main brain.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ü–ï–†–ï–î –æ—Å–Ω–æ–≤–Ω—ã–º brain LLM
2. –î–µ—Ä–≥–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ FB API –Ω–∞–ø—Ä—è–º—É—é (–≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ!):
   - –ê–∫—Ç–∏–≤–Ω—ã–µ adsets: last_7d –∏ prev_7d –¥–ª—è —Ç—Ä–µ–Ω–¥–æ–≤
   - –ì–æ—Ç–æ–≤—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –∏–∑ user_creatives: last_30d
3. LLM –°–ê–ú –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç risk_score (0-100) –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
4. –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ main brain —á–µ—Ä–µ–∑ `llmInput.scoring`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ scoring_output**:
```json
{
  "summary": { high/medium/low counts, overall_trend, alert_level },
  "active_items": [
    { adset_id, risk_score, risk_level, prediction, recommendations }
  ],
  "ready_creatives": [
    { name, fb_creative_id, creative_score, performance }
  ],
  "recommendations_for_brain": ["HIGH RISK: adset X ‚Üí —Å–Ω–∏–∑–∏—Ç—å –±—é–¥–∂–µ—Ç", ...]
}
```

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã Supabase**:
- `creative_metrics_history` - snapshot –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∞—É–¥–∏—Ç–∞
- `scoring_executions` - –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `creative_scores` - —Ç–µ–∫—É—â–∏–µ —Å–∫–æ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
- `SCORING_ENABLED=true` - –≤–∫–ª—é—á–∏—Ç—å scoring agent
- `SCORING_MODEL=gpt-4o` - –º–æ–¥–µ–ª—å LLM –¥–ª—è —Å–∫–æ—Ä–∏–Ω–≥–∞
- `SCORING_MIN_IMPRESSIONS=1000` - –º–∏–Ω–∏–º—É–º –ø–æ–∫–∞–∑–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å–∫–æ—Ä–∏–Ω–≥–∞
- `SCORING_PREDICTION_DAYS=3` - –Ω–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–∏–∫—à–Ω

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å main brain**:
Main brain –ø–æ–ª—É—á–∞–µ—Ç scoring –¥–∞–Ω–Ω—ã–µ –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç:
- –ü—Ä–∏ HIGH risk ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞
- ready_creatives ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π —Å —Ö–æ—Ä–æ—à–∏–º–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏
- recommendations_for_brain ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –æ—Ç scoring LLM

**–§–∏–ª–æ—Å–æ—Ñ–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)**:
- ‚ùå –ù–ï —Ö—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–∫–æ—Ä–∏–Ω–≥–∞ ‚Üí ‚úÖ –≤—Å–µ–≥–¥–∞ –¥–µ—Ä–≥–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ FB API
- ‚ùå –ù–ï —Å—á–∏—Ç–∞–µ–º risk_score —Ñ–æ—Ä–º—É–ª–æ–π ‚Üí ‚úÖ LLM —Å–∞–º –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∏—Å–∫
- ‚úÖ creative_metrics_history - —Ç–æ–ª—å–∫–æ snapshot –¥–ª—è –∞—É–¥–∏—Ç–∞

### –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- SYSTEM_PROMPT (–≤ brain) ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è ¬´–ø–æ–≤–µ–¥–µ–Ω–∏—è¬ª –º–µ–¥–∏–∞–±–∞–π–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ JSON-–æ—Ç–≤–µ—Ç–∞
- SCORING_SYSTEM_PROMPT (–≤ scoring.js) ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è scoring LLM –ø–æ –æ—Ü–µ–Ω–∫–µ —Ä–∏—Å–∫–æ–≤
- –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ ALLOWED_TYPES –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ brain, –∞ —Ç–∞–∫–∂–µ –≤ routes/actions.ts + workflows –≤ agent-service
- Cron-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ src/server.js, –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

