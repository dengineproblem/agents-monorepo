-- Миграция: Добавление флага режима создания ad sets
-- Дата: 2025-11-06
-- Описание: Позволяет пользователям выбирать между автоматическим созданием ad sets
--           через API (api_create) и использованием заранее созданных ad sets (use_existing)

-- =====================================================
-- Добавить колонку default_adset_mode
-- =====================================================

ALTER TABLE user_accounts
ADD COLUMN default_adset_mode TEXT DEFAULT 'api_create' 
CHECK (default_adset_mode IN ('api_create', 'use_existing'));

-- =====================================================
-- Комментарий
-- =====================================================

COMMENT ON COLUMN user_accounts.default_adset_mode IS 
  'Режим создания ad sets:
   - api_create: создавать новые через Meta API (по умолчанию)
   - use_existing: использовать pre-created ad sets (для пользователей с несколькими направлениями и разными WhatsApp номерами)';

-- =====================================================
-- Индекс для быстрой фильтрации
-- =====================================================

CREATE INDEX idx_user_accounts_adset_mode 
  ON user_accounts(default_adset_mode) 
  WHERE default_adset_mode = 'use_existing';

-- =====================================================
-- Проверка
-- =====================================================

-- Все существующие пользователи автоматически получат default_adset_mode = 'api_create'
-- Это гарантирует 100% обратную совместимость






