-- Migration 158: Add platform column to creative_metrics_history
-- Date: 2025-01-17
-- Description: –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É platform –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ Facebook –∏ TikTok
-- ‚ö†Ô∏è CRITICAL: –ò–∑–º–µ–Ω—è–µ—Ç unique constraint - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã

-- =====================================================
-- –®–ê–ì 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ platform
-- =====================================================
-- SAFE: –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É —Å DEFAULT 'facebook'
-- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç platform='facebook'

ALTER TABLE creative_metrics_history
  ADD COLUMN IF NOT EXISTS platform TEXT DEFAULT 'facebook';

-- =====================================================
-- –®–ê–ì 2: –ò–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
-- =====================================================
-- SAFE: –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

CREATE INDEX IF NOT EXISTS idx_creative_metrics_history_platform
  ON creative_metrics_history(platform);

COMMENT ON COLUMN creative_metrics_history.platform IS 'Platform: facebook or tiktok';

-- =====================================================
-- –®–ê–ì 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
-- =====================================================
-- ‚ö†Ô∏è REQUIRES VERIFICATION:
-- –°—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å: (user_account_id, ad_id, date)
-- –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å: (user_account_id, ad_id, date, platform)
--
-- –ó–ê–ß–ï–ú:
-- - –•—Ä–∞–Ω–∏–º –º–µ—Ç—Ä–∏–∫–∏ FB –∏ TikTok –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
-- - ad_id –æ—Ç Facebook –∏ ad_id –æ—Ç TikTok - —ç—Ç–æ –†–ê–ó–ù–´–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
-- - –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ ad_id –º–æ–≥—É—Ç —Å–ª—É—á–∞–π–Ω–æ —Å–æ–≤–ø–∞—Å—Ç—å (–æ–±–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —á–∏—Å–ª–æ–≤—ã–µ ID)
-- - platform –≤ –∏–Ω–¥–µ–∫—Å–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
--
-- –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —É–∂–µ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏
-- (user_account_id, ad_id, date), –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π.
--
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º:
-- SELECT user_account_id, ad_id, date, COUNT(*)
-- FROM creative_metrics_history
-- WHERE ad_id IS NOT NULL
-- GROUP BY user_account_id, ad_id, date
-- HAVING COUNT(*) > 1;

DROP INDEX IF EXISTS creative_metrics_ad_date_unique;

CREATE UNIQUE INDEX IF NOT EXISTS creative_metrics_ad_date_platform_unique
  ON creative_metrics_history(user_account_id, ad_id, date, platform)
  WHERE ad_id IS NOT NULL;

-- =====================================================
-- –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨
-- =====================================================
/*
‚úÖ –ì–ê–†–ê–ù–¢–ò–ò:
1. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–∞—Ç platform='facebook' –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ platform –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
3. –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Ä–∞—Å—à–∏—Ä–µ–Ω (–Ω–µ —Å—É–∂–µ–Ω), –ø–æ—ç—Ç–æ–º—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –±—É–¥–µ—Ç

‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:
1. –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —É–∂–µ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ user_account_id, ad_id, date),
   —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π
2. –ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è–≤–Ω–æ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –∏–Ω–¥–µ–∫—Å creative_metrics_ad_date_unique,
   –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å (–Ω–æ —Ç–∞–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ)

üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
2. –ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã - –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
4. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ production
*/
