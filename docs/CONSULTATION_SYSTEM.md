# üìÖ –°–ò–°–¢–ï–ú–ê –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ô CRM

> **–¶–µ–ª—å:** –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º, –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è–º–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º.

---

## üìã –û–ì–õ–ê–í–õ–ï–ù–ò–ï

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
2. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
3. [–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è](#–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã-–∏-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
4. [–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏](#–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)
5. [–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#—Å–∏—Å—Ç–µ–º–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
6. [API Endpoints](#api-endpoints)
7. [Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#frontend-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
8. [Cron Jobs](#cron-jobs)
9. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
10. [Troubleshooting](#troubleshooting)

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CRM FRONTEND (React)                                        ‚îÇ
‚îÇ  ‚îú‚îÄ Consultations.tsx (–∫–∞–ª–µ–Ω–¥–∞—Ä—å)                            ‚îÇ
‚îÇ  ‚îú‚îÄ ConsultantScheduleManager.tsx (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)               ‚îÇ
‚îÇ  ‚îî‚îÄ NotificationSettings.tsx (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ HTTPS API
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CRM BACKEND (Fastify)                                       ‚îÇ
‚îÇ  ‚îú‚îÄ routes/consultations.ts (CRUD –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π)              ‚îÇ
‚îÇ  ‚îú‚îÄ routes/consultationNotifications.ts (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)          ‚îÇ
‚îÇ  ‚îú‚îÄ lib/consultationNotifications.ts (–ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏)       ‚îÇ
‚îÇ  ‚îú‚îÄ lib/evolutionApi.ts (WhatsApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)                ‚îÇ
‚îÇ  ‚îî‚îÄ cron/notificationCron.ts (—Ñ–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SUPABASE        ‚îÇ         ‚îÇ  EVOLUTION API   ‚îÇ
‚îÇ  (PostgreSQL)    ‚îÇ         ‚îÇ  (WhatsApp)      ‚îÇ
‚îÇ                  ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ  Tables:         ‚îÇ         ‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞:       ‚îÇ
‚îÇ  - consultants   ‚îÇ         ‚îÇ  - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚îÇ
‚îÇ  - consultant_   ‚îÇ         ‚îÇ  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è   ‚îÇ
‚îÇ    schedules     ‚îÇ         ‚îÇ  - –ö–∞—Å—Ç–æ–º–Ω—ã–µ     ‚îÇ
‚îÇ  - consultations ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ  - consultation_ ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ    notifications ‚îÇ         ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|------|----------|
| –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ API | `crm-backend/src/routes/consultations.ts` | CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è API | `crm-backend/src/routes/consultationNotifications.ts` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã |
| –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | `crm-backend/src/lib/consultationNotifications.ts` | –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ |
| WhatsApp | `crm-backend/src/lib/evolutionApi.ts` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Evolution API |
| Cron | `crm-backend/src/cron/notificationCron.ts` | –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ |
| Frontend | `crm-frontend/src/pages/Consultations.tsx` | –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π |

---

## üíæ –ë–ê–ó–ê –î–ê–ù–ù–´–•

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `services/crm-backend/migrations/`:

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `008_add_consultations.sql` | –ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π |
| `009_add_consultant_schedules.sql` | –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è |
| `010_consultation_slots_all_day.sql` | –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–µ —Å–ª–æ—Ç—ã (00:00-24:00) |
| `011_add_consultation_notifications.sql` | –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

### –¢–∞–±–ª–∏—Ü—ã

#### `consultants` - –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã

```sql
CREATE TABLE consultants (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_account_id UUID REFERENCES user_accounts(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    specialization VARCHAR(255),
    phone VARCHAR(50),
    email VARCHAR(255),
    color VARCHAR(7) DEFAULT '#3B82F6',  -- –¶–≤–µ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `consultant_schedules` - –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

```sql
CREATE TABLE consultant_schedules (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    consultant_id UUID REFERENCES consultants(id) ON DELETE CASCADE,
    day_of_week INTEGER NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
    -- 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, ..., 6 = —Å—É–±–±–æ—Ç–∞
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    is_working BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    UNIQUE(consultant_id, day_of_week)
);
```

#### `consultations` - –ó–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

```sql
CREATE TABLE consultations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_account_id UUID REFERENCES user_accounts(id) ON DELETE CASCADE,
    consultant_id UUID REFERENCES consultants(id) ON DELETE SET NULL,
    dialog_analysis_id UUID REFERENCES dialog_analysis(id) ON DELETE SET NULL,

    client_name VARCHAR(255),
    client_phone VARCHAR(50) NOT NULL,

    date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,

    status VARCHAR(50) DEFAULT 'scheduled',  -- scheduled, completed, cancelled, no_show
    notes TEXT,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `consultation_notification_settings` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```sql
CREATE TABLE consultation_notification_settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_account_id UUID REFERENCES user_accounts(id) ON DELETE CASCADE UNIQUE,

    -- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    confirmation_enabled BOOLEAN DEFAULT true,
    confirmation_template TEXT DEFAULT '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ{{#client_name}}, {{client_name}}{{/client_name}}! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é {{date}} –≤ {{time}}. –î–æ –≤—Å—Ç—Ä–µ—á–∏!',

    -- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞
    reminder_24h_enabled BOOLEAN DEFAULT true,
    reminder_24h_template TEXT DEFAULT '–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –≤–∞—à–µ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∑–∞–≤—Ç—Ä–∞ {{date}} –≤ {{time}}. –ñ–¥—ë–º –≤–∞—Å!',

    -- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 —á–∞—Å
    reminder_1h_enabled BOOLEAN DEFAULT true,
    reminder_1h_template TEXT DEFAULT '–ß–µ—Ä–µ–∑ —á–∞—Å —É –≤–∞—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤ {{time}}. –î–æ —Å–∫–æ—Ä–æ–π –≤—Å—Ç—Ä–µ—á–∏!',

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `consultation_notification_templates` - –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã

```sql
CREATE TABLE consultation_notification_templates (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_account_id UUID REFERENCES user_accounts(id) ON DELETE CASCADE,

    name VARCHAR(255) NOT NULL,              -- "–ó–∞ 3 –¥–Ω—è –¥–æ –≤–∏–∑–∏—Ç–∞"
    minutes_before INTEGER NOT NULL,         -- 4320 = 3 –¥–Ω—è
    template TEXT NOT NULL,                  -- –¢–µ–∫—Å—Ç —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
    is_enabled BOOLEAN DEFAULT true,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `consultation_notifications` - –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```sql
CREATE TABLE consultation_notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    consultation_id UUID REFERENCES consultations(id) ON DELETE CASCADE,

    notification_type VARCHAR(50) NOT NULL,  -- confirmation, reminder_24h, reminder_1h, custom
    template_id UUID REFERENCES consultation_notification_templates(id) ON DELETE SET NULL,

    message_text TEXT NOT NULL,              -- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
    instance_name VARCHAR(255),              -- WhatsApp –∏–Ω—Å—Ç–∞–Ω—Å
    phone VARCHAR(50) NOT NULL,

    status VARCHAR(50) DEFAULT 'pending',    -- pending, sent, failed, skipped
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,           -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

    scheduled_at TIMESTAMP WITH TIME ZONE,   -- –ö–æ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    sent_at TIMESTAMP WITH TIME ZONE,        -- –ö–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## üë®‚Äçüíº –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–´ –ò –†–ê–°–ü–ò–°–ê–ù–ò–Ø

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

```bash
# POST /consultants
curl -X POST http://localhost:8084/consultants \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "specialization": "–ü—Å–∏—Ö–æ–ª–æ–≥",
    "phone": "+79001234567",
    "email": "ivan@example.com",
    "color": "#3B82F6",
    "user_account_id": "uuid-here"
  }'
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–ö–∞–∂–¥—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏–º–µ–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:

```bash
# POST /consultants/:id/schedules
curl -X POST http://localhost:8084/consultants/{id}/schedules \
  -H "Content-Type: application/json" \
  -d '{
    "schedules": [
      { "day_of_week": 1, "start_time": "09:00", "end_time": "18:00", "is_working": true },
      { "day_of_week": 2, "start_time": "09:00", "end_time": "18:00", "is_working": true },
      { "day_of_week": 3, "start_time": "09:00", "end_time": "18:00", "is_working": true },
      { "day_of_week": 4, "start_time": "09:00", "end_time": "18:00", "is_working": true },
      { "day_of_week": 5, "start_time": "09:00", "end_time": "17:00", "is_working": true },
      { "day_of_week": 6, "start_time": "10:00", "end_time": "14:00", "is_working": true },
      { "day_of_week": 0, "start_time": "00:00", "end_time": "00:00", "is_working": false }
    ]
  }'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤

```bash
# GET /consultations/available-slots?date=2024-01-15&consultant_id=uuid
curl "http://localhost:8084/consultations/available-slots?date=2024-01-15&consultant_id={id}"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "slots": [
    { "start_time": "09:00", "end_time": "09:30" },
    { "start_time": "09:30", "end_time": "10:00" },
    { "start_time": "10:00", "end_time": "10:30" }
  ]
}
```

–°–ª–æ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º **30 –º–∏–Ω—É—Ç** –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –†–∞—Å–ø–∏—Å–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
- –£–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π

---

## üìÜ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

```bash
# POST /consultations
curl -X POST http://localhost:8084/consultations \
  -H "Content-Type: application/json" \
  -d '{
    "consultant_id": "uuid",
    "user_account_id": "uuid",
    "dialog_analysis_id": "uuid",  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –¥–∏–∞–ª–æ–≥—É
    "client_name": "–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞",
    "client_phone": "+79001234567",
    "date": "2024-01-15",
    "start_time": "10:00",
    "end_time": "10:30",
    "notes": "–ü–µ—Ä–≤–∏—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"
  }'
```

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** –≤ WhatsApp (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
2. –ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è **–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** –∑–∞ 24 —á–∞—Å–∞ –∏ –∑–∞ 1 —á–∞—Å (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
3. –ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è **–∫–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)

### –°—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `scheduled` | –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ |
| `completed` | –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ |
| `cancelled` | –û—Ç–º–µ–Ω–µ–Ω–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–º–µ–Ω—è—é—Ç—Å—è) |
| `no_show` | –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏—à—ë–ª |

### –û—Ç–º–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

```bash
# PUT /consultations/:id
curl -X PUT http://localhost:8084/consultations/{id} \
  -H "Content-Type: application/json" \
  -d '{ "status": "cancelled" }'
```

–ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤—Å–µ **pending** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `skipped`.

---

## üì≤ –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –¢–∏–ø | –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------------|----------|
| `confirmation` | –°—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ |
| `reminder_24h` | –ó–∞ 24 —á–∞—Å–∞ | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ —Å—É—Ç–∫–∏ |
| `reminder_1h` | –ó–∞ 1 —á–∞—Å | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ —á–∞—Å |
| `custom` | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ | –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã |

### –°—Ç–∞—Ç—É—Å—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `pending` | –û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `sent` | –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `failed` | –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `skipped` | –ü—Ä–æ–ø—É—â–µ–Ω–æ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞) |

### –®–∞–±–ª–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `{{client_name}}` | –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ | –ú–∞—Ä–∏—è |
| `{{date}}` | –î–∞—Ç–∞ –≤ —Ä—É—Å—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ | 15 —è–Ω–≤–∞—Ä—è |
| `{{time}}` | –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ | 10:00 |
| `{{consultant_name}}` | –ò–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ | –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ |

### –£—Å–ª–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏

–°–∏–Ω—Ç–∞–∫—Å–∏—Å: `{{#variable}}—Ç–µ–∫—Å—Ç{{/variable}}`

–¢–µ–∫—Å—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –ø—É—Å—Ç–∞—è:

```
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ{{#client_name}}, {{client_name}}{{/client_name}}!
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ï—Å–ª–∏ `client_name = "–ú–∞—Ä–∏—è"`: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ú–∞—Ä–∏—è!"
- –ï—Å–ª–∏ `client_name` –ø—É—Å—Ç–æ–µ: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"

### –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ       ‚îÇ
‚îÇ  –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è      ‚îÇ‚îÄ‚îÄ‚Üí Invalid ‚Üí Skip
‚îÇ  —Ç–µ–ª–µ—Ñ–æ–Ω–∞       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–æ–ª—É—á–µ–Ω–∏–µ      ‚îÇ‚îÄ‚îÄ‚Üí –ù–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Å–∞ ‚Üí Fail
‚îÇ  WhatsApp       ‚îÇ
‚îÇ  –∏–Ω—Å—Ç–∞–Ω—Å–∞       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞       ‚îÇ‚îÄ‚îÄ‚Üí –û—à–∏–±–∫–∞ ‚Üí Retry (–¥–æ 3 —Ä–∞–∑)
‚îÇ  –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ   ‚îÇ
‚îÇ  –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π    ‚îÇ
‚îÇ  (pending)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Cron (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–±—Ä–∞–±–æ—Ç–∫–∞      ‚îÇ
‚îÇ  pending        ‚îÇ
‚îÇ  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í—ã–±–æ—Ä WhatsApp –∏–Ω—Å—Ç–∞–Ω—Å–∞

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –ò–Ω—Å—Ç–∞–Ω—Å –∏–∑ `dialog_analysis.instance_name` (–µ—Å–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–∞)
2. –ü–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π (`status = 'connected'`) –∏–Ω—Å—Ç–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üîå API ENDPOINTS

### –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/consultations` | –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ |
| GET | `/consultations/:id` | –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é |
| POST | `/consultations` | –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é |
| PUT | `/consultations/:id` | –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é |
| DELETE | `/consultations/:id` | –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é |
| GET | `/consultations/available-slots` | –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã |

### –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/consultants` | –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ |
| GET | `/consultants/:id` | –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ |
| POST | `/consultants` | –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ |
| PUT | `/consultants/:id` | –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ |
| DELETE | `/consultants/:id` | –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ |
| GET | `/consultants/:id/schedules` | –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ |
| POST | `/consultants/:id/schedules` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/consultation-notifications/settings` | –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| PUT | `/consultation-notifications/settings` | –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| GET | `/consultation-notifications/templates` | –°–ø–∏—Å–æ–∫ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ |
| POST | `/consultation-notifications/templates` | –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω |
| PUT | `/consultation-notifications/templates/:id` | –û–±–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω |
| DELETE | `/consultation-notifications/templates/:id` | –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω |
| GET | `/consultation-notifications/history/:consultationId` | –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

---

## üé® FRONTEND –ö–û–ú–ü–û–ù–ï–ù–¢–´

### Consultations.tsx

–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è:

```tsx
import { Consultations } from '@/pages/Consultations';

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /consultations
```

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
- –¶–≤–µ—Ç–æ–≤–∞—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É –∏ —Å—Ç–∞—Ç—É—Å—É

### ConsultantScheduleManager.tsx

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞:

```tsx
import { ConsultantScheduleManager } from '@/components/ConsultantScheduleManager';

<ConsultantScheduleManager
  consultant={selectedConsultant}
  onClose={() => setIsOpen(false)}
/>
```

### NotificationSettings.tsx

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

```tsx
import { NotificationSettings } from '@/components/NotificationSettings';

<NotificationSettings
  userAccountId={userAccountId}
  isOpen={isSettingsOpen}
  onClose={() => setIsSettingsOpen(false)}
/>
```

**–§—É–Ω–∫—Ü–∏–∏:**
- –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## ‚è∞ CRON JOBS

### –ó–∞–ø—É—Å–∫

Cron jobs –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ `crm-backend`:

```typescript
// server.ts
import { startNotificationCron } from './cron/notificationCron.js';

startNotificationCron();
```

### –ó–∞–¥–∞—á–∏

| –ó–∞–¥–∞—á–∞ | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| Processing | 1 –º–∏–Ω—É—Ç–∞ | –û–±—Ä–∞–±–æ—Ç–∫–∞ pending —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| Retry | 5 –º–∏–Ω—É—Ç | –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è failed |
| Stats | 10 –º–∏–Ω—É—Ç | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |

### –õ–æ–≥–∏

```
[NotificationCron] Processing completed {processed: 5, sent: 4, failed: 1}
[NotificationCron] Notifications queued for retry {count: 3}
[NotificationCron] Notification statistics {pending: 10, sent: 150, failed: 5, skipped: 2}
```

---

## ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# Evolution API
EVOLUTION_API_URL=http://localhost:8080
EVOLUTION_API_KEY=your-api-key

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-key
```

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (consultationNotifications.ts)

```typescript
// –ú–æ—Å–∫–æ–≤—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (UTC+3)
const MOSCOW_OFFSET_MS = 3 * 60 * 60 * 1000;

// –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è failed —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const MAX_RETRY_ATTEMPTS = 3;

// –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const MIN_SCHEDULE_AHEAD_MS = 5 * 60 * 1000;  // 5 –º–∏–Ω—É—Ç
```

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å–ª–æ—Ç–æ–≤

```typescript
// routes/consultations.ts
const SLOT_INTERVAL_MINUTES = 30;  // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–ª–æ—Ç–æ–≤ –≤ –º–∏–Ω—É—Ç–∞—Ö
```

---

## üÜò TROUBLESHOOTING

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron job:
```bash
docker logs crm-backend | grep NotificationCron
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î:
```sql
SELECT status, COUNT(*)
FROM consultation_notifications
GROUP BY status;
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WhatsApp –∏–Ω—Å—Ç–∞–Ω—Å:
```sql
SELECT instance_name, status
FROM whatsapp_instances
WHERE user_account_id = 'uuid';
```

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Evolution API:
```bash
docker logs evolution-api | grep error
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

1. –í—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º?
2. `user_account_id` –∑–∞–¥–∞–Ω —É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏?
3. –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ –≤–∞–ª–∏–¥–Ω—ã–π (–º–∏–Ω–∏–º—É–º 10 —Ü–∏—Ñ—Ä)?

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+3). –î–∞—Ç—ã/–≤—Ä–µ–º—è –≤ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

### –ü—Ä–æ–±–ª–µ–º–∞: –î–≤–æ–π–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

Cron –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `LIMIT 50` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `status = 'pending'` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

### –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –í—Å–µ –ª–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
docker logs crm-backend | grep "Notification"

# –õ–æ–≥–∏ Evolution API
docker logs crm-backend | grep "EvolutionAPI"

# –û—à–∏–±–∫–∏
docker logs crm-backend | grep error
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
SELECT
    notification_type,
    status,
    COUNT(*) as count
FROM consultation_notifications
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY notification_type, status
ORDER BY notification_type, status;
```

### Success Rate

```sql
-- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
SELECT
    ROUND(
        (COUNT(*) FILTER (WHERE status = 'sent')::numeric /
         COUNT(*) FILTER (WHERE status IN ('sent', 'failed'))::numeric) * 100,
        1
    ) as success_rate
FROM consultation_notifications
WHERE created_at > NOW() - INTERVAL '7 days';
```

### Pending —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```sql
-- –ó–∞—Å—Ç—Ä—è–≤—à–∏–µ –≤ pending –±–æ–ª—å—à–µ —á–∞—Å–∞
SELECT cn.*, c.client_name, c.date, c.start_time
FROM consultation_notifications cn
JOIN consultations c ON cn.consultation_id = c.id
WHERE cn.status = 'pending'
  AND cn.scheduled_at < NOW() - INTERVAL '1 hour';
```

---

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ   ‚îÇ
                    ‚îÇ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚ñº               ‚ñº               ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ‚îÇ ‚îÇReminder  ‚îÇ ‚îÇ  Reminder    ‚îÇ
    ‚îÇ    (—Å—Ä–∞–∑—É)   ‚îÇ ‚îÇ  24h     ‚îÇ ‚îÇ    1h        ‚îÇ
    ‚îÇ              ‚îÇ ‚îÇ(pending) ‚îÇ ‚îÇ  (pending)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ              ‚îÇ
                          ‚ñº              ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ    Cron –æ–±—Ä–∞–±–æ—Ç–∫–∞      ‚îÇ
                     ‚îÇ   (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)      ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚ñº                ‚ñº                ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ   Sent   ‚îÇ     ‚îÇ  Failed  ‚îÇ     ‚îÇ Skipped  ‚îÇ
          ‚îÇ(—É—Å–ø–µ—à–Ω–æ) ‚îÇ     ‚îÇ (–æ—à–∏–±–∫–∞) ‚îÇ     ‚îÇ(–æ—Ç–º–µ–Ω–µ–Ω–æ)‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº (retry < 3)
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ Pending  ‚îÇ
                          ‚îÇ (–ø–æ–≤—Ç–æ—Ä) ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ù–ê–°–¢–†–û–ô–ö–ò

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (008-011)
- [ ] Evolution API –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω
- [ ] WhatsApp –∏–Ω—Å—Ç–∞–Ω—Å –ø–æ–¥–∫–ª—é—á–µ–Ω (status = 'connected')
- [ ] user_account_id –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
- [ ] Cron job –∑–∞–ø—É—â–µ–Ω (`startNotificationCron()` –≤ server.ts)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤ UI
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**
