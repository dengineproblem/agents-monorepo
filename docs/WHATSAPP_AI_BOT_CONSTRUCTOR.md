# WhatsApp AI Bot Constructor

## –û–±–∑–æ—Ä

WhatsApp AI Bot Constructor ‚Äî —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI-–±–æ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ WhatsApp. –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:

- **CRM Backend** (`services/crm-backend`) ‚Äî API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞–º–∏ (–ø–æ—Ä—Ç 8084)
- **Chatbot Service** (`services/chatbot-service`) ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ—Ä—Ç 8083)
- **CRM Frontend** (`services/crm-frontend`) ‚Äî UI –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Evolution     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Chatbot Service ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     OpenAI      ‚îÇ
‚îÇ   API (WA)      ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (port 8083)   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ      API        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CRM Frontend  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   CRM Backend   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Supabase     ‚îÇ
‚îÇ   (port 3002)   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (port 8084)   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   PostgreSQL    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                         ‚îÇ
                                                         ‚ñº
                                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                ‚îÇ      Redis      ‚îÇ
                                                ‚îÇ  (msg buffer)   ‚îÇ
                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `ai_bot_configurations`

–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞:

```sql
CREATE TABLE ai_bot_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_account_id UUID NOT NULL REFERENCES user_accounts(id),
  name TEXT NOT NULL DEFAULT '–ú–æ–π –±–æ—Ç',
  is_active BOOLEAN DEFAULT true,

  -- AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  system_prompt TEXT DEFAULT '',
  temperature NUMERIC(3,2) DEFAULT 0.24,
  model TEXT DEFAULT 'gpt-4o',

  -- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
  history_token_limit INTEGER DEFAULT 8000,
  history_message_limit INTEGER,          -- NULL = –±–µ–∑ –ª–∏–º–∏—Ç–∞
  history_time_limit_hours INTEGER,       -- NULL = –±–µ–∑ –ª–∏–º–∏—Ç–∞

  -- –ë—É—Ñ–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º)
  message_buffer_seconds INTEGER DEFAULT 7,

  -- –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  operator_pause_enabled BOOLEAN DEFAULT true,
  operator_pause_ignore_first_message BOOLEAN DEFAULT true,
  operator_auto_resume_hours INTEGER DEFAULT 0,
  operator_auto_resume_minutes INTEGER DEFAULT 0,
  operator_pause_exceptions TEXT[] DEFAULT '{}',

  -- –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
  stop_phrases TEXT[] DEFAULT '{}',       -- –§—Ä–∞–∑—ã –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
  resume_phrases TEXT[] DEFAULT '{}',     -- –§—Ä–∞–∑—ã –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

  -- –†–∞–∑–±–∏–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  split_messages BOOLEAN DEFAULT false,
  split_max_length INTEGER DEFAULT 500,
  clean_markdown BOOLEAN DEFAULT true,

  -- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  schedule_enabled BOOLEAN DEFAULT false,
  schedule_hours_start INTEGER DEFAULT 9,
  schedule_hours_end INTEGER DEFAULT 18,
  schedule_days INTEGER[] DEFAULT '{1,2,3,4,5}', -- 1=–ü–Ω, 7=–í—Å
  timezone TEXT DEFAULT 'Europe/Moscow',
  pass_current_datetime BOOLEAN DEFAULT true,

  -- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  voice_recognition_enabled BOOLEAN DEFAULT false,
  voice_default_response TEXT,

  -- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  image_recognition_enabled BOOLEAN DEFAULT false,
  image_default_response TEXT,

  -- –î–æ–∫—É–º–µ–Ω—Ç—ã
  document_recognition_enabled BOOLEAN DEFAULT false,
  document_default_response TEXT,

  -- –§–∞–π–ª—ã
  file_handling_mode TEXT DEFAULT 'ignore', -- 'ignore' | 'respond'
  file_default_response TEXT,

  -- –°–æ–æ–±—â–µ–Ω–∏—è
  start_message TEXT,                     -- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  error_message TEXT,                     -- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

  -- –°–≤–æ–π API –∫–ª—é—á OpenAI
  custom_openai_api_key TEXT,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### –¢–∞–±–ª–∏—Ü–∞ `ai_bot_functions`

–§—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –±–æ—Ç:

```sql
CREATE TABLE ai_bot_functions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bot_id UUID NOT NULL REFERENCES ai_bot_configurations(id) ON DELETE CASCADE,
  name TEXT NOT NULL,                     -- –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è OpenAI
  description TEXT,                       -- –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–æ–¥–µ–ª–∏
  parameters JSONB DEFAULT '{}',          -- JSON Schema –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  handler_type TEXT NOT NULL,             -- 'forward_to_manager' | 'internal' | 'webhook'
  handler_config JSONB DEFAULT '{}',      -- { url: '...' } –¥–ª—è webhook
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### –°–≤—è–∑—å —Å WhatsApp

–¢–∞–±–ª–∏—Ü–∞ `whatsapp_instances` –∏–º–µ–µ—Ç –ø–æ–ª–µ `ai_bot_id`:

```sql
ALTER TABLE whatsapp_instances
ADD COLUMN ai_bot_id UUID REFERENCES ai_bot_configurations(id);
```

---

## API Endpoints

### CRM Backend (`/api/crm/...`)

#### –ë–æ—Ç—ã

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/ai-bots?userId=...` | –°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| GET | `/ai-bots/:botId` | –ü–æ–ª—É—á–∏—Ç—å –±–æ—Ç–∞ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ |
| POST | `/ai-bots` | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ |
| PUT | `/ai-bots/:botId` | –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ |
| DELETE | `/ai-bots/:botId` | –£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞ |

#### –§—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/ai-bots/:botId/functions` | –°–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞ |
| POST | `/ai-bots/:botId/functions` | –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é |
| PUT | `/ai-bot-functions/:funcId` | –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é |
| DELETE | `/ai-bot-functions/:funcId` | –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é |

#### WhatsApp —Å–≤—è–∑—å

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| PATCH | `/whatsapp-instances/:instanceId/link-bot` | –ü—Ä–∏–≤—è–∑–∞—Ç—å –±–æ—Ç–∞ –∫ –∏–Ω—Å—Ç–∞–Ω—Å—É |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞:**
```json
POST /api/crm/ai-bots
{
  "userAccountId": "uuid-...",
  "name": "Sales Bot",
  "systemPrompt": "–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º...",
  "temperature": 0.3,
  "model": "gpt-4o"
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```json
PUT /api/crm/ai-bots/:botId
{
  "name": "Updated Bot",
  "isActive": true,
  "messageBufferSeconds": 10,
  "stopPhrases": ["—Å—Ç–æ–ø", "—Ö–≤–∞—Ç–∏—Ç"],
  "resumePhrases": ["–ø—Ä–æ–¥–æ–ª–∂–∏", "–¥–∞–≤–∞–π"],
  "scheduleEnabled": true,
  "scheduleHoursStart": 9,
  "scheduleHoursEnd": 21,
  "scheduleDays": [1, 2, 3, 4, 5]
}
```

**–ü—Ä–∏–≤—è–∑–∫–∞ –±–æ—Ç–∞ –∫ WhatsApp:**
```json
PATCH /api/crm/whatsapp-instances/:instanceId/link-bot
{
  "botId": "uuid-..." // –∏–ª–∏ null –¥–ª—è –æ—Ç–≤—è–∑–∫–∏
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

- `services/chatbot-service/src/lib/aiBotEngine.ts` ‚Äî –¥–≤–∏–∂–æ–∫ –±–æ—Ç–∞
- `services/chatbot-service/src/lib/logUtils.ts` ‚Äî —É—Ç–∏–ª–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
1. –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Evolution API webhook)
        ‚îÇ
        ‚ñº
2. processIncomingMessage() ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
        ‚îÇ
        ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ correlation ID –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
        ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –±–æ—Ç–∞ (getBotConfigForInstance)
        ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–¥–∞ –≤ dialog_analysis
        ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –æ—Ç–≤–µ—Ç–∞ (shouldBotRespondWithConfig)
        ‚îÇ
        ‚ñº
3. collectMessagesWithConfig() ‚Äî –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
        ‚îÇ
        ‚îú‚îÄ‚îÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Redis list
        ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ context –≤ Redis
        ‚îî‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ (message_buffer_seconds)
        ‚îÇ
        ‚ñº
4. processAIBotResponse() ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        ‚îÇ
        ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (loadMessageHistory)
        ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ stop/resume —Ñ—Ä–∞–∑
        ‚îú‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (generateAIResponse)
        ‚îú‚îÄ‚îÄ –û—á–∏—Å—Ç–∫–∞ markdown (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        ‚îú‚îÄ‚îÄ –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        ‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Evolution API
        ‚îÇ
        ‚ñº
5. handleFunctionCall() ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
        ‚îÇ
        ‚îú‚îÄ‚îÄ forward_to_manager ‚Üí assigned_to_human = true
        ‚îú‚îÄ‚îÄ internal ‚Üí save_user_data –∏ —Ç.–¥.
        ‚îî‚îÄ‚îÄ webhook ‚Üí HTTP POST –Ω–∞ –≤–Ω–µ—à–Ω–∏–π URL
```

### –£—Å–ª–æ–≤–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞

–ë–æ—Ç –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –µ—Å–ª–∏:

1. **bot_paused = true** ‚Äî –±–æ—Ç –Ω–∞ –ø–∞—É–∑–µ (–∫—Ä–æ–º–µ resume —Ñ—Ä–∞–∑)
2. **assigned_to_human = true** ‚Äî –ø–µ—Ä–µ–¥–∞–Ω —á–µ–ª–æ–≤–µ–∫—É
3. **–í–Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è** ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –Ω–µ –≤ schedule_hours
4. **–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞** ‚Äî operator_pause_enabled
5. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ stop_phrase** ‚Äî –±–æ—Ç —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É

–ë–æ—Ç –í–û–ó–û–ë–ù–û–í–õ–Ø–ï–¢ —Ä–∞–±–æ—Ç—É –µ—Å–ª–∏:

- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ resume_phrase
- –ò—Å—Ç–µ–∫ operator_auto_resume_hours/minutes
- bot_paused_until < now()

---

## –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

#### 1. Correlation ID

–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤—Å–µ–≥–æ —Ñ–ª–æ—É –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```typescript
// –§–æ—Ä–º–∞—Ç: req_a1b2c3d4e5f6...
const correlationId = generateCorrelationId();
// –í –ª–æ–≥–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä–æ—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è: a1b2c3d4
```

#### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤:

| –¢–µ–≥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `db` | –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö |
| `api` | HTTP –∑–∞–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã |
| `openai` | –í—ã–∑–æ–≤—ã OpenAI API |
| `webhook` | –ò—Å—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏ |
| `redis` | –û–ø–µ—Ä–∞—Ü–∏–∏ Redis |
| `processing` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `message` | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |
| `schedule` | –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ/—Ç–∞–π–º–µ—Ä—ã |
| `config` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ |
| `validation` | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö |
| `consultation` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏ |

#### 3. –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```typescript
maskPhone('+79991234567')  // ‚Üí '+7***4567'
maskUuid('550e8400-e29b-41d4-a716-446655440000')  // ‚Üí '550e...0000'
maskApiKey('sk-1234567890abcdef')  // ‚Üí 'sk-123...cdef'
maskEmail('user@example.com')  // ‚Üí 'u***@example.com'
```

#### 4. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–∏–Ω–≥ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏:

```typescript
ctxLog.checkpoint('fetch_config');
// ... –æ–ø–µ—Ä–∞—Ü–∏—è ...
ctxLog.checkpoint('generate_ai');
// ... –æ–ø–µ—Ä–∞—Ü–∏—è ...

ctxLog.getTimings();
// {
//   totalElapsedMs: 1234,
//   fetch_configMs: 45,
//   generate_aiMs: 890
// }
```

#### 5. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫

```typescript
classifyError(error);
// {
//   type: 'db_error' | 'api_error' | 'openai_error' | 'timeout_error' | ...,
//   isRetryable: boolean
// }
```

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞

```json
{
  "level": "info",
  "time": "2024-12-24T10:30:00.000Z",
  "cid": "a1b2c3d4",
  "phone": "+7***4567",
  "instance": "my-whatsapp",
  "botId": "550e...0000",
  "botName": "Sales Bot",
  "tags": ["message", "processing"],
  "elapsedMs": 45,
  "msgType": "text",
  "msgLength": 128,
  "msg": "[processIncomingMessage] === NEW INCOMING MESSAGE ==="
}
```

### Context Propagation

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Redis –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```typescript
// –ü—Ä–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
await redis.set(`ctx:${key}`, JSON.stringify(ctx), 'EX', bufferSeconds + 5);

// –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
const savedCtx = JSON.parse(await redis.get(`ctx:${key}`));
const timerLog = createContextLogger(baseLog, savedCtx, ['redis']);
```

---

## –ó–∞—â–∏—Ç–∞ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

### Rate Limiting

–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º–∞:

```typescript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
const MESSAGE_RATE_LIMIT: RateLimitConfig = {
  maxTokens: 20,
  refillRate: 0.333, // ~20 –≤ –º–∏–Ω—É—Ç—É
  tokensPerRequest: 1
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞
const rateCheck = checkRateLimit(`msg:${instanceName}:${phone}`, MESSAGE_RATE_LIMIT);
if (!rateCheck.allowed) {
  // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ, retryAfterMs —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
}
```

### Duplicate Detection

–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç hash-based —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–∫–Ω–æ–º –≤ 1 –º–∏–Ω—É—Ç—É
if (isDuplicateMessage(phone, instanceName, messageText, ctxLog)) {
  return { processed: false, reason: 'duplicate_message' };
}
```

### Retry Logic

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –¥–ª—è transient errors —Å exponential backoff:

```typescript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const DEFAULT_RETRY_CONFIG: RetryConfig = {
  maxRetries: 3,
  baseDelayMs: 1000,
  maxDelayMs: 10000,
  backoffMultiplier: 2
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const botConfig = await withRetry(
  () => getBotConfigForInstance(instanceName, ctxLog),
  ctxLog,
  'getBotConfigForInstance',
  { ...DEFAULT_RETRY_CONFIG, maxRetries: 2 }
);
```

Retry –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ—à–∏–±–æ–∫ —Å `isRetryable: true`:
- `db_error` ‚Äî –æ—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `timeout_error` ‚Äî —Ç–∞–π–º–∞—É—Ç—ã
- `network_error` ‚Äî —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- `openai_error` ‚Äî rate limit –æ—Ç OpenAI

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
const validation = validateMessage(messageText, ctxLog);
// {
//   valid: boolean,
//   sanitized: string,    // –û—á–∏—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
//   warnings: string[]    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (truncated, removed null bytes)
// }
```

–í–∫–ª—é—á–∞–µ—Ç:
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã (50000 —Å–∏–º–≤–æ–ª–æ–≤)
- –£–¥–∞–ª–µ–Ω–∏–µ null bytes
- –£–¥–∞–ª–µ–Ω–∏–µ replacement characters

### Safe JSON Parse

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫:

```typescript
const functionArgs = safeJsonParse<Record<string, any>>(
  toolCall.function.arguments || '{}',
  {},
  log,
  `function_call:${toolCall.function.name}`
);
```

### –ü–æ–¥—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API

```typescript
// –¶–µ–Ω—ã –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤ (—Ü–µ–Ω—Ç—ã)
const TOKEN_PRICES = {
  'gpt-4o': { input: 0.25, output: 1.0 },
  'gpt-4o-mini': { input: 0.015, output: 0.06 },
};

// –õ–æ–≥ –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å
logOpenAiCallWithCost(log, {
  model: 'gpt-4o',
  promptTokens: 500,
  completionTokens: 200,
  ...
});
// Output: [OpenAI] API call completed (gpt-4o) - $0.0033
```

### Stage Transitions

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```typescript
type ProcessingStage =
  | 'received'         // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ
  | 'validated'        // –ü—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ
  | 'config_loaded'    // –ö–æ–Ω—Ñ–∏–≥ –±–æ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω
  | 'lead_loaded'      // –õ–∏–¥ –∑–∞–≥—Ä—É–∂–µ–Ω
  | 'conditions_checked' // –£—Å–ª–æ–≤–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
  | 'buffered'         // –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±—É—Ñ–µ—Ä
  | 'history_loaded'   // –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞
  | 'ai_called'        // OpenAI –≤—ã–∑–≤–∞–Ω
  | 'response_generated' // –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
  | 'message_sent'     // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  | 'completed'        // –ó–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
  | 'failed';          // –û—à–∏–±–∫–∞

// –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞
// [Flow] received ‚Üí validated
// [Flow] validated ‚Üí config_loaded
// ...
// [Flow] === PROCESSING COMPLETED SUCCESSFULLY ===
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```typescript
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ JSONB –ø–æ–ª–µ 'messages'
{
  sender: 'user' | 'bot',
  content: string,
  timestamp: string  // ISO 8601
}

// –õ–∏–º–∏—Ç: 100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
const trimmedMessages = currentMessages.slice(-LIMITS.MAX_HISTORY_MESSAGES);
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏ OpenAI:

| –ú–æ–¥–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| gpt-4o | –û—Å–Ω–æ–≤–Ω–∞—è –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å |
| gpt-4o-mini | –ë—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è |
| gpt-4.1 | –£–ª—É—á—à–µ–Ω–Ω–∞—è GPT-4 |
| gpt-4.1-mini | –û–±–ª–µ–≥—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è |
| gpt-4.1-nano | –°–∞–º–∞—è –ª–µ–≥–∫–∞—è |
| gpt-5 | –ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å |
| gpt-5-mini | –û–±–ª–µ–≥—á–µ–Ω–Ω–∞—è GPT-5 |
| gpt-5-nano | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è GPT-5 |
| gpt-o3 | Reasoning –º–æ–¥–µ–ª—å |

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏

–ë–æ—Ç –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å–∏—Å—Ç–µ–º–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π.

### –í–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –±–æ—Ç–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"
2. –í–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏"
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã** ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ, –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–ª–∏ –≤—Å–µ—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
   - **–°–ª–æ—Ç–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞** ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã—Ö —Å–ª–æ—Ç–æ–≤ (3-10)
   - **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (30, 60, 90, 120 –º–∏–Ω)
   - **–î–Ω–µ–π –≤–ø–µ—Ä—ë–¥** ‚Äî –≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–æ–≤ (7, 14, 30 –¥–Ω–µ–π)
   - **–ê–≤—Ç–æ-—Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ–≥–æ —Ä–µ–∑—é–º–µ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

### Consultation Tools

–ü—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç 5 —Ñ—É–Ω–∫—Ü–∏–π:

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `get_available_consultation_slots` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã |
| `book_consultation` | –ó–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –≤—Ä–µ–º—è |
| `cancel_consultation` | –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å |
| `reschedule_consultation` | –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å |
| `get_my_consultations` | –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ë–î

```sql
ALTER TABLE ai_bot_configurations ADD COLUMN IF NOT EXISTS
  consultation_integration_enabled BOOLEAN DEFAULT false;

ALTER TABLE ai_bot_configurations ADD COLUMN IF NOT EXISTS
  consultation_settings JSONB DEFAULT '{
    "consultant_ids": [],
    "slots_to_show": 5,
    "default_duration_minutes": 60,
    "days_ahead_limit": 14,
    "auto_summarize_dialog": true,
    "collect_client_name": true
  }'::jsonb;
```

### API Endpoints –¥–ª—è –±–æ—Ç–∞

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/consultations/available-slots` | –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã |
| POST | `/consultations/book-from-bot` | –ó–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ |
| POST | `/consultations/cancel-from-bot` | –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å |
| POST | `/consultations/reschedule-from-bot` | –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å |
| GET | `/consultations/by-lead/:id` | –ó–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ |

### –ö–æ—Ä–æ—Ç–∫–∏–π ID –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

GPT –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ UUID (36 —Å–∏–º–≤–æ–ª–æ–≤). –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–∫–æ—Ä–æ—Ç–∫–∏–µ ID** ‚Äî –ø–µ—Ä–≤—ã–µ 6 —Å–∏–º–≤–æ–ª–æ–≤ UUID:

```
–ü–æ–ª–Ω—ã–π UUID:    4d71d287-582b-446e-9ee0-be4a6dee5144
–ö–æ—Ä–æ—Ç–∫–∏–π ID:    4d71d2
```

–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–æ—Ç–∞:

```
## –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã –∏ –∏—Ö ID

–í–ê–ñ–ù–û: –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ consultant_id:
- –ê–Ω–∞—Ç–æ–ª–∏–π: consultant_id = "4d71d2"
- –ú–∞—Ä–∏—è: consultant_id = "7a3bc5"
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ó–∞–ø—Ä–æ—Å —Å–ª–æ—Ç–æ–≤:**
```
GET /consultations/available-slots?duration_minutes=60&limit=5&days_ahead=14
```

**–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–æ—Ä–æ—Ç–∫–∏–π consultant_id):**
```json
POST /consultations/book-from-bot
{
  "dialog_analysis_id": "uuid-...",
  "consultant_id": "4d71d2",
  "date": "2024-12-30",
  "start_time": "14:00",
  "duration_minutes": 60,
  "client_name": "–ò–≤–∞–Ω",
  "auto_summarize": true
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `consultant_id` ‚Äî —ç—Ç–æ –ø–µ—Ä–≤—ã–µ 6 —Å–∏–º–≤–æ–ª–æ–≤ UUID –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞. CRM –∏—â–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –ø–æ –Ω–∞—á–∞–ª—É UUID.

### –§–∞–π–ª—ã

- `services/chatbot-service/src/lib/consultationTools.ts` ‚Äî tool definitions –∏ handlers
- `services/crm-backend/src/lib/consultationSlots.ts` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤
- `services/crm-backend/src/lib/dialogSummarizer.ts` ‚Äî AI-—Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞
- `services/crm-backend/src/routes/consultations.ts` ‚Äî API endpoints

---

## –ß–∞—Ç—ã WhatsApp

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp –Ω–∞–ø—Ä—è–º—É—é –∏–∑ CRM.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ChatsPage (React)                                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ React Query —Å polling (5 —Å–µ–∫)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CRM Backend (Fastify)                                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ /api/crm/chats/* routes                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Evolution        ‚îÇ     ‚îÇ  Evolution API                ‚îÇ
‚îÇ  PostgreSQL       ‚îÇ     ‚îÇ  (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)         ‚îÇ
‚îÇ  (—á—Ç–µ–Ω–∏–µ —á–∞—Ç–æ–≤)   ‚îÇ     ‚îÇ                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –î–æ—Å—Ç—É–ø

- URL: `/bots/chats`
- –ù–∞–≤–∏–≥–∞—Ü–∏—è: Sidebar ‚Üí AI-–±–æ—Ç—ã ‚Üí –ß–∞—Ç—ã

### API Endpoints

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/chats?instanceName=...` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ (–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤) |
| GET | `/chats/:remoteJid/messages?instanceName=...&limit=...&offset=...` | –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ |
| POST | `/chats/:remoteJid/send` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ |
| GET | `/chats/search?instanceName=...&query=...` | –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏/–Ω–æ–º–µ—Ä—É |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤:**
```
GET /api/crm/chats?instanceName=my-whatsapp
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "chats": [
    {
      "remoteJid": "79991234567@s.whatsapp.net",
      "contactName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
      "lastMessage": "–ü—Ä–∏–≤–µ—Ç!",
      "lastMessageTime": 1735689600000,
      "unreadCount": 2,
      "isFromMe": false
    }
  ],
  "count": 42
}
```

**–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:**
```
GET /api/crm/chats/79991234567@s.whatsapp.net/messages?instanceName=my-whatsapp&limit=50
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "messages": [
    {
      "id": "3EB0F...",
      "text": "–ü—Ä–∏–≤–µ—Ç!",
      "timestamp": 1735689600000,
      "fromMe": false,
      "pushName": "–ò–≤–∞–Ω",
      "messageType": "text"
    }
  ],
  "pagination": {
    "total": 128,
    "limit": 50,
    "offset": 0,
    "hasMore": true
  }
}
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```json
POST /api/crm/chats/79991234567@s.whatsapp.net/send
{
  "instanceName": "my-whatsapp",
  "text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
}
```

### –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `text` | –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| `image` | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| `video` | –í–∏–¥–µ–æ |
| `audio` | –ê—É–¥–∏–æ/–≥–æ–ª–æ—Å–æ–≤–æ–µ |
| `document` | –î–æ–∫—É–º–µ–Ω—Ç |
| `sticker` | –°—Ç–∏–∫–µ—Ä |
| `contact` | –ö–æ–Ω—Ç–∞–∫—Ç |
| `location` | –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è |
| `reaction` | –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| `poll` | –û–ø—Ä–æ—Å |
| `unknown` | –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø |

### UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ß–∞—Ç—ã                              [‚Üª] [–í—ã–±–æ—Ä –∏–Ω—Å—Ç–∞–Ω—Å–∞] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîç –ü–æ–∏—Å–∫...    ‚îÇ  –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  +7 999 123-45-67                      ‚îÇ
‚îÇ ‚óè –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ   –ü—Ä–∏–≤–µ—Ç!      ‚îÇ  [10:30] –ü—Ä–∏–≤–µ—Ç!                       ‚îÇ
‚îÇ   10:30        ‚îÇ                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  [10:31] –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!            [–í—ã] ‚îÇ
‚îÇ   –ú–∞—Ä–∏—è        ‚îÇ                                        ‚îÇ
‚îÇ   –ö–æ–≥–¥–∞?       ‚îÇ  [10:35] –ö–∞–∫ –¥–µ–ª–∞?                     ‚îÇ
‚îÇ   –≤—á–µ—Ä–∞        ‚îÇ                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ   –ê–ª–µ–∫—Å–µ–π      ‚îÇ [–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...]      [–û—Ç–ø—Ä–∞–≤–∏—Ç—å]‚îÇ
‚îÇ   –°–ø–∞—Å–∏–±–æ!     ‚îÇ                                        ‚îÇ
‚îÇ   2 –¥–Ω—è –Ω–∞–∑–∞–¥  ‚îÇ                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **ChatsList** ‚Äî –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤ –∏ –ø–æ–∏—Å–∫–æ–º
- **ChatWindow** ‚Äî –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- **MessageInput** ‚Äî –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Polling –≤–º–µ—Å—Ç–æ WebSocket** ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ React Query
2. **Debounced search** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
3. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º** ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –¥–∞—Ç–∞–º
4. **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª** ‚Äî –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
5. **Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
6. **SQL injection protection** ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å:
- **Correlation ID** ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- **–ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤** ‚Äî `+7***4567` –≤ –ª–æ–≥–∞—Ö
- **–¢–µ–≥–∏** ‚Äî `[chats]`, `[db]`, `[api]`
- **–¢–∞–π–º–∏–Ω–≥–∏** ‚Äî –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```json
{
  "level": "info",
  "cid": "a1b2c3d4",
  "tags": ["chats", "db"],
  "phone": "+7***4567",
  "elapsedMs": 45,
  "msg": "[getChats] Fetching chats for instance my-whatsapp"
}
```

### –§–∞–π–ª—ã

- `services/crm-backend/src/routes/chats.ts` ‚Äî API routes
- `services/crm-frontend/src/pages/ChatsPage.tsx` ‚Äî UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- `services/crm-frontend/src/services/chatsService.ts` ‚Äî API —Å–µ—Ä–≤–∏—Å
- `services/crm-frontend/src/types/chat.ts` ‚Äî TypeScript —Ç–∏–ø—ã

---

## –¢–∏–ø—ã —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞

### 1. forward_to_manager

–ü–µ—Ä–µ–¥–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É:

```json
{
  "name": "transfer_to_human",
  "description": "–ü–µ—Ä–µ–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç",
  "handlerType": "forward_to_manager",
  "handlerConfig": {}
}
```

### 2. internal

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (save_user_data):

```json
{
  "name": "save_user_data",
  "description": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞",
  "parameters": {
    "type": "object",
    "properties": {
      "contact_name": { "type": "string" },
      "business_type": { "type": "string" }
    }
  },
  "handlerType": "internal",
  "handlerConfig": {}
}
```

### 3. webhook

–í—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API:

```json
{
  "name": "create_order",
  "description": "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ CRM",
  "parameters": {
    "type": "object",
    "properties": {
      "product_id": { "type": "string" },
      "quantity": { "type": "number" }
    }
  },
  "handlerType": "webhook",
  "handlerConfig": {
    "url": "https://api.example.com/orders"
  }
}
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂

```javascript
// 1. –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
const { bot } = await fetch('/api/crm/ai-bots', {
  method: 'POST',
  body: JSON.stringify({
    userAccountId: userId,
    name: 'Sales Bot',
    systemPrompt: `–¢—ã - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∫–æ–º–ø–∞–Ω–∏–∏ X.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —É–∑–Ω–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–¥—É–∫—Ç.
–ë—É–¥—å –≤–µ–∂–ª–∏–≤, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –ø–æ–∫—É–ø–∫–µ - –≤—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é transfer_to_human.`,
    temperature: 0.5,
    model: 'gpt-4o'
  })
});

// 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞
await fetch(`/api/crm/ai-bots/${bot.id}`, {
  method: 'PUT',
  body: JSON.stringify({
    messageBufferSeconds: 5,
    stopPhrases: ['—Å—Ç–æ–ø', '–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç', '–æ—Ç–ø–∏—Å–∞—Ç—å—Å—è'],
    resumePhrases: ['–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å', '—Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'],
    scheduleEnabled: true,
    scheduleHoursStart: 9,
    scheduleHoursEnd: 21,
    scheduleDays: [1, 2, 3, 4, 5, 6],
    operatorPauseEnabled: true,
    operatorAutoResumeHours: 2
  })
});

// 3. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É
await fetch(`/api/crm/ai-bots/${bot.id}/functions`, {
  method: 'POST',
  body: JSON.stringify({
    name: 'transfer_to_human',
    description: '–ü–µ—Ä–µ–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏',
    handlerType: 'forward_to_manager'
  })
});

// 4. –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ WhatsApp
await fetch(`/api/crm/whatsapp-instances/${instanceId}/link-bot`, {
  method: 'PATCH',
  body: JSON.stringify({ botId: bot.id })
});
```

---

## Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `is_active = true` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –±–æ—Ç–∞ –∫ –∏–Ω—Å—Ç–∞–Ω—Å—É (`ai_bot_id` –≤ `whatsapp_instances`)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ª–∏–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `dialog_analysis`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (schedule_enabled, schedule_hours)
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç –Ω–µ –Ω–∞ –ø–∞—É–∑–µ (`bot_paused` –≤ `dialog_analysis`)

### –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```bash
# chatbot-service
docker logs chatbot-service -f | grep "processIncomingMessage"

# –§–∏–ª—å—Ç—Ä –ø–æ correlation ID
docker logs chatbot-service -f | grep "cid.*a1b2c3d4"

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker logs chatbot-service -f | grep "level.*error"

# –¢–æ–ª—å–∫–æ OpenAI –≤—ã–∑–æ–≤—ã
docker logs chatbot-service -f | grep "tags.*openai"
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis –±—É—Ñ–µ—Ä

```bash
redis-cli keys "pending_messages:*"
redis-cli lrange "pending_messages:instance:phone" 0 -1
```

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### chatbot-service
- `fastify` ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- `openai` ‚Äî OpenAI SDK
- `ioredis` ‚Äî Redis –∫–ª–∏–µ–Ω—Ç
- `@supabase/supabase-js` ‚Äî Supabase –∫–ª–∏–µ–Ω—Ç
- `pino` ‚Äî –ª–æ–≥–≥–µ—Ä

### crm-backend
- `fastify` ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- `zod` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è
- `@supabase/supabase-js` ‚Äî Supabase –∫–ª–∏–µ–Ω—Ç
- `pino` ‚Äî –ª–æ–≥–≥–µ—Ä

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### v1.7.0 (2025-01-02)
- –†–∞–∑–¥–µ–ª "–ß–∞—Ç—ã" –≤ AI-–±–æ—Ç—ã:
  - –ù–æ–≤—ã–π UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp
  - API endpoints –¥–ª—è —á–∞—Ç–æ–≤ (GET /chats, GET /chats/:remoteJid/messages, POST /chats/:remoteJid/send, GET /chats/search)
  - Polling –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ React Query
  - Debounced –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π (text, image, video, audio, document, sticker, contact, location, reaction, poll)
  - Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - SQL injection protection –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
  - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å correlation ID –∏ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

### v1.0.0 (2024-12-24)
- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ AI Bot Constructor
- CRUD API –¥–ª—è –±–æ—Ç–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å chatbot-service
- –ü—Ä–∏–≤—è–∑–∫–∞ –±–æ—Ç–æ–≤ –∫ WhatsApp –∏–Ω—Å—Ç–∞–Ω—Å–∞–º

### v1.1.0 (2024-12-24)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ (messages table, stop/resume phrases)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### v1.2.0 (2024-12-24)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - Correlation ID –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
  - –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫
  - Context propagation —á–µ—Ä–µ–∑ Redis

### v1.6.0 (2024-12-31)
- –ö–æ—Ä–æ—Ç–∫–∏–π ID –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö 6 —Å–∏–º–≤–æ–ª–æ–≤ UUID –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ (GPT –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ UUID)
  - –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–æ—Ç–∞ —Å –∏—Ö –∫–æ—Ä–æ—Ç–∫–∏–º–∏ ID
  - –ü—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ GPT –ø–µ—Ä–µ–¥–∞—ë—Ç `consultant_id` (6 —Å–∏–º–≤–æ–ª–æ–≤) + `date` + `start_time`
  - CRM –∏—â–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –ø–æ –Ω–∞—á–∞–ª—É UUID

### v1.5.0 (2024-12-31)
- –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –±–æ—Ç–∞ –≤ UI:
  - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAI function calling (tools) –≤ testBotResponse
  - –¢–µ—Å—Ç–æ–≤—ã–π lead ID `00000000-0000-0000-0000-000000000000` –¥–ª—è UI —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  - –ü—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (`client_phone`) –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
  - Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ GPT –ø–æ—Å–ª–µ tool calls
- –¢–∞–π–º–∑–æ–Ω–∞ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π:
  - –ü–∞—Ä–∞–º–µ—Ç—Ä `timezone` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Asia/Yekaterinburg)
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–ª–æ—Ç–æ–≤ —Å —É—á—ë—Ç–æ–º —Ç–∞–π–º–∑–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
  - –ë—É—Ñ–µ—Ä 30 –º–∏–Ω—É—Ç –¥–ª—è —Å–ª–æ—Ç–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
- Docker networking:
  - `CRM_BACKEND_URL` env var –¥–ª—è chatbot-service
  - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å chatbot-service –æ—Ç crm-backend

### v1.4.0 (2024-12-28)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏:
  - 5 –Ω–æ–≤—ã—Ö AI tools –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∫–∞–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞–º
  - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ –±–æ—Ç–∞
  - AI-—Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–∏–º–µ—á–∞–Ω–∏–π –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞
- –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ consultation tools:
  - Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
  - –¢–∞–π–º–∞—É—Ç—ã (10 —Å–µ–∫) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ç–µ–≥–∞–º–∏ `consultation`, `api`
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ backend:
  - consultationSlots.ts ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  - dialogSummarizer.ts ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ OpenAI

### v1.3.0 (2024-12-28)
- –ó–∞—â–∏—Ç–∞ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å:
  - Rate limiting (20 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω)
  - Duplicate detection –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff –∏ jitter
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON.parse (safeJsonParse)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - Stage transitions (–ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
  - Processing summary —Å –ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
  - –ü–æ–¥—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API –≤—ã–∑–æ–≤–æ–≤ OpenAI
- –£–ª—É—á—à–µ–Ω–∏—è:
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (user + bot responses)
  - –õ–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
