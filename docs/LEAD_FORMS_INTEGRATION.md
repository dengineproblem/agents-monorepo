# Facebook Lead Forms Integration

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Facebook Lead Forms –¥–ª—è —Å–∫–≤–æ–∑–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Facebook Lead Forms –∫–∞–∫ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –∫–∞–º–ø–∞–Ω–∏–∏ (objective) —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é:
- –°–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–π/–∞–¥—Å–µ—Ç–æ–≤ —Å —Ü–µ–ª—å—é Lead Forms
- –ü–æ–ª—É—á–µ–Ω–∏—è –ª–∏–¥–æ–≤ —á–µ—Ä–µ–∑ webhook –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ú–∞–ø–ø–∏–Ω–≥–∞ –ª–∏–¥–æ–≤ —Å –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏ –¥–ª—è —Å–∫–≤–æ–∑–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ ROI –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –Ω–∞—Ä–∞–≤–Ω–µ —Å site_leads –∏ whatsapp

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –°–û–ó–î–ê–ù–ò–ï –ö–ê–ú–ü–ê–ù–ò–ò                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç objective = 'lead_forms'
2. –í—ã–±–∏—Ä–∞–µ—Ç Lead Form –∏–∑ —Å–ø–∏—Å–∫–∞ (getLeadForms API)
3. –°–æ–∑–¥–∞—ë—Ç—Å—è –∫—Ä–µ–∞—Ç–∏–≤ —Å fb_creative_id_lead_forms
4. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è AdSet —Å:
   - optimization_goal: LEAD_GENERATION
   - destination_type: ON_AD
   - promoted_object: { page_id, lead_gen_form_id }

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –ü–û–õ–£–ß–ï–ù–ò–ï –õ–ò–î–û–í                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Facebook Lead Form ‚Üí Webhook (POST /facebook/webhook)
                            ‚Üì
                    leadgen_id, ad_id, form_id
                            ‚Üì
              Lead Retrieval API (GET /{leadgen_id})
                            ‚Üì
                    field_data (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, email)
                            ‚Üì
              resolveCreativeAndDirection(ad_id)
                            ‚Üì
                ad_creative_mapping ‚Üí creative_id, direction_id
                            ‚Üì
              INSERT leads (source_type = 'lead_form')
                            ‚Üì
                    ROI Analytics üìä
```

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend (agent-service)

#### –¢–∏–ø—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/lib/defaultSettings.ts` | –î–æ–±–∞–≤–ª–µ–Ω `'lead_forms'` –≤ `CampaignGoal` |
| `src/lib/settingsHelpers.ts` | –î–æ–±–∞–≤–ª–µ–Ω `'lead_forms'` –≤ `CampaignObjective` |
| `src/routes/defaultSettings.ts` | –û–±–Ω–æ–≤–ª–µ–Ω–∞ Zod —Å—Ö–µ–º–∞ –¥–ª—è `lead_forms` |

#### Campaign Builder
| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/lib/campaignBuilder.ts` | `getOptimizationGoal`: lead_forms ‚Üí LEAD_GENERATION |
| | `getBillingEvent`: lead_forms ‚Üí IMPRESSIONS |
| | `createAdSetInCampaign`: destination_type = ON_AD |
| `src/routes/campaignBuilder.ts` | promoted_object —Å page_id + lead_gen_form_id |

#### –ö—Ä–µ–∞—Ç–∏–≤—ã
| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/routes/image.ts` | –°–æ–∑–¥–∞–Ω–∏–µ image creative –¥–ª—è lead_forms |
| `src/routes/video.ts` | –°–æ–∑–¥–∞–Ω–∏–µ video creative –¥–ª—è lead_forms |
| `src/routes/carouselCreative.ts` | –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è) |
| `src/routes/actions.ts` | –í—ã–±–æ—Ä fb_creative_id_lead_forms |
| `src/adapters/facebook.ts` | `createLeadFormImageCreative()`, `createLeadFormVideoCreative()` |

#### Workflows
| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/workflows/createAdSetInDirection.ts` | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ lead_forms objective |
| `src/workflows/createCampaignWithCreative.ts` | LeadForms –≤ ObjectiveType |
| `src/workflows/creativeTest.ts` | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ lead_forms –≤ creative test |

#### Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏–¥–æ–≤
| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/routes/facebookWebhooks.ts` | **–ù–û–í–û–ï**: GET/POST /facebook/webhook –¥–ª—è leadgen |

### Agent Brain

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/chatAssistant/agents/ads/handlers.js` | objectiveMap, creativeIdField, goalToObjective –¥–ª—è lead_forms |
| `src/scoring.js` | –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è lead_forms objective |
| `src/chatAssistant/agents/creative/toolDefs.js` | lead_forms –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö objectives |
| `src/server.js` | formLeads –≤ computeLeadsFromActions |

### Frontend

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/context/AppContext.tsx` | `'lead_forms'` –≤ DirectionObjective |
| `src/components/VideoUpload.tsx` | `'lead_forms'` –≤ —Ç–∏–ø–∞—Ö |
| `src/components/profile/EditDirectionDialog.tsx` | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è lead_forms |
| `src/services/facebookApi.ts` | `getLeadForms()` API, action_type: 'lead' |

### –ú–∏–≥—Ä–∞—Ü–∏–∏

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `migrations/102_add_lead_forms_objective.sql` | lead_form_id –≤ default_ad_settings |
| `migrations/103_add_leadgen_id_to_leads.sql` | leadgen_id –≤ leads |
| `migrations/104_add_fb_creative_id_lead_forms.sql` | fb_creative_id_lead_forms –≤ user_creatives |
| `migrations/105_add_fb_page_access_token.sql` | fb_page_access_token –≤ user_accounts –∏ ad_accounts |

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. Webhook –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (GET /facebook/webhook)

Facebook –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç endpoint –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ webhook subscription:

```typescript
// –ó–∞–ø—Ä–æ—Å –æ—Ç Facebook
GET /facebook/webhook?hub.mode=subscribe&hub.verify_token=TOKEN&hub.challenge=CHALLENGE

// –û—Ç–≤–µ—Ç (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
200 OK: CHALLENGE
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è**: `FB_WEBHOOK_VERIFY_TOKEN` (default: `performante_leadgen_webhook_2024`)

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ leadgen —Å–æ–±—ã—Ç–∏–π (POST /facebook/webhook)

Facebook –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É:

```json
{
  "object": "page",
  "entry": [{
    "id": "PAGE_ID",
    "changes": [{
      "field": "leadgen",
      "value": {
        "leadgen_id": "111222333",
        "ad_id": "123456789",
        "form_id": "987654321",
        "page_id": "PAGE_ID",
        "adgroup_id": "ADSET_ID"
      }
    }]
  }]
}
```

### 3. Page Access Token

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–∏–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è **Page Access Token** (–Ω–µ User Access Token).

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ:**
- –ü—Ä–∏ OAuth –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (`/facebook/save-selection`) ‚Üí –ø–æ–ª—É—á–∞–µ–º —á–µ—Ä–µ–∑ `/me/accounts`
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `fb_access_token` –¥–ª—è ad_accounts ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º Page Token
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `fb_page_access_token` (user_accounts –∏ ad_accounts)
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å objective `lead_forms` backend:
  - —Ç—Ä–µ–±—É–µ—Ç `page_id` (user_accounts/ad_accounts),
  - –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å Page Access Token (—Å–Ω–∞—á–∞–ª–∞ `/me/accounts`, –∑–∞—Ç–µ–º fallback `/{page_id}?fields=access_token` ‚Äî –¥–ª—è system user —Ç–æ–∫–µ–Ω–æ–≤),
  - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `fb_page_access_token`,
  - –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ `leadgen` (—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ).

**–õ–æ–≥–∏–∫–∞ –≤ webhook:**
```typescript
// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Page Access Token > User Access Token
const tokenForLeadData = pageAccessToken || userAccessToken;
const leadData = await retrieveLeadData(leadgen_id, tokenForLeadData);
```

**–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ leadgen —Å–æ–±—ã—Ç–∏—è:**
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ OAuth –¥–∞–Ω–Ω—ã—Ö
POST /{page_id}/subscribed_apps
  ?subscribed_fields=leadgen
  &access_token={page_access_token}
```

### 4. Lead Retrieval API

–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ª–∏–¥–∞ –ø–æ leadgen_id:

```typescript
GET https://graph.facebook.com/v20.0/{leadgen_id}
  ?fields=id,ad_id,form_id,created_time,field_data
  &access_token=PAGE_ACCESS_TOKEN

// –û—Ç–≤–µ—Ç
{
  "id": "111222333",
  "ad_id": "123456789",
  "form_id": "987654321",
  "field_data": [
    { "name": "full_name", "values": ["–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"] },
    { "name": "phone_number", "values": ["+77001234567"] },
    { "name": "email", "values": ["ivan@example.com"] }
  ]
}
```

### 5. –ú–∞–ø–ø–∏–Ω–≥ —Å –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏

```
ad_id (–∏–∑ webhook) ‚Üí ad_creative_mapping ‚Üí creative_id + direction_id
```

–¢–∞–±–ª–∏—Ü–∞ `ad_creative_mapping` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É.

### 6. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏–¥–∞ –≤ –ë–î

```sql
INSERT INTO leads (
  user_account_id,    -- UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  account_id,         -- UUID –¥–ª—è –º—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç–Ω–æ—Å—Ç–∏ (–∏–∑ direction)
  name,               -- –ò–º—è –∏–∑ —Ñ–æ—Ä–º—ã
  phone,              -- –¢–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Ñ–æ—Ä–º—ã
  email,              -- Email –∏–∑ —Ñ–æ—Ä–º—ã
  source_type,        -- 'lead_form'
  source_id,          -- Facebook Ad ID
  creative_id,        -- UUID –∫—Ä–µ–∞—Ç–∏–≤–∞ (—á–µ—Ä–µ–∑ ad_creative_mapping)
  direction_id,       -- UUID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  leadgen_id,         -- Facebook leadgen_id (–¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏)
  utm_source,         -- 'facebook_lead_form'
  utm_campaign        -- form_id
)
```

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ù–∞ production Supabase
psql -h YOUR_SUPABASE_HOST -U postgres -d postgres -f migrations/102_add_lead_forms_objective.sql
psql -h YOUR_SUPABASE_HOST -U postgres -d postgres -f migrations/103_add_leadgen_id_to_leads.sql
psql -h YOUR_SUPABASE_HOST -U postgres -d postgres -f migrations/104_add_fb_creative_id_lead_forms.sql
psql -h YOUR_SUPABASE_HOST -U postgres -d postgres -f migrations/105_add_fb_page_access_token.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard ‚Üí SQL Editor.

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í .env –∏–ª–∏ docker-compose
FB_WEBHOOK_VERIFY_TOKEN=performante_leadgen_webhook_2024  # –°–≤–æ–π —Ç–æ–∫–µ–Ω
FB_API_VERSION=v20.0
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ Facebook App

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ [Facebook Developers](https://developers.facebook.com/) ‚Üí Your App ‚Üí Webhooks

2. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π webhook:
   - **Callback URL**: `https://performanteaiagency.com/api/facebook/webhook`
   - **Verify Token**: –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `FB_WEBHOOK_VERIFY_TOKEN`

3. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è:
   - Object: **Page**
   - Fields: **leadgen**

4. –î–ª—è –∫–∞–∂–¥–æ–π Facebook Page –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - Pages ‚Üí Your Page ‚Üí Settings ‚Üí Webhooks
   - –ü–æ–¥–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ leadgen events –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `lead_forms` –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏,
     –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Page Access Token.

### 4. Permissions –≤ Facebook App

–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç permissions:
- `pages_manage_ads` - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- `leads_retrieval` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤
- `pages_read_engagement` - –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### 5. –î–µ–ø–ª–æ–π

```bash
# –î–µ–ø–ª–æ–π agent-service
cd services/agent-service
npm run build
# –†–µ—Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞

# –î–µ–ø–ª–æ–π agent-brain (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
cd services/agent-brain
npm run build
# –†–µ—Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞

# –î–µ–ø–ª–æ–π frontend
cd services/frontend
npm run build
# –û–±–Ω–æ–≤–∏—Ç—å static —Ñ–∞–π–ª—ã
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

```bash
curl "https://performanteaiagency.com/api/facebook/webhook?hub.mode=subscribe&hub.verify_token=performante_leadgen_webhook_2024&hub.challenge=test123"
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: test123
```

### 2. –°–∏–º—É–ª—è—Ü–∏—è leadgen —Å–æ–±—ã—Ç–∏—è

```bash
curl -X POST https://performanteaiagency.com/api/facebook/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "object": "page",
    "entry": [{
      "id": "YOUR_PAGE_ID",
      "changes": [{
        "field": "leadgen",
        "value": {
          "leadgen_id": "test123",
          "ad_id": "123456789",
          "form_id": "987654321",
          "page_id": "YOUR_PAGE_ID"
        }
      }]
    }]
  }'
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Facebook Test Tool

Facebook Developers ‚Üí Webhooks ‚Üí Test ‚Üí leadgen

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ webhook
grep "facebookWebhooks" /var/log/agent-service.log

# –£—Å–ø–µ—à–Ω—ã–µ –ª–∏–¥—ã
grep "Lead form lead created successfully" /var/log/agent-service.log

# –û—à–∏–±–∫–∏
grep "Failed to retrieve lead data" /var/log/agent-service.log

# –ê–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∫–∞ lead_forms –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
grep "Lead forms objective: ensuring page token and leadgen subscription" /var/log/agent-service.log
grep "Page subscribed to leadgen successfully" /var/log/agent-service.log
```

### SQL –∑–∞–ø—Ä–æ—Å—ã

```sql
-- –õ–∏–¥—ã —Å –ª–∏–¥-—Ñ–æ—Ä–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è
SELECT * FROM leads
WHERE source_type = 'lead_form'
AND created_at >= CURRENT_DATE
ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ source_type
SELECT source_type, COUNT(*)
FROM leads
GROUP BY source_type;

-- –õ–∏–¥—ã —Å –º–∞–ø–ø–∏–Ω–≥–æ–º –Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤—ã
SELECT
  l.id,
  l.name,
  l.phone,
  l.leadgen_id,
  l.source_id as ad_id,
  c.title as creative_title,
  d.name as direction_name
FROM leads l
LEFT JOIN user_creatives c ON l.creative_id = c.id
LEFT JOIN account_directions d ON l.direction_id = d.id
WHERE l.source_type = 'lead_form'
ORDER BY l.created_at DESC
LIMIT 20;
```

## Troubleshooting

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ webhook –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ Page –≤ Facebook App
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx –Ω–∞ 5xx –æ—à–∏–±–∫–∏
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `directionsRoutes` (–∞–≤—Ç–æ–ø–æ–ª—É—á–µ–Ω–∏–µ Page Access Token –∏ –ø–æ–¥–ø–∏—Å–∫–∞ leadgen)

### –õ–∏–¥—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ creative_id

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ad_creative_mapping –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ ad_id
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (–Ω–µ –≤—Ä—É—á–Ω—É—é)
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å: `SELECT * FROM ad_creative_mapping WHERE ad_id = 'YOUR_AD_ID'`

### –û—à–∏–±–∫–∞ "Failed to retrieve lead data"

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ access_token –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∞–ª–∏–¥–Ω—ã–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç permission `leads_retrieval`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Lead Form –Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `fb_page_access_token` –∞–∫—Ç—É–∞–ª–µ–Ω (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å lead_forms –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

### –î—É–±–ª–∏–∫–∞—Ç—ã –ª–∏–¥–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `leadgen_id` –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å. –ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å: `SELECT * FROM pg_indexes WHERE indexname = 'idx_leads_leadgen_id_unique'`
2. –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ—Ç - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 103

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [INFRASTRUCTURE.md](./INFRASTRUCTURE.md) - –î–µ–ø–ª–æ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [FRONTEND_API_CONVENTIONS.md](./FRONTEND_API_CONVENTIONS.md) - API –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏
- [ROI_CALCULATOR.md](./ROI_CALCULATOR.md) - ROI –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)

## Changelog

### v1.2.0 (2026-01)
- –ê–≤—Ç–æ–ø–æ–ª—É—á–µ–Ω–∏–µ Page Access Token –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å objective `lead_forms`
- –ê–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ `leadgen` (—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)
- Fallback –ø–æ–ª—É—á–µ–Ω–∏—è Page Access Token —á–µ—Ä–µ–∑ `/{page_id}?fields=access_token` (–¥–ª—è system user —Ç–æ–∫–µ–Ω–æ–≤)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `directionsRoutes` –∏ `facebookHelpers`

### v1.1.0 (2024-12)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Page Access Token –¥–ª—è Lead Forms API
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ fb_page_access_token
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ leadgen —Å–æ–±—ã—Ç–∏—è
- –ú–∏–≥—Ä–∞—Ü–∏–∏ 104 (fb_creative_id_lead_forms) –∏ 105 (fb_page_access_token)
- –í—ã–Ω–µ—Å–µ–Ω—ã –æ–±—â–∏–µ Facebook —Ñ—É–Ω–∫—Ü–∏–∏ –≤ lib/facebookHelpers.ts

### v1.0.0 (2024-12)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ lead_forms objective –≤–æ –≤—Å–µ—Ö workflows
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏–¥–æ–≤ –∏–∑ Facebook Lead Forms
- –î–æ–±–∞–≤–ª–µ–Ω –º–∞–ø–ø–∏–Ω–≥ –ª–∏–¥–æ–≤ —Å –∫—Ä–µ–∞—Ç–∏–≤–∞–º–∏ —á–µ—Ä–µ–∑ ad_creative_mapping
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è lead_form_id –∏ leadgen_id
