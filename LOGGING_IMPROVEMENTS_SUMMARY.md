# –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç

–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 31 –æ–∫—Ç—è–±—Ä—è 2025

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –§–ê–ó–ê 0: –ë–ê–ó–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è)

‚úÖ **Evolution API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- Evolution API –ª–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Docker logs
- Promtail —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –õ–æ–≥–∏ –≤–∏–¥–Ω—ã –≤ Grafana —Å label `service=evolution-api`

‚úÖ **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤**
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Pino + JSON
- –ï–¥–∏–Ω—ã–µ –ø–æ–ª—è: `level`, `service`, `environment`, `message`, `requestId`
- Promtail –ø–∞—Ä—Å–∏—Ç JSON –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∫–∏

---

### –§–ê–ó–ê 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò

‚úÖ **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è Facebook –æ—à–∏–±–æ–∫ —Å msg –∫–æ–¥–∞–º–∏**

**–§–∞–π–ª—ã:**
- `services/agent-service/src/lib/types.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `msgCode`
- `services/agent-service/src/lib/facebookErrors.ts` - –æ–±–Ω–æ–≤–ª—ë–Ω —Å–ª–æ–≤–∞—Ä—å –æ—à–∏–±–æ–∫

**–ù–æ–≤—ã–µ msg –∫–æ–¥—ã:**
- `fb_token_expired` - —Ç–æ–∫–µ–Ω Facebook –∏—Å—Ç—ë–∫ (–∫–æ–¥ 190)
- `fb_rate_limit` - –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–æ–¥—ã 4, 17)
- `fb_permission_error` - –æ—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–∫–æ–¥ 200)
- `fb_account_restricted` - –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (200:1545041)
- `fb_fetch_timeout` - —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ FB
- `fb_invalid_params` - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–æ–¥ 100)
- `fb_api_error` - –æ–±—â–∞—è –æ—à–∏–±–∫–∞ API
- –ò –¥—Ä—É–≥–∏–µ...

**–§–∞–π–ª:** `services/agent-service/src/adapters/facebook.ts`
- –§—É–Ω–∫—Ü–∏—è `graph()` - –ª–æ–≥–∏—Ä—É–µ—Ç `msg: resolution.msgCode`
- –§—É–Ω–∫—Ü–∏—è `uploadVideo()` - –ª–æ–≥–∏—Ä—É–µ—Ç `msg: resolution.msgCode`

‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ dispatch**

**–§–∞–π–ª:** `services/agent-brain/src/server.js`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `msg: 'actions_dispatch_failed'`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `userAccountId` –∏ `userAccountName`
- –û—à–∏–±–∫–∞ dispatch –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞

‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Supabase –æ—à–∏–±–æ–∫**

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `services/agent-brain/src/lib/supabaseClient.js`
- `services/agent-service/src/lib/supabaseClient.ts`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (process.exit(1) –µ—Å–ª–∏ –Ω–µ—Ç)
- Wrapper `supabaseQuery()` –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å `msg` –∫–æ–¥–∞–º–∏:
  - `supabase_config_missing`
  - `supabase_query_error`
  - `supabase_unavailable`

---

### –§–ê–ó–ê 2: –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø FB –õ–û–ì–ò–ö–ò

‚úÖ **–¢–∞–π–º–∞—É—Ç—ã –Ω–∞ Facebook –∑–∞–ø—Ä–æ—Å—ã**

**–§–∞–π–ª:** `services/agent-service/src/adapters/facebook.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `graph()`:**
- –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥ —Å AbortController
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –ª–æ–≥–∏—Ä—É–µ—Ç `msg: 'fb_fetch_timeout'`
- Throw –ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–∏: "Facebook API timeout after 15s"

‚úÖ **–ù–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –æ—Ç—á—ë—Ç–µ**

**–§–∞–π–ª:** `services/agent-brain/src/server.js`

**–§—É–Ω–∫—Ü–∏—è `buildReport()`:**
```javascript
if (accountStatus?.error) {
  statusLine = `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Facebook (${accountStatus.error})`;
} else if (accountStatus?.account_status === 1) {
  statusLine = `–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω (ID: ${accountStatus?.id || '‚Äî'})`;
} else if (accountStatus?.account_status === 2) {
  statusLine = `–ê–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (–ø—Ä–∏—á–∏–Ω–∞: ${accountStatus?.disable_reason ?? '‚Äî'})`;
} else {
  statusLine = `‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω`;
}
```

---

### –§–ê–ó–ê 3: –ù–ê–ë–õ–Æ–î–ê–ï–ú–û–°–¢–¨ (Grafana)

‚úÖ **–ù–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥ "Errors by User"**

**–§–∞–π–ª:** `logging/grafana-provisioning/dashboards/errors-by-user.json`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- `$username` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `$service` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–µ—Ä–≤–∏—Å—É
- `$msg` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏

**–ü–∞–Ω–µ–ª–∏:**

1. **User Errors Log Stream** - –ª–æ–≥ –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –§–∏–ª—å—Ç—Ä: `{userAccountName=~"$username",service=~"$service",level="error"}`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

2. **Errors by Service (Last 24h)** - bar chart
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º –∑–∞ 24—á
   - –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: >10 = yellow, >50 = red

3. **Errors by Message Type (Last 24h)** - —Ç–∞–±–ª–∏—Ü–∞
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `msg` –∏ `service`
   - **Value mappings** —Å —ç–º–æ–¥–∑–∏:
     - `fb_token_expired` ‚Üí üîë Facebook —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
     - `fb_rate_limit` ‚Üí ‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ FB
     - `fb_permission_error` ‚Üí üîí –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ FB
     - `fb_fetch_timeout` ‚Üí ‚è≥ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ FB
     - `actions_dispatch_failed` ‚Üí ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è
     - `supabase_unavailable` ‚Üí üóÑÔ∏è –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
     - –ò –¥—Ä—É–≥–∏–µ...

4. **Infrastructure Errors (no user)** - –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
   - –§–∏–ª—å—Ç—Ä: `{level="error"} | json | userAccountId=""`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

### –§–ê–ó–ê 4: –ê–õ–ï–†–¢–´

‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π logAlerts worker**

**–§–∞–π–ª:** `services/agent-brain/src/lib/logAlerts.js`

**–§—É–Ω–∫—Ü–∏—è `queryLoki()`:**
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `LOG_ALERT_CRITICAL_ONLY=true`
- –§–∏–ª—å—Ç—Ä: `fb_token_expired|fb_rate_limit|actions_dispatch_failed|supabase_unavailable|supabase_config_missing`

**–§—É–Ω–∫—Ü–∏—è `formatMessage()`:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —ç–º–æ–¥–∑–∏ –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏:
  - üîë - fb_token_expired
  - ‚è±Ô∏è - fb_rate_limit
  - ‚è≥ - fb_fetch_timeout
  - üóÑÔ∏è - supabase_unavailable/config_missing
  - ‚ö†Ô∏è - actions_dispatch_failed
  - ‚ùå - fb_* (–æ–±—â–∏–µ –æ—à–∏–±–∫–∏ FB)
- –ü–æ–Ω—è—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–º–µ—Å—Ç–æ "–û—à–∏–±–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ"
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ "–¢–∏–ø" —Å msg –∫–æ–¥–æ–º

**–ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```
üîë Facebook —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
–¢–∏–ø: `fb_token_expired`
–°–µ—Ä–≤–∏—Å: agent-service
–ú–æ–¥—É–ª—å: facebookAdapter
UserAccount: 0f559eb0-...
–ò–º—è: performante
Facebook code: 190/‚Äî
–†–µ—à–µ–Ω–∏–µ: –°–µ—Å—Å–∏—è Facebook –∏—Å—Ç–µ–∫–ª–∞. –ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.
Hint: –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞.
```

---

### –§–ê–ó–ê 5: –ö–û–°–ú–ï–¢–ò–ö–ê / UX

‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–æ–≤**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ buildReport():
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—à–∏–±–æ–∫ FB
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ê–∫—Ç–∏–≤–µ–Ω" –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

---

### –§–ê–ó–ê 6: –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

‚úÖ **–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ Docker**

**–§–∞–π–ª:** `docker-daemon.json.example`
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é:**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
sudo cp docker-daemon.json.example /etc/docker/daemon.json
sudo systemctl restart docker
docker-compose restart
```

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker images**

**–§–∞–π–ª:** `cleanup-docker.sh`
- –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –£–¥–∞–ª–µ–Ω–∏–µ dangling images
- –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
- –û—Ç—á—ë—Ç –æ–± –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω–æ–º –º–µ—Å—Ç–µ
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - volumes –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron:**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00):
0 3 * * 0 /root/agents-monorepo/cleanup-docker.sh >> /var/log/docker-cleanup.log 2>&1
```

---

## üìÇ –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `services/agent-brain/src/lib/supabaseClient.js`
- ‚úÖ `services/agent-service/src/lib/supabaseClient.ts`
- ‚úÖ `logging/grafana-provisioning/dashboards/errors-by-user.json`
- ‚úÖ `docker-daemon.json.example`
- ‚úÖ `cleanup-docker.sh`
- ‚úÖ `LOGGING_IMPROVEMENTS_SUMMARY.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `services/agent-service/src/lib/types.ts` - –¥–æ–±–∞–≤–ª–µ–Ω msgCode
- ‚úÖ `services/agent-service/src/lib/facebookErrors.ts` - –æ–±–Ω–æ–≤–ª—ë–Ω —Å–ª–æ–≤–∞—Ä—å
- ‚úÖ `services/agent-service/src/adapters/facebook.ts` - msg –∫–æ–¥—ã + —Ç–∞–π–º–∞—É—Ç—ã
- ‚úÖ `services/agent-brain/src/server.js` - Supabase wrapper + buildReport
- ‚úÖ `services/agent-brain/src/lib/logAlerts.js` - —Ñ–∏–ª—å—Ç—Ä—ã + —ç–º–æ–¥–∑–∏

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Grafana

1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana ‚Üí Dashboards ‚Üí "Errors by User"
2. –í—ã–±–µ—Ä–∏—Ç–µ username –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
3. –£–≤–∏–¥–∏—Ç–µ:
   - –í—Å–µ –æ—à–∏–±–∫–∏ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
   - –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
   - –¢–∞–±–ª–∏—Ü—É –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫ —Å —ç–º–æ–¥–∑–∏
4. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª–æ–≥ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

### 2. –û—Ç–ª–∞–¥–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–∏

**–í Loki (—á–µ—Ä–µ–∑ Grafana Explore):**
```logql
{msg="fb_token_expired"} | json
```

**–í—Å–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```logql
{userAccountName="performante",level="error"} | json
```

**–û—à–∏–±–∫–∏ dispatch –∑–∞ —á–∞—Å:**
```logql
{msg="actions_dispatch_failed"}[1h] | json
```

### 3. Telegram –∞–ª–µ—Ä—Ç—ã

**Env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** –≤ `.env.brain`:
```bash
LOG_ALERT_TELEGRAM_BOT_TOKEN=...
LOG_ALERT_TELEGRAM_CHAT_ID=...
LOG_ALERT_POLL_INTERVAL_MS=30000
LOG_ALERT_DEDUP_WINDOW_MS=600000
LOG_ALERT_LOKI_ENVIRONMENT=production
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
LOG_ALERT_CRITICAL_ONLY=true
```

### 4. –û—á–∏—Å—Ç–∫–∞ Docker

**–í—Ä—É—á–Ω—É—é:**
```bash
./cleanup-docker.sh
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤ cron):**
```bash
crontab -e
# –î–æ–±–∞–≤–∏—Ç—å:
0 3 * * 0 /root/agents-monorepo/cleanup-docker.sh >> /var/log/docker-cleanup.log 2>&1
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ª–æ–≥–∏ –∏–¥—É—Ç –≤ Loki

```bash
# –ò–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω SSH tunnel):
curl "http://localhost:3100/loki/api/v1/query?query={service=\"agent-service\"}&limit=10"

# –ò–ª–∏ –≤ Grafana Explore:
{service="agent-service"} | json
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase wrapper

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –±–µ–∑ env:
SUPABASE_URL="" docker-compose up agent-brain

# –î–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å —Å:
# msg="supabase_config_missing" –∏ process.exit(1)
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Facebook —Ç–∞–π–º–∞—É—Ç

```bash
# –í –∫–æ–¥–µ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 1 —Å–µ–∫
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É—é—â–µ–µ FB –∑–∞–ø—Ä–æ—Å
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
# msg="fb_fetch_timeout"
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –¶–µ–ª–∏ (–∏–∑ –ø–ª–∞–Ω–∞):

‚úÖ **–õ—é–±–æ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –º–æ–∂–µ—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞–π—Ç–∏ –æ—à–∏–±–∫—É –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- –î–∞—à–±–æ—Ä–¥ "Errors by User" —Å dropdown —Ñ–∏–ª—å—Ç—Ä–æ–º
- Value mappings –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç–º–æ–¥–∑–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è

‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ —á–∏—Ç–∞–µ–º—ã–µ –æ—à–∏–±–∫–∏ –¥–∞–∂–µ –¥–ª—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞**
- –≠–º–æ–¥–∑–∏ –≤ Telegram –∞–ª–µ—Ä—Ç–∞—Ö –∏ Grafana
- –†—É—Å—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ `resolution.short` –∏ `resolution.hint`
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ –æ—Ç—á—ë—Ç–∞—Ö

‚úÖ **–°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏**
- Dispatch –æ—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ—Ç—á—ë—Ç
- FB –æ—à–∏–±–∫–∏ –ª–æ–≤—è—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- Supabase –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–ø–æ –≤—ã–±–æ—Ä—É):

‚ùå **Grafana Alert rules** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ Grafana UI:
  - Alert: `count_over_time({msg="fb_token_expired"}[10m]) > 5`
  - Alert: `count_over_time({msg="actions_dispatch_failed"}[5m]) > 3`

‚ùå **Brain run logs –≤ –ë–î** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –¢–∞–±–ª–∏—Ü–∞ `brain_run_logs` –¥–ª—è –∞—É–¥–∏—Ç–∞ –∑–∞–ø—É—Å–∫–æ–≤
- –•—Ä–∞–Ω–∏—Ç request/response/errors/duration

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç prod –æ–∫—Ä—É–∂–µ–Ω–∏–µ):

- [ ] –¢–µ—Å—Ç fb_token_expired
- [ ] –¢–µ—Å—Ç supabase_unavailable  
- [ ] –¢–µ—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞ Errors by User

---

## üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# Docker logs –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker-compose logs agent-brain --tail 50

# –õ–æ–≥–∏ —Å –æ—à–∏–±–∫–∞–º–∏
docker-compose logs agent-service | grep '"level":"error"'

# –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ Docker
du -sh /var/lib/docker/containers/*/*-json.log | sort -h | tail -20
```

### Grafana

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
docker-compose restart grafana

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Loki –¥–æ—Å—Ç—É–ø–µ–Ω
curl http://localhost:3100/ready
```

### Promtail

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker-compose restart promtail

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Promtail
docker-compose logs promtail --tail 50
```

---

## üéâ –ò—Ç–æ–≥

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –§–∞–∑—ã 0-6 –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úÖ 18 –∑–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚úÖ 2 –∑–∞–¥–∞—á–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ)
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 5 –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ 5 —Ñ–∞–π–ª–æ–≤

**–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:**
- üîç –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è - –≤–∏–¥–Ω–æ –≤—Å–µ –æ—à–∏–±–∫–∏ –ø–æ –ª—é–±–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üéØ –ü–æ–Ω—è—Ç–Ω–∞—è - —ç–º–æ–¥–∑–∏ –∏ —Ä—É—Å—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
- üõ°Ô∏è –£—Å—Ç–æ–π—á–∏–≤–∞—è - –æ—à–∏–±–∫–∏ –Ω–µ —Ä–æ–Ω—è—é—Ç —Å–∏—Å—Ç–µ–º—É
- üìä –ù–∞–±–ª—é–¥–∞–µ–º–∞—è - Grafana –¥–∞—à–±–æ—Ä–¥—ã + Telegram –∞–ª–µ—Ä—Ç—ã
- üßπ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ + –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞

**–í—Ä–µ–º—è –Ω–∞ –ø–æ–∏—Å–∫ –æ—à–∏–±–∫–∏:** 10 —Å–µ–∫—É–Ω–¥ ‚úÖ
**–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞:** –î–∞ ‚úÖ







