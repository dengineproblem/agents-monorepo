# –†–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### ‚úÖ migrations/036_add_source_to_metrics_history.sql
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `source TEXT` –≤ —Ç–∞–±–ª–∏—Ü—É `creative_metrics_history`
- –ó–Ω–∞—á–µ–Ω–∏—è: `'production'` (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä) –∏–ª–∏ `'test'` (–∏–∑ —Ç–µ—Å—Ç–æ–≤)
- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ 'production'

#### ‚úÖ migrations/037_creative_metrics_aggregation_function.sql
- –°–æ–∑–¥–∞–Ω–∞ SQL —Ñ—É–Ω–∫—Ü–∏—è `get_creative_aggregated_metrics()`
- –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ `ad_creative_mapping`
- –°—É–º–º–∏—Ä—É–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (impressions, leads, spend)
- –£—Å—Ä–µ–¥–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (CTR, CPM, CPL)
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ –¥–Ω—è–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ production –º–µ—Ç—Ä–∏–∫–∏

---

### 2. Backend: Agent Brain (scoring.js)

#### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω fetchAdInsights()
- **–ë—ã–ª–æ:** –ü—Ä–∏–Ω–∏–º–∞–ª —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É date_preset
- **–°—Ç–∞–ª–æ:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å time_range
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: quality_ranking, engagement_rate_ranking, conversion_rate_ranking

```javascript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
fetchAdInsights(accountId, token, adId, 'last_7d')  // —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
fetchAdInsights(accountId, token, adId, {           // –Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±
  time_range: { since: '2025-11-20', until: '2025-11-20' }
})
```

#### ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω saveCreativeMetricsToHistory()
- **–ë—ã–ª–æ:** –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª last_7d
- **–°—Ç–∞–ª–æ:** 
  - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ **–∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å** (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
  - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç ads –±–µ–∑ –ø–æ–∫–∞–∑–æ–≤ (impressions = 0)
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∫–ª—é—á–∞—è diagnostics
  - –î–æ–±–∞–≤–ª—è–µ—Ç `source: 'production'`
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ gracefully

**–õ–æ–≥–∏–∫–∞:**
```
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞:
  1. –ù–∞–π—Ç–∏ –≤—Å–µ ad_id —á–µ—Ä–µ–∑ ad_creative_mapping
  2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ ad –∑–∞–ø—Ä–æ—Å–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∑–∞ –í–ß–ï–†–ê
  3. –ï—Å–ª–∏ impressions > 0 ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
  4. –ï—Å–ª–∏ impressions = 0 ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
```

#### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ runScoringAgent()
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è readyCreatives
- –û–±–µ—Ä–Ω—É—Ç –≤ try-catch (–Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤

---

### 3. Frontend: Sales API (salesApi.ts)

#### ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω getCreativeMetrics()
- **–ë—ã–ª–æ:** –ò—Å–∫–∞–ª –ø–æ `creative_id` –Ω–∞–ø—Ä—è–º—É—é
- **–°—Ç–∞–ª–æ:** 
  1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ `ad_id` —á–µ—Ä–µ–∑ `ad_creative_mapping`
  2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö ads
  3. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `source = 'production'`
  4. –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –ø–æ –¥–Ω—è–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

#### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ aggregateMetricsByDate()
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –¥–Ω—è–º
- –°—É–º–º–∏—Ä—É–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (impressions, leads, spend)
- –£—Å—Ä–µ–¥–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ (CTR, CPM, CPL)
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ—Ç *_cents –ø–æ–ª—è)

**–ü—Ä–∏–º–µ—Ä –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:**
```
–î–µ–Ω—å 2025-11-20:
  ad1: 1000 impressions, 5 leads
  ad2: 800 impressions, 3 leads
  ad3: 500 impressions, 2 leads
  
–†–µ–∑—É–ª—å—Ç–∞—Ç:
  2025-11-20: 2300 impressions, 10 leads (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ)
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CRON (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00 UTC+6)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Agent-Brain: runScoringAgent()                         ‚îÇ
‚îÇ  ‚Üí saveCreativeMetricsToHistory()                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞:                                  ‚îÇ
‚îÇ  1. –ù–∞–π—Ç–∏ ads —á–µ—Ä–µ–∑ ad_creative_mapping                 ‚îÇ
‚îÇ  2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å FB API (–≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å)                   ‚îÇ
‚îÇ  3. –ï—Å–ª–∏ impressions > 0 ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  creative_metrics_history (–ë–î)                          ‚îÇ
‚îÇ  - date: –≤—á–µ—Ä–∞                                          ‚îÇ
‚îÇ  - ad_id: Facebook Ad ID                                ‚îÇ
‚îÇ  - source: 'production'                                 ‚îÇ
‚îÇ  - –º–µ—Ç—Ä–∏–∫–∏: impressions, leads, CTR, video_views –∏ —Ç.–¥. ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend: ROI Analytics                                ‚îÇ
‚îÇ  ‚Üí getCreativeMetrics()                                 ‚îÇ
‚îÇ  ‚Üí aggregateMetricsByDate()                             ‚îÇ
‚îÇ  ‚Üí –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–º–µ—Ä –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –º–µ—Ç—Ä–∏–∫

**–î–µ–Ω—å 1 (21 –Ω–æ—è–±—Ä—è):**
- Ad –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–∞–±–∏—Ä–∞–µ—Ç 1000 impressions, 5 leads
- –ú–µ—Ç—Ä–∏–∫–∏ –µ—â—ë –Ω–µ –≤ –ë–î

**–î–µ–Ω—å 2 (22 –Ω–æ—è–±—Ä—è, 8:00 —É—Ç—Ä–∞):**
- CRON –∑–∞–ø—É—Å–∫–∞–µ—Ç scoring agent
- Agent –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ **–∑–∞ 21 –Ω–æ—è–±—Ä—è** –∏–∑ FB API
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç: `date=2025-11-21, ad_id=123, impressions=1000, leads=5`

**–î–µ–Ω—å 2 (22 –Ω–æ—è–±—Ä—è, –¥–Ω—ë–º):**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç ROI –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- Frontend –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
- –í–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 21 –Ω–æ—è–±—Ä—è

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ creative_metrics_history

```sql
CREATE TABLE creative_metrics_history (
  id UUID PRIMARY KEY,
  user_account_id UUID,
  date DATE,                    -- ‚Üê –î–µ–Ω—å, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –º–µ—Ç—Ä–∏–∫–∏
  
  ad_id TEXT,                   -- ‚Üê Facebook Ad ID (–∫–ª—é—á –¥–ª—è —Å–≤—è–∑–∏)
  creative_id TEXT,             -- fb_creative_id
  adset_id TEXT,
  campaign_id TEXT,
  
  -- –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å)
  impressions INTEGER,
  reach INTEGER,
  clicks INTEGER,
  link_clicks INTEGER,
  leads INTEGER,
  spend NUMERIC(10,2),
  
  -- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É)
  ctr NUMERIC(5,2),
  cpm NUMERIC(10,2),
  cpl NUMERIC(10,2),
  frequency NUMERIC(5,2),
  
  -- –í–∏–¥–µ–æ –º–µ—Ç—Ä–∏–∫–∏
  video_views INTEGER,
  video_views_25_percent INTEGER,
  video_views_50_percent INTEGER,
  video_views_75_percent INTEGER,
  video_views_95_percent INTEGER,
  video_avg_watch_time_sec NUMERIC(10,2),
  
  -- Diagnostics
  quality_ranking TEXT,
  engagement_rate_ranking TEXT,
  conversion_rate_ranking TEXT,
  
  source TEXT DEFAULT 'production',  -- ‚Üê 'production' –∏–ª–∏ 'test'
  created_at TIMESTAMPTZ
);

-- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω ad = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–µ–Ω—å
CREATE UNIQUE INDEX creative_metrics_ad_date_unique 
  ON creative_metrics_history(user_account_id, ad_id, date);
```

### –°–≤—è–∑—å —á–µ—Ä–µ–∑ ad_creative_mapping

```
user_creatives (–∫—Ä–µ–∞—Ç–∏–≤—ã)
    id: uuid-abc
    title: "–û—Å–µ–Ω–Ω—è—è –∞–∫—Ü–∏—è"
    ‚Üì (1:many)
    
ad_creative_mapping (—Å–≤—è–∑—å –∫—Ä–µ–∞—Ç–∏–≤ ‚Üî ads)
    user_creative_id: uuid-abc
    ad_id: "123"
    fb_creative_id: "fb_456"
    ‚Üì (1:many)
    
creative_metrics_history (–º–µ—Ç—Ä–∏–∫–∏ –ø–æ –¥–Ω—è–º)
    ad_id: "123"
    date: "2025-11-20"
    impressions: 1000
    leads: 5
```

---

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ **—Ç–æ–ª—å–∫–æ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å**
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏
- –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏

### 2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É
- –ï—Å–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö ads ‚Üí –º–µ—Ç—Ä–∏–∫–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è
- Frontend –∏–ª–∏ SQL —Ñ—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ
- –ì–∏–±–∫–æ—Å—Ç—å: –º–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞ –ª—é–±–æ–π –ø–µ—Ä–∏–æ–¥

### 3. –ü—Ä–æ–ø—É—Å–∫ –ø—É—Å—Ç—ã—Ö –¥–Ω–µ–π
- –ï—Å–ª–∏ ad –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è (impressions = 0) ‚Üí —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –≤ –ë–î
- –ù–∞ Frontend –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –Ω—É–ª—è–º–∏ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

### 4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ test/production
- –ü–æ–ª–µ `source` —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∏ production –º–µ—Ç—Ä–∏–∫–∏
- Production –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏
- –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

### 5. Diagnostics
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è quality_ranking, engagement_rate_ranking
- –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –æ—Ç Facebook
- –ü–æ–º–æ–≥–∞–µ—Ç –≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üîç SQL –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π

```sql
-- –ß–µ—Ä–µ–∑ SQL —Ñ—É–Ω–∫—Ü–∏—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
SELECT * FROM get_creative_aggregated_metrics(
  'user-creative-uuid'::UUID,
  'user-account-uuid'::UUID,
  30
);

-- –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
SELECT 
  cmh.date,
  SUM(cmh.impressions) as total_impressions,
  SUM(cmh.leads) as total_leads,
  SUM(cmh.spend) as total_spend
FROM creative_metrics_history cmh
INNER JOIN ad_creative_mapping acm ON cmh.ad_id = acm.ad_id
WHERE acm.user_creative_id = 'user-creative-uuid'
  AND cmh.user_account_id = 'user-account-uuid'
  AND cmh.source = 'production'
  AND cmh.date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY cmh.date
ORDER BY cmh.date DESC;
```

### –ù–∞–π—Ç–∏ —Ç–æ–ø-–∫—Ä–µ–∞—Ç–∏–≤—ã –ø–æ CPL

```sql
SELECT 
  uc.title,
  SUM(cmh.leads) as total_leads,
  SUM(cmh.spend) as total_spend,
  CASE 
    WHEN SUM(cmh.leads) > 0 
    THEN SUM(cmh.spend) / SUM(cmh.leads)
    ELSE NULL 
  END as avg_cpl
FROM user_creatives uc
INNER JOIN ad_creative_mapping acm ON uc.id = acm.user_creative_id
INNER JOIN creative_metrics_history cmh ON acm.ad_id = cmh.ad_id
WHERE cmh.source = 'production'
  AND cmh.date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY uc.id, uc.title
HAVING SUM(cmh.leads) > 0
ORDER BY avg_cpl ASC
LIMIT 10;
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
psql -f migrations/036_add_source_to_metrics_history.sql
psql -f migrations/037_creative_metrics_aggregation_function.sql
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
```bash
docker-compose restart agent-brain
cd services/frontend && npm run dev
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `TESTING_CREATIVE_METRICS_COLLECTION.md`

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ cron –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ
- –°–ª–µ–¥–∏—Ç—å –∑–∞ coverage –º–µ—Ç—Ä–∏–∫ (—Å–∫–æ–ª—å–∫–æ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –∏–º–µ—é—Ç –¥–∞–Ω–Ω—ã–µ)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å freshness (–¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –í –ë–î
- –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00
- –¢–æ–ª—å–∫–æ ads —Å –ø–æ–∫–∞–∑–∞–º–∏ (impressions > 0)
- `source = 'production'`
- –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (UNIQUE constraint)

### –í ROI –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
- –¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –¥–Ω—è–º
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö ads)
- –í–∏–¥–µ–æ-–º–µ—Ç—Ä–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

### –í –ª–æ–≥–∞—Ö
```
[scoring_agent] phase=saving_metrics_to_history, creatives_count=15
[saveCreativeMetricsToHistory] Starting to save creative metrics to history, date=2025-11-20
[saveCreativeMetricsToHistory] Found ad mappings, ads_count=3
[saveCreativeMetricsToHistory] Successfully saved creative metrics to history, saved_count=45
```

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú–µ—Ç—Ä–∏–∫–∏ –∑–∞ –≤—á–µ—Ä–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏:** Facebook API –¥–æ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 24-48 —á–∞—Å–æ–≤. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

2. **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–Ω–∏:** –ï—Å–ª–∏ ad –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è, —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

3. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫:** –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è (upsert).

4. **Diagnostics –Ω–∞ —É—Ä–æ–≤–Ω–µ ad:** quality_ranking –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ ad, –Ω–µ adset.

5. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## üéâ –ò—Ç–æ–≥–æ

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫  
‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ (–ø–æ –¥–Ω—è–º)  
‚úÖ –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ ad_creative_mapping  
‚úÖ Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ ROI –∞–Ω–∞–ª–∏—Ç–∏–∫–µ  
‚úÖ –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –∏ SQL —Ñ—É–Ω–∫—Ü–∏–∏  
‚úÖ –ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  

**–í—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!** üöÄ


