# –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–î–∞—Ç–∞: 31 –æ–∫—Ç—è–±—Ä—è 2025

## üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. –ù–æ–≤—ã–µ msg –∫–æ–¥—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö
2. Supabase wrapper –ø—Ä–æ–≤–µ—Ä—è–µ—Ç env –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
3. Facebook —Ç–∞–π–º–∞—É—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
4. Grafana –¥–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
5. Telegram –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —ç–º–æ–¥–∑–∏

---

## ‚úÖ –ü—Ä–µ-—á–µ–∫–ª–∏—Å—Ç (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)

- [ ] –ö–æ–¥ –∑–∞–∫–æ–º–º–∏—á–µ–Ω –≤ git
- [ ] –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã: `docker-compose build`
- [ ] –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã: `docker-compose up -d`
- [ ] Grafana –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞: `docker-compose restart grafana promtail`
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ)

---

## üß™ –¢–ï–°–¢ 1: Supabase wrapper - –ø—Ä–æ–≤–µ—Ä–∫–∞ env –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### –¶–µ–ª—å
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ Supabase credentials

### –®–∞–≥–∏

**1.1. –¢–µ—Å—Ç agent-brain:**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å agent-brain
docker-compose stop agent-brain

# –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å .env.brain
mv .env.brain .env.brain.bak

# –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å (–¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å)
docker-compose up agent-brain

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚ùå –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å —Å –æ—à–∏–±–∫–æ–π
# –õ–æ–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å: msg="supabase_config_missing"
# Exit code: 1
```

**1.2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å env:**
```bash
# Ctrl+C
docker-compose stop agent-brain
mv .env.brain.bak .env.brain
docker-compose up -d agent-brain
```

**1.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è:**
```bash
curl http://localhost:7080/api/brain/llm-ping
# –û–∂–∏–¥–∞–µ—Ç—Å—è: {"ok":true,...}
```

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ë–µ–∑ env ‚Üí —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç —Å `supabase_config_missing`
- –° env ‚Üí —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ

---

## üß™ –¢–ï–°–¢ 2: Facebook –æ—à–∏–±–∫–∏ —Å msg –∫–æ–¥–∞–º–∏

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—à–∏–±–∫–∏ Facebook –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ msg –∫–æ–¥–∞–º–∏

### –®–∞–≥–∏

**2.1. –°–∏–º—É–ª—è—Ü–∏—è fb_token_expired:**

–í–∞—Ä–∏–∞–Ω—Ç A (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π - –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ):
```bash
# –í –∫–æ–¥–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å throw –≤ facebook.ts:
# –í —Ñ—É–Ω–∫—Ü–∏–∏ graph() –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 40 –¥–æ–±–∞–≤–∏—Ç—å:
if (path === 'me') {
  const err: any = new Error('Test error');
  err.fb = { status: 401, code: 190, error_subcode: 0 };
  const resolution = resolveFacebookError(err.fb);
  log.error({ msg: resolution.msgCode, meta: err.fb, resolution }, 'Test FB error');
  throw err;
}

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose build agent-service
docker-compose restart agent-service

# –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
curl -X POST http://localhost:8082/api/test-endpoint
```

–í–∞—Ä–∏–∞–Ω—Ç B (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω):
```bash
# –í .env.agent –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É—é—â–µ–µ FB
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```

**2.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
```bash
docker-compose logs agent-service --tail 50 | grep '"msg":"fb_'

# –û–∂–∏–¥–∞–µ—Ç—Å—è —É–≤–∏–¥–µ—Ç—å:
# "msg":"fb_token_expired"
# "resolution":{"msgCode":"fb_token_expired","short":"–°–µ—Å—Å–∏—è Facebook –∏—Å—Ç–µ–∫–ª–∞...",...}
```

**2.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Grafana:**
1. –û—Ç–∫—Ä—ã—Ç—å Grafana ‚Üí Explore
2. –ó–∞–ø—Ä–æ—Å: `{service="agent-service",msg="fb_token_expired"} | json`
3. –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –ª–æ–≥ —Å –¥–µ—Ç–∞–ª—è–º–∏

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è `"msg":"fb_token_expired"`
- –í Grafana –≤–∏–¥–Ω–æ —ç—Ç–æ—Ç –ª–æ–≥
- –ü–æ–ª—è `resolution.msgCode`, `resolution.short`, `resolution.hint` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

---

## üß™ –¢–ï–°–¢ 3: Facebook —Ç–∞–π–º–∞—É—Ç—ã

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∫ FB –ø—Ä–µ—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ç–∞–π–º–∞—É—Ç—É

### –®–∞–≥–∏

**3.1. –£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Ç–µ—Å—Ç–∞:**
```typescript
// –í services/agent-service/src/adapters/facebook.ts
// –°—Ç—Ä–æ–∫–∞ 38: –∏–∑–º–µ–Ω–∏—Ç—å 15000 –Ω–∞ 100
const timeout = setTimeout(() => controller.abort(), 100); // 100ms –¥–ª—è —Ç–µ—Å—Ç–∞
```

**3.2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å:**
```bash
docker-compose build agent-service
docker-compose restart agent-service
```

**3.3. –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ FB:**
```bash
# –õ—é–±–æ–π endpoint –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Facebook
# –ó–∞–ø—Ä–æ—Å –Ω–µ —É—Å–ø–µ–µ—Ç –∑–∞ 100ms ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∞–π–º–∞—É—Ç
```

**3.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
```bash
docker-compose logs agent-service --tail 50 | grep 'fb_fetch_timeout'

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# "msg":"fb_fetch_timeout"
# "timeout":100
```

**3.5. –í–µ—Ä–Ω—É—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç:**
```typescript
// –í–µ—Ä–Ω—É—Ç—å 15000
const timeout = setTimeout(() => controller.abort(), 15000);
```

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è `msg="fb_fetch_timeout"`
- –í –ª–æ–≥–µ —É–∫–∞–∑–∞–Ω `timeout: 100`

---

## üß™ –¢–ï–°–¢ 4: Grafana –¥–∞—à–±–æ—Ä–¥ "Errors by User"

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏

### –®–∞–≥–∏

**4.1. –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥:**
1. Grafana ‚Üí Dashboards ‚Üí Browse
2. –ù–∞–π—Ç–∏ "Errors by User"
3. –û—Ç–∫—Ä—ã—Ç—å

**4.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- Dropdown `username` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥–∏ —Å userAccountName)
- Dropdown `service` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: agent-brain, agent-service, creative-analyzer, evolution-api
- Dropdown `msg` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∏–ø—ã –æ—à–∏–±–æ–∫

**4.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–Ω–µ–ª–∏:**

**–ü–∞–Ω–µ–ª—å 1: "User Errors Log Stream"**
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏)
- –ú–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ª–æ–≥ –∏ —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏ JSON

**–ü–∞–Ω–µ–ª—å 2: "Errors by Service (Last 24h)"**
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å bar chart —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—à–∏–±–æ–∫
- –¶–≤–µ—Ç–∞: green < 10, yellow < 50, red >= 50

**–ü–∞–Ω–µ–ª—å 3: "Errors by Message Type (Last 24h)"**
- –¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: msg, service, Value
- **–í–∞–∂–Ω–æ:** –í –∫–æ–ª–æ–Ω–∫–µ msg –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —ç–º–æ–¥–∑–∏:
  - üîë Facebook —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
  - ‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ FB
  - üóÑÔ∏è –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
  - –∏ —Ç.–¥.

**–ü–∞–Ω–µ–ª—å 4: "Infrastructure Errors (no user)"**
- –õ–æ–≥–∏ –±–µ–∑ userAccountId
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏

**4.4. –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
1. –í—ã–±—Ä–∞—Ç—å username = "All"
2. –í—ã–±—Ä–∞—Ç—å service = "agent-service"
3. –í—ã–±—Ä–∞—Ç—å msg = "fb_token_expired"
4. –î–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –æ—à–∏–±–∫–∏

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –î–∞—à–±–æ—Ä–¥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- –í—Å–µ 4 –ø–∞–Ω–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- Value mappings –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç–º–æ–¥–∑–∏ –∏ —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç
- –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üß™ –¢–ï–°–¢ 5: Telegram –∞–ª–µ—Ä—Ç—ã —Å —ç–º–æ–¥–∑–∏

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º

### –®–∞–≥–∏

**5.1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å env:**
```bash
# –í .env.brain –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
LOG_ALERT_TELEGRAM_BOT_TOKEN=...
LOG_ALERT_TELEGRAM_CHAT_ID=...
LOG_ALERT_POLL_INTERVAL_MS=30000
```

**5.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ worker –∑–∞–ø—É—â–µ–Ω:**
```bash
docker-compose logs agent-brain | grep 'Starting log alerts worker'

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# "Starting log alerts worker"
```

**5.3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É:**
```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ—Ä—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω FB –∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
# –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Supabase –∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ë–î
# –í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä—É—á–Ω—É—é –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ agent-brain:

# –í –∫–æ–¥–µ agent-brain –¥–æ–±–∞–≤–∏—Ç—å:
fastify.log.error({
  msg: 'fb_token_expired',
  userAccountId: 'test-123',
  userAccountName: 'test-user',
  message: 'Test error for Telegram'
}, 'Test error');
```

**5.4. –ü–æ–¥–æ–∂–¥–∞—Ç—å 30 —Å–µ–∫—É–Ω–¥ (POLL_INTERVAL_MS):**
```bash
# Worker –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –æ—à–∏–±–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
```

**5.5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram:**

–î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```
üîë Facebook —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
–¢–∏–ø: `fb_token_expired`
–°–µ—Ä–≤–∏—Å: agent-brain
–°–æ–æ–±—â–µ–Ω–∏–µ: Test error for Telegram
UserAccount: test-123
–ò–º—è: test-user
```

**5.6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ worker:**
```bash
docker-compose logs agent-brain | grep 'Telegram alert sent'

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# "module":"logAlertsWorker"
# "Telegram alert sent"
```

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ê–ª–µ—Ä—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ Telegram
- –í —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å —ç–º–æ–¥–∑–∏ (üîë, ‚è±Ô∏è, üóÑÔ∏è, ‚ö†Ô∏è)
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–Ω—è—Ç–Ω—ã–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ï—Å—Ç—å –ø–æ–ª–µ "–¢–∏–ø" —Å msg –∫–æ–¥–æ–º

---

## üß™ –¢–ï–°–¢ 6: –û—Ç—á—ë—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏ FB

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç—á—ë—Ç—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–ê–∫—Ç–∏–≤–µ–Ω" –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ FB

### –®–∞–≥–∏

**6.1. –°–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏ FB –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ accountStatus:**
```bash
# –í –∫–æ–¥–µ agent-brain –≤ —Ñ—É–Ω–∫—Ü–∏–∏ fetchAccountStatus –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å throw
# –ò–ª–∏ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω

# –ó–∞–ø—É—Å—Ç–∏—Ç—å /api/brain/run
curl -X POST http://localhost:7080/api/brain/run \
  -H 'Content-Type: application/json' \
  -d '{"userAccountId":"YOUR_USER_ID","inputs":{"dispatch":false}}'
```

**6.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç:**
```json
{
  "reportText": "...",
  ...
}
```

**6.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å reportText:**

–í reportText –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
*–û—Ç—á—ë—Ç –∑–∞ 2025-10-31*

–°—Ç–∞—Ç—É—Å –∫–∞–±–∏–Ω–µ—Ç–∞: ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Facebook (...)

–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
...
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
–°—Ç–∞—Ç—É—Å –∫–∞–±–∏–Ω–µ—Ç–∞: –ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω
```

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –ü—Ä–∏ –æ—à–∏–±–∫–µ FB —Å—Ç–∞—Ç—É—Å = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ..."
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ —Å—Ç–∞—Ç—É—Å = "–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω" –∏–ª–∏ "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω"

---

## üß™ –¢–ï–°–¢ 7: Cleanup script

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –®–∞–≥–∏

**7.1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–∫—Ä–∏–ø—Ç executable:**
```bash
ls -l cleanup-docker.sh
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: -rwxr-xr-x (x = executable)
```

**7.2. –ó–∞–ø—É—Å—Ç–∏—Ç—å:**
```bash
./cleanup-docker.sh

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# üßπ Docker cleanup started: ...
# üìä Disk usage BEFORE cleanup:
# üóëÔ∏è  Removing stopped containers...
# üóëÔ∏è  Removing dangling images...
# üóëÔ∏è  Removing unused images...
# ‚úÖ Docker cleanup completed: ...
# üìä Disk usage AFTER cleanup:
```

**7.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ:**
```bash
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å output —Å –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω—ã–º –º–µ—Å—Ç–æ–º
# –°—Ä–∞–≤–Ω–∏—Ç—å BEFORE –∏ AFTER
```

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
- –ù–µ —É–¥–∞–ª—è–µ—Ç volumes (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

---

## üß™ –¢–ï–°–¢ 8: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç (E2E)

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É: –æ—à–∏–±–∫–∞ ‚Üí –ª–æ–≥ ‚Üí Loki ‚Üí Grafana ‚Üí Telegram

### –®–∞–≥–∏

**8.1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏:**
```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ—Ä—Ç–∏—Ç—å Facebook —Ç–æ–∫–µ–Ω –≤ .env.agent
# –í–∞—Ä–∏–∞–Ω—Ç 2: –í—ã–∫–ª—é—á–∏—Ç—å Supabase (–µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π)

# –°–¥–µ–ª–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
curl -X POST http://localhost:7080/api/brain/run \
  -H 'Content-Type: application/json' \
  -d '{"userAccountId":"REAL_USER_ID","inputs":{"dispatch":true}}'
```

**8.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker logs:**
```bash
docker-compose logs agent-brain --tail 100 | grep '"level":"error"'

# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ —Å msg –∫–æ–¥–æ–º
```

**8.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Loki:**
```bash
curl "http://localhost:3100/loki/api/v1/query?query={level=\"error\"}&limit=10"

# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É –≤ JSON
```

**8.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Grafana:**
1. –û—Ç–∫—Ä—ã—Ç—å "Errors by User"
2. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –æ—à–∏–±–∫–∞
3. –í —Ç–∞–±–ª–∏—Ü–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å msg —Å —ç–º–æ–¥–∑–∏

**8.5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram (—á–µ—Ä–µ–∑ 30 —Å–µ–∫):**
- –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –° —ç–º–æ–¥–∑–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞
- –û—à–∏–±–∫–∞ –ø—Ä–æ—à–ª–∞ –ø–æ –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–µ
- –í –∫–∞–∂–¥–æ–º –∑–≤–µ–Ω–µ –≤–∏–¥–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –£–±—Ä–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–ª–∏ throw)
- [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã env —Ñ–∞–π–ª—ã
- [ ] –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã —Å production –∫–æ–Ω—Ñ–∏–≥–æ–º
- [ ] –°–æ–∑–¥–∞–Ω –∫–æ–º–º–∏—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

---

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞—à–±–æ—Ä–¥ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –≤ Grafana

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª –Ω–∞ –º–µ—Å—Ç–µ
ls -l logging/grafana-provisioning/dashboards/errors-by-user.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Grafana
docker-compose restart grafana

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥
sleep 10

# –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É Grafana
```

### –ü—Ä–æ–±–ª–µ–º–∞: Value mappings –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç–º–æ–¥–∑–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JSON —Ñ–∞–π–ª –¥–∞—à–±–æ—Ä–¥–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
- –í Grafana –æ—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ ‚Üí Settings ‚Üí JSON Model
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è "overrides" —Å mappings

### –ü—Ä–æ–±–ª–µ–º–∞: Telegram –∞–ª–µ—Ä—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å env
docker-compose exec agent-brain env | grep LOG_ALERT

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ worker
docker-compose logs agent-brain | grep logAlerts

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Loki –¥–æ—Å—Ç—É–ø–µ–Ω
curl http://localhost:3100/ready
```

### –ü—Ä–æ–±–ª–µ–º–∞: msg –∫–æ–¥—ã –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–¥ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª—Å—è
docker-compose logs agent-service | grep "started"

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –±–µ–∑ –∫—ç—à–∞
docker-compose build --no-cache agent-service
docker-compose restart agent-service
```

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —É–±–µ–¥–∏—Ç–µ—Å—å:

- [x] ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- [ ] ‚úÖ Supabase wrapper —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–∞–¥–∞–µ—Ç –±–µ–∑ env)
- [ ] ‚úÖ Facebook –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å msg –∫–æ–¥–∞–º–∏
- [ ] ‚úÖ –¢–∞–π–º–∞—É—Ç—ã FB —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] ‚úÖ Grafana –¥–∞—à–±–æ—Ä–¥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] ‚úÖ Value mappings –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç–º–æ–¥–∑–∏
- [ ] ‚úÖ Telegram –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
- [ ] ‚úÖ –û—Ç—á—ë—Ç—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–ê–∫—Ç–∏–≤–µ–Ω" –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö FB
- [ ] ‚úÖ Cleanup script —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ‚úÖ E2E —Ç–µ—Å—Ç –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ

---

## üìä –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```
–î–∞—Ç–∞: __________
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª: __________

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
‚úÖ –¢–µ—Å—Ç 1 (Supabase wrapper): ____
‚úÖ –¢–µ—Å—Ç 2 (FB msg –∫–æ–¥—ã): ____
‚úÖ –¢–µ—Å—Ç 3 (FB —Ç–∞–π–º–∞—É—Ç—ã): ____
‚úÖ –¢–µ—Å—Ç 4 (Grafana –¥–∞—à–±–æ—Ä–¥): ____
‚úÖ –¢–µ—Å—Ç 5 (Telegram –∞–ª–µ—Ä—Ç—ã): ____
‚úÖ –¢–µ—Å—Ç 6 (–û—Ç—á—ë—Ç—ã): ____
‚úÖ –¢–µ—Å—Ç 7 (Cleanup script): ____
‚úÖ –¢–µ—Å—Ç 8 (E2E): ____

–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ________
2. ________

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ________
2. ________

–°—Ç–∞—Ç—É—Å: ‚òê –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã  ‚òê –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
```

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ
