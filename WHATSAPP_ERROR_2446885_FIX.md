# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ WhatsApp Business (error_subcode: 2446885)

**–î–∞—Ç–∞:** 2025-11-01
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ad sets —á–µ—Ä–µ–∑ **—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫** (Manual Launch):

```json
{
  "success": false,
  "error": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫",
  "error_details": "Failed to create ad set: {
    \"error\": {
      \"message\": \"Invalid parameter\",
      \"type\": \"OAuthException\",
      \"code\": 100,
      \"error_subcode\": 2446885,
      \"error_user_title\": \"–¢—Ä–µ–±—É–µ—Ç—Å—è –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º WhatsApp Business\",
      \"error_user_msg\": \"–ù–æ–º–µ—Ä WhatsApp, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤–∞—à–µ–π –°—Ç—Ä–∞–Ω–∏—Ü–µ–π, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ª–∏—á–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç WhatsApp Business, —á—Ç–æ–±—ã –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –≤ WhatsApp.\"
    }
  }"
}
```

### –°–∏–º–ø—Ç–æ–º—ã:
- ‚ùå **–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫** (—á–µ—Ä–µ–∑ UI –∫–Ω–æ–ø–∫–∞ "–ó–∞–ø—É—Å—Ç–∏—Ç—å") - –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π 2446885
- ‚ùå **–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Brain Agent** - –ø–∞–¥–∞–µ—Ç —Å —Ç–æ–π –∂–µ –æ—à–∏–±–∫–æ–π
- ‚úÖ **–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ v2** (—á–µ—Ä–µ–∑ API `/campaign-builder/auto-launch-v2`) - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **Creative Test** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –°—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—å:
–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- ‚úÖ –ù–æ–º–µ—Ä WhatsApp –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Facebook Ads Manager —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ùå –ß–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É - –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∏–∑ –ë–î):

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #1** (`a10e54ea-b278-44a4-88bb-a13c50249691`):
- `page_id`: ‚úÖ `111169572081592` (–µ—Å—Ç—å)
- `user_accounts.whatsapp_phone_number`: ‚ùå `null` (–ù–ï–¢)
- WhatsApp –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - "–õ–æ–∂–∫–∏ –¥–ª—è –æ–±—É–≤–∏" - `whatsapp_phone_number_id`: ‚ùå `null`
  - "–°—Ç–∞–∫–∞–Ω—ã Almaty" - `whatsapp_phone_number_id`: ‚ùå `null`
- WhatsApp –Ω–æ–º–µ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `whatsapp_phone_numbers`: ‚úÖ `+77776900869` (–µ—Å—Ç—å, –Ω–æ –ù–ï –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º!)

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #2** (`173dfce9-206f-4d4d-bed8-9b7c56674834`):
- `page_id`: ‚úÖ `734116649781310` (–µ—Å—Ç—å)
- `user_accounts.whatsapp_phone_number`: ‚ùå `null` (–ù–ï–¢)
- WhatsApp –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - "Testify" - `whatsapp_phone_number_id`: ‚úÖ `b32cec21-426a-4475-8d5f-9368d7ec36f8` (–ï–°–¢–¨ –ø—Ä–∏–≤—è–∑–∫–∞!)
- WhatsApp –Ω–æ–º–µ—Ä–∞ –≤ –ë–î: ‚úÖ `+77006353580` (–µ—Å—Ç—å –ò –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é!)

**–†–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** (`0f559eb0-53fa-4b6a-a51b-5d3e15e5864b`):
- `page_id`: ‚úÖ `114323838439928`
- `user_accounts.whatsapp_phone_number`: ‚úÖ `+77074094375` (–ï–°–¢–¨ –≤ legacy –ø–æ–ª–µ!)
- WhatsApp –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - "AI-—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥" - `whatsapp_phone_number_id`: ‚úÖ `fddcebaf-9fff-4916-97e2-33bbe6101a6a`
- WhatsApp –Ω–æ–º–µ—Ä–∞ –≤ –ë–î: ‚úÖ 2 –Ω–æ–º–µ—Ä–∞, –æ–¥–∏–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω–∞—è Root Cause

### –í —Ñ–∞–π–ª–µ [createAdSetInDirection.ts:295-307](services/agent-service/src/workflows/createAdSetInDirection.ts#L295-L307)

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ö–û–î (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**

```typescript
// –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 4-tier fallback!
const { data: userAccount } = await supabase
  .from('user_accounts')
  .select('page_id, whatsapp_phone_number')  // ‚Üê –¢–û–õ–¨–ö–û legacy –ø–æ–ª–µ!
  .eq('id', user_account_id)
  .single();

if (userAccount?.page_id && direction.objective === 'whatsapp') {
  adsetBody.promoted_object = {
    page_id: String(userAccount.page_id),
    ...(userAccount.whatsapp_phone_number && { whatsapp_phone_number: userAccount.whatsapp_phone_number })
  };
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ª–æ–º–∞–ª–æ—Å—å:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #1:**
   - `user_accounts.whatsapp_phone_number` = `null`
   - –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Facebook: `{ page_id: "111169572081592" }` **–ë–ï–ó –Ω–æ–º–µ—Ä–∞**
   - Facebook –Ω–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ **–ª–∏—á–Ω—ã–π** WhatsApp –∞–∫–∫–∞—É–Ω—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—à–∏–±–∫–∞ 2446885 "–¢—Ä–µ–±—É–µ—Ç—Å—è WhatsApp Business"

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #2:**
   - `user_accounts.whatsapp_phone_number` = `null`
   - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–ú–ï–ï–¢ –ø—Ä–∏–≤—è–∑–∫—É: `whatsapp_phone_number_id = b32cec21...`
   - –ö–æ–¥ **–ò–ì–ù–û–†–ò–†–£–ï–¢** —ç—Ç—É –ø—Ä–∏–≤—è–∑–∫—É!
   - –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: `{ page_id: "734116649781310" }` **–ë–ï–ó –Ω–æ–º–µ—Ä–∞**
   - Facebook –≤—ã–±–∏—Ä–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ª–∏—á–Ω—ã–π)
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—à–∏–±–∫–∞ 2446885

3. **–†–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   - `user_accounts.whatsapp_phone_number` = `+77074094375` ‚úÖ
   - –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: `{ page_id: "...", whatsapp_phone_number: "+77074094375" }`
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–±–æ—Ç–∞–µ—Ç!

### –ü–æ—á–µ–º—É –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ v2 –∏ Creative Test —Ä–∞–±–æ—Ç–∞–ª–∏:

–û–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é `getWhatsAppPhoneNumber()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π 4-tier fallback –ª–æ–≥–∏–∫–æ–π.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ fallback

```typescript
import { getWhatsAppPhoneNumber } from '../lib/settingsHelpers.js';
```

### 2. –ó–∞–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è WhatsApp –Ω–æ–º–µ—Ä–∞

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ö–û–î (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**

```typescript
// –ü–æ–ª—É—á–∞–µ–º page_id –∏ access_token –¥–ª—è WhatsApp fallback –ª–æ–≥–∏–∫–∏
const { data: userAccount } = await supabase
  .from('user_accounts')
  .select('page_id, access_token')  // ‚Üê access_token –Ω—É–∂–µ–Ω –¥–ª—è Facebook Page API
  .eq('id', user_account_id)
  .single();

// –î–ª—è WhatsApp objective –∏—Å–ø–æ–ª—å–∑—É–µ–º 4-tier fallback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞
let whatsapp_phone_number;
if (direction.objective === 'whatsapp') {
  whatsapp_phone_number = await getWhatsAppPhoneNumber(
    direction,
    user_account_id,
    supabase,
    userAccount?.access_token,
    userAccount?.page_id
  ) || undefined;
}

if (userAccount?.page_id && direction.objective === 'whatsapp') {
  adsetBody.promoted_object = {
    page_id: String(userAccount.page_id),
    ...(whatsapp_phone_number && { whatsapp_phone_number })  // ‚Üê optional spread
  };
}
```

### 3. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
log.info({
  name: final_adset_name,
  campaign_id: direction.fb_campaign_id,
  daily_budget: budget,
  optimization_goal,
  destination_type,
  promoted_object: adsetBody.promoted_object,
  has_whatsapp_number: !!whatsapp_phone_number,
  whatsapp_phone_number: whatsapp_phone_number || 'not_provided_fb_will_use_page_default',
  page_id: userAccount?.page_id,
  userAccountId: user_account_id,
  directionName: direction.name,
  directionId: direction.id
}, 'Creating ad set for direction');
```

---

## üéØ –õ–æ–≥–∏–∫–∞ 4-tier Fallback

–§—É–Ω–∫—Ü–∏—è `getWhatsAppPhoneNumber()` –∏–∑ [settingsHelpers.ts:132-250](services/agent-service/src/lib/settingsHelpers.ts#L132-L250):

### Priority 1: –ù–æ–º–µ—Ä –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```typescript
if (direction.whatsapp_phone_number_id) {
  // –ß–∏—Ç–∞–µ–º –∏–∑ whatsapp_phone_numbers
  const { data: phoneNumber } = await supabaseClient
    .from('whatsapp_phone_numbers')
    .select('phone_number')
    .eq('id', direction.whatsapp_phone_number_id)
    .eq('is_active', true)
    .single();

  if (phoneNumber) return phoneNumber.phone_number;
}
```

### Priority 2: –ù–æ–º–µ—Ä –∏–∑ Facebook Page API
```typescript
const response = await fetch(
  `https://graph.facebook.com/v20.0/${pageId}?fields=whatsapp_number&access_token=${accessToken}`
);

if (response.ok) {
  const pageData = await response.json();
  if (pageData?.whatsapp_number) return pageData.whatsapp_number;
}
```

### Priority 3: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑ –ë–î
```typescript
const { data: defaultNumber } = await supabaseClient
  .from('whatsapp_phone_numbers')
  .select('phone_number')
  .eq('user_account_id', userAccountId)
  .eq('is_default', true)
  .eq('is_active', true)
  .single();

if (defaultNumber) return defaultNumber.phone_number;
```

### Priority 4: Legacy –ø–æ–ª–µ –∏–∑ user_accounts
```typescript
const { data: userAccount } = await supabaseClient
  .from('user_accounts')
  .select('whatsapp_phone_number')
  .eq('id', userAccountId)
  .single();

if (userAccount?.whatsapp_phone_number) {
  return userAccount.whatsapp_phone_number;
}
```

### Priority 5: –í–æ–∑–≤—Ä–∞—Ç null (–ù–ï –æ—à–∏–±–∫–∞!)
```typescript
// Facebook —Å–∞–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
return null;
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #1 (a10e54ea):
- **–î–æ:** `whatsapp_phone_number_id = null` ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ë–ï–ó –Ω–æ–º–µ—Ä–∞ ‚Üí –æ—à–∏–±–∫–∞ 2446885
- **–ü–æ—Å–ª–µ:**
  1. Priority 1: `direction.whatsapp_phone_number_id = null` ‚ùå
  2. Priority 2: –ó–∞–ø—Ä–æ—Å –∫ Facebook Page API ‚Üí –ø–æ–ª—É—á–∏—Ç –Ω–æ–º–µ—Ä —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å Business) ‚úÖ
  3. Priority 3: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –∏–∑ –ë–î (`+77776900869` –µ—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å `is_default = true`) ‚úÖ
  4. Priority 4: Legacy –ø–æ–ª–µ = `null` ‚ùå
  5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Facebook –µ—Å—Ç—å WhatsApp Business, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –æ–Ω. –ò–Ω–∞—á–µ - –Ω–æ–º–µ—Ä –∏–∑ –ë–î.

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #2 (173dfce9):
- **–î–æ:** `whatsapp_phone_number_id = b32cec21...` ‚Üí –ù–û –∫–æ–¥ –ò–ì–ù–û–†–ò–†–û–í–ê–õ ‚Üí –æ—à–∏–±–∫–∞ 2446885
- **–ü–æ—Å–ª–µ:**
  1. Priority 1: `direction.whatsapp_phone_number_id = b32cec21...` ‚Üí `+77006353580` ‚úÖ
  2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–æ–º–µ—Ä –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è `+77006353580`

### –†–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (0f559eb0):
- **–î–æ:** Legacy `whatsapp_phone_number = +77074094375` ‚Üí —Ä–∞–±–æ—Ç–∞–ª–æ ‚úÖ
- **–ü–æ—Å–ª–µ:**
  1. Priority 1: `direction.whatsapp_phone_number_id = fddcebaf...` ‚Üí –Ω–æ–º–µ—Ä –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ
  2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–º–µ—Ä –∏–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ)

---

## üöÄ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –≤–æ –≤—Å–µ—Ö endpoints

–¢–µ–ø–µ—Ä—å **–í–°–ï** —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è ad sets –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É:

| Endpoint/Workflow | –§–∞–π–ª | WhatsApp –ª–æ–≥–∏–∫–∞ | –°—Ç–∞—Ç—É—Å |
|-------------------|------|-----------------|--------|
| Auto-launch v2 | [campaignBuilder.ts:246](services/agent-service/src/routes/campaignBuilder.ts#L246) | ‚úÖ 4-tier fallback | –†–∞–±–æ—Ç–∞–ª–æ |
| Creative Test | [creativeTest.ts](services/agent-service/src/routes/creativeTest.ts) | ‚úÖ 4-tier fallback | –†–∞–±–æ—Ç–∞–ª–æ |
| Brain Agent Actions | [actions.ts](services/agent-service/src/routes/actions.ts) | ‚úÖ 4-tier fallback | –†–∞–±–æ—Ç–∞–ª–æ |
| **Manual Launch** | **[createAdSetInDirection.ts:303-313](services/agent-service/src/workflows/createAdSetInDirection.ts#L303-L313)** | **‚úÖ 4-tier fallback** | **–ò–°–ü–†–ê–í–õ–ï–ù–û** |

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. **[createAdSetInDirection.ts](services/agent-service/src/workflows/createAdSetInDirection.ts)**
   - –°—Ç—Ä–æ–∫–∞ 5: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `getWhatsAppPhoneNumber`
   - –°—Ç—Ä–æ–∫–∏ 296-313: –ó–∞–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è WhatsApp –Ω–æ–º–µ—Ä–∞
   - –°—Ç—Ä–æ–∫–∏ 322-336: –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —à–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #1: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "–õ–æ–∂–∫–∏ –¥–ª—è –æ–±—É–≤–∏" –∏–ª–∏ "–°—Ç–∞–∫–∞–Ω—ã Almaty"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #2: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "Testify"

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ agent-service:**
   ```bash
   docker-compose logs -f agent-service | grep -E "(whatsapp|promoted_object|2446885)"
   ```

3. **–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
   ```json
   {
     "directionId": "...",
     "phone_number": "+77006353580",
     "source": "direction",
     "message": "Using WhatsApp number from direction"
   }
   ```

   –ò–ª–∏ –µ—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏:
   ```json
   {
     "directionId": "...",
     "phone_number": "+77...",
     "source": "facebook_page_api",
     "message": "Using WhatsApp number from Facebook Page (Priority 2)"
   }
   ```

4. **–ï—Å–ª–∏ —Å–Ω–æ–≤–∞ –æ—à–∏–±–∫–∞ 2446885:**
   - –ó–Ω–∞—á–∏—Ç –Ω–∞ Facebook Page —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏—á–Ω—ã–π WhatsApp –∞–∫–∫–∞—É–Ω—Ç
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å WhatsApp Business —á–µ—Ä–µ–∑ [Facebook Business Manager](https://business.facebook.com/settings/whatsapp-business-accounts)
   - –ò –ø—Ä–∏–≤—è–∑–∞—Ç—å Business –∞–∫–∫–∞—É–Ω—Ç –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [WHATSAPP_NUMBERS_LOGIC.md](WHATSAPP_NUMBERS_LOGIC.md) - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å WhatsApp –Ω–æ–º–µ—Ä–∞–º–∏
- [SESSION_2025-10-30_WHATSAPP_FIX.md](SESSION_2025-10-30_WHATSAPP_FIX.md) - –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (destination_type)
- [WHATSAPP_NUMBERS_FIX_COMPLETE.md](WHATSAPP_NUMBERS_FIX_COMPLETE.md) - –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫–∞—Å–∫–∞–¥–Ω–æ–π –ª–æ–≥–∏–∫–∏ (24 –æ–∫—Ç—è–±—Ä—è)

---

## üéì –£—Ä–æ–∫–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
2. **4-tier fallback –∫—Ä–∏—Ç–∏—á–µ–Ω** –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –≥–∏–±–∫–æ—Å—Ç–∏
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö** –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
4. **Spread operator –¥–ª—è optional –ø–æ–ª–µ–π** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è Facebook API
5. **–û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ –≤—Å–µ—Ö endpoints** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç inconsistency bugs

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-11-01
**–ê–≤—Ç–æ—Ä:** Claude Agent
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Deployed to production (agent-service –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω)
