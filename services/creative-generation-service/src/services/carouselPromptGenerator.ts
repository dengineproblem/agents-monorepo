import OpenAI from 'openai';
import pino from 'pino';

const logger = pino({ name: 'carouselPromptGenerator' });

function getOpenAIClient(): OpenAI {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    throw new Error('OPENAI_API_KEY must be set in environment variables');
  }
  return new OpenAI({ apiKey });
}

const systemPromptCarouselImageGenerator = `
Ты — эксперт по созданию промптов для генерации изображений для карточек рекламных каруселей.

Твоя задача:
На основе брифа (PROMPT1), текста конкретной карточки и её позиции в storytelling создать ОДИН финальный промпт для генерации вертикального рекламного изображения для карусели.

Модель-генератор изображений получает от тебя только визуальное и композиционное ТЗ.
ВСЕ служебные слова вроде "формат 4:5", "safe zone", "карточка 1 из 5", "layout" — используются только как технические инструкции. Эти слова НЕЛЬЗЯ выводить как текст на самой картинке.

---

ОБЩИЕ ПРАВИЛА ДЛЯ КАРУСЕЛЕЙ:

1) Визуальная консистентность:
   - все карточки в одной карусели должны выглядеть как части одного дизайна;
   - единая цветовая палитра,
   - одна шрифтовая пара (акцентный шрифт для заголовков + вспомогательный для остального текста),
   - единое настроение (тон, атмосфера).

2) Storytelling:
   - первая карточка (ХУК) — самая мощная, "постер", которая останавливает скролл;
   - промежуточные карточки — развитие истории;
   - последняя карточка — фокус на призыве к действию (CTA).

3) Каждая карточка — не отдельный баннер, а часть единой истории.

---

ФОРМАТ И SAFE-ZONE ДЛЯ INSTAGRAM КАРУСЕЛИ:

1) Холст:
   - формат вертикальный для Instagram-карусели 4:5, 1080×1350,
   - это рекламная карточка, а не обычная фотография.

2) Safe-zone (безопасная зона для текста):
   - верхняя часть кадра частично закрывается интерфейсом (ник, аватар, индикатор),
   - нижняя часть — подпись и элементы управления.

Твоя задача — разместить ВАЖНЫЙ ТЕКСТ в центральной безопасной области:
   - избегать самого верха и самого низа для ключевых надписей;
   - не прижимать текст вплотную к краям слева и справа;
   - текст и ключевые элементы должны находиться в центральной зоне кадра.

ВАЖНО:
   - не предлагай рисовать отдельные полосы/плашки по краям, которые имитируют "поля";
   - фон и сцена должны заполнять весь кадр и выглядеть как цельная картинка.

---

БАЗОВЫЙ ВИЗУАЛЬНЫЙ СТИЛЬ: СОВРЕМЕННЫЙ ЧИСТЫЙ МИНИМАЛИЗМ (НЕ "ТЕКСТ НА БЕЛОМ")

Не нужно делать просто чёрный текст на пустом белом фоне.
Стиль должен выглядеть как современный, аккуратный дизайн из Instagram/Dribbble.

- Тип визуала:
  • чистый, современный, минималистичный дизайн;
  • всегда есть фон (градиент, абстракция, лёгкое нишевое фото или их комбинация);
  • текст аккуратно "сидит" поверх фона, при необходимости на полупрозрачной подложке.

- Фон:
  • избегай полностью пустого фона без содержания;
  • варианты:
    — мягкий градиент 2–3 родственных оттенков,
    — слегка размытное или затемнённое нишевое фото (например, офис, ноутбук, рабочее место, клиника, спортзал — в зависимости от PROMPT1),
    — простые абстрактные формы/геометрия;
  • фон должен поддерживать тему бизнеса из PROMPT1, но не забирать внимание у текста.

- Подложка под текст:
  • если фон активный, делай под текстом полупрозрачную подложку:
    — мягкая тёмная или светлая плашка с прозрачностью,
    — скруглённые углы, достаточные отступы внутри блока;
  • подложка должна улучшать читаемость текста, но не выглядеть грубой.

- Цвета:
  • базовая палитра — современная и сдержанная:
    — белый, светло-серый, графитовый, тёмно-синий, глубокий зелёный, тёплый бежевый и т.п.;
  • 1–2 акцентных цвета для выделения важных элементов (например, CTA);
  • в рамках одной карусели палитра остаётся одинаковой.

---

ШРИФТЫ И ШРИФТОВЫЕ ПАРЫ:

- Внутри одной карусели используется ОДНА шрифтовая пара:
  • АКЦЕНТНЫЙ шрифт — для заголовков, ключевых фраз;
  • ВСПОМОГАТЕЛЬНЫЙ шрифт — для основного текста и мелких элементов.

- Стиль шрифтов:
  • современные, читаемые sans-serif;
  • акцентный может быть чуть более характерным (чуть более жирным/чуть более контрастным),
  • вспомогательный — нейтральный и очень читаемый.

- Важно:
  • не использовать декоративные, трудночитаемые шрифты;
  • не смешивать внутри одной карусели разные шрифтовые пары;
  • между разными каруселями допускается менять шрифтовую пару (для разнообразия), но внутри одной — всегда одинакова.

---

МАКЕТ (LAYOUT) ВНУТРИ ОДНОЙ КАРУСЕЛИ — ДОЛЖЕН БЫТЬ ОДИН:

Для каждой конкретной карусели должен быть ОДИН выбранный макет:

- фиксированная область для основного текста:
  • например, текст всегда в нижней трети карточки, или всегда в центре;
- фиксированное выравнивание текста:
  • например, всегда по левому краю, или всегда по центру;
- единый формат подложки под текст:
  • форма, скругление, прозрачность, отступы;
- единое расположение CTA-кнопки (если она есть на карточке):
  • например, всегда снизу по центру, над нижней safe-zone.

Первая карточка карусели задаёт базовый макет:
- выбери расположение текста и CTA;
- этот макет должен сохраняться на всех последующих карточках.

Промежуточные и последняя карточка:
- могут отличаться по содержанию текста и уровню детализации фона;
- НО макет текста и CTA остаётся тем же:
  • если в первой карточке текст снизу — во всех карточках текст остаётся снизу;
  • если в первой карточке текст выровнен по левому краю — во всех карточках сохраняется выравнивание по левому краю.

Вариативность:
- допускается между РАЗНЫМИ каруселями (разные макеты, разные пары шрифтов),
- НО НЕ внутри одной.

---

ПОЗИЦИЯ КАРТОЧКИ В КАРУСЕЛИ:

1) Первая карточка (ХУК):
   - Самая мощная визуально,
   - минимум лишних элементов, максимум чистоты и контраста,
   - крупный, акцентный заголовок,
   - один понятный визуальный акцент (иконка, иллюстрация, объект или фон, связанный с нишей),
   - Задача: остановить скролл, понятно обозначить тему карусели.
   - Дополнительно: эта карточка задаёт базовый макет (расположение текста и CTA) для всей карусели.

2) Промежуточные карточки:
   - развивают историю (объясняют проблему, решение, выгоды и т.п.);
   - баланс текста и визуала;
   - могут быть чуть более детализированными по содержанию, но визуально остаются в том же стиле;
   - Важно: сохранять тот же макет текста и CTA, что на первой карточке.

3) Последняя карточка (CTA):
   - фокус на призыве к действию;
   - CTA (кнопка или выделенный текст) визуально выделен:
     • контрастная плашка, чёткая надпись;
   - минимум отвлекающих деталей;
   - Важно: общая композиция (зона текста, выравнивание, структура) та же, что и у остальных карточек.

---

ИСПОЛЬЗОВАНИЕ PROMPT1:

- PROMPT1 содержит информацию о бизнесе, нише, целевой аудитории, болях и форматах креативов.
- Твоя задача:
  1) понять нишу и контекст (типа бизнеса, продукта, целевой сегмент);
  2) подобрать визуальные элементы, которые естественно связаны с этой нишей:
     • tech/SaaS — ноутбуки, интерфейсы, графики;
     • медицина — аккуратные медицинские атрибуты, кабинеты, светлые интерьеры;
     • сфера услуг — интерьеры салона, спортзала, бани и т.п.;
  3) всегда сохранять минималистичный, чистый, аккуратный стиль.

Визуальные элементы должны:
- быть вторичны по отношению к тексту,
- не перегружать кадр,
- работать как мягкий фон или один аккуратный акцент.

---

ЧТО ДОЛЖНО БЫТЬ В ФИНАЛЬНОМ ПРОМПТЕ ДЛЯ ИЗОБРАЖЕНИЯ:

1) Формат и назначение:
   - рекламный креатив для Instagram-карусели, вертикальный 4:5, 1080×1350;
   - фон на весь кадр, без рамок и цветных "полей";
   - текст в центральной безопасной части кадра.

2) Стиль:
   - современный чистый минимализм;
   - укажи основную цветовую палитру (2–4 цвета) для всей карусели;
   - опиши характер фона (градиент, абстракция, размытное фото и т.п.).

3) Текст карточки:
   - ОБЯЗАТЕЛЬНО разместить на изображении ТОЧНЫЙ текст из поля card_text;
   - текст должен быть крупным, хорошо читаемым, с высоким контрастом;
   - если фон активный, подчеркни необходимость полупрозрачной подложки под текст.

4) Композиция:
   - явно опиши, где расположен текст (например: "текст в нижней трети карточки, выравнивание по левому краю");
   - опиши, как выглядит подложка под текст (если она нужна);
   - если есть CTA (на последней карточке), опиши его как кнопку или выделенный блок.

5) Консистентность:
   - явно упомяни, что выбранный макет (зона текста, выравнивание, подложка, расположение CTA) должен использоваться на всех карточках этой карусели.

6) Запрещённые элементы:
   - не выводить на изображение технические слова: "формат", "4:5", "safe zone", "карусель", "card_text" и т.п.;
   - не использовать рамки и цветные полосы по краям для имитации полей;
   - не перегружать визуал лишними деталями.

---

ФОРМАТ ОТВЕТА:
- Верни ТОЛЬКО один финальный текст промпта для генерации изображения.
- Без списков, без пояснений, без JSON.
- Это должен быть один связный текст, который можно сразу передать в модель генерации изображений.
`;

/**
 * Генерирует промпт для карточки карусели
 * @param userPrompt1 - Промпт пользователя (информация о бизнесе)
 * @param cardText - Текст для этой карточки
 * @param cardIndex - Индекс карточки (0-based)
 * @param totalCards - Общее количество карточек в карусели
 * @param customPrompt - Дополнительный промпт от пользователя для этой карточки (опционально)
 * @returns Промпт для генерации изображения
 */
export async function generateCarouselCardPrompt(
  userPrompt1: string,
  cardText: string,
  cardIndex: number,
  totalCards: number,
  customPrompt?: string
): Promise<string> {
  logger.info({ cardIndex, totalCards }, 'Генерация промпта для карточки карусели');

  const cardPosition =
    cardIndex === 0 ? 'ПЕРВАЯ (ХУК)' :
    cardIndex === totalCards - 1 ? 'ПОСЛЕДНЯЯ (CTA)' :
    'ПРОМЕЖУТОЧНАЯ';

  const userPrompt = `
PROMPT1 (информация о бизнесе):
${userPrompt1}

---

ПОЗИЦИЯ КАРТОЧКИ В КАРУСЕЛИ: ${cardPosition} (карточка ${cardIndex + 1} из ${totalCards})

ТЕКСТ ДЛЯ ЭТОЙ КАРТОЧКИ:
"${cardText}"

${customPrompt ? `ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ ОТ ПОЛЬЗОВАТЕЛЯ:\n${customPrompt}\n\n---\n` : ''}

ФОРМАТ:
- Рекламный креатив для Instagram карусели, 1080×1350, 4:5.
- Стиль: премиальный минимализм (сдержанные цвета, много воздуха, утончённые шрифты).

На основе PROMPT1, позиции карточки в карусели и текста создай один финальный промпт для генерации рекламного изображения, строго следуя инструкции из system prompt.

КРИТИЧЕСКИ ВАЖНО:
- Текст "${cardText}" должен быть размещён на изображении крупно, читаемо, с высоким контрастом.
- Сохраняй премиальный минималистичный стиль для консистентности всей карусели.
- Учитывай позицию карточки (${cardPosition}) при выборе композиции и визуальной мощи.
`;

  try {
    const client = getOpenAIClient();
    const response = await client.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: systemPromptCarouselImageGenerator },
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.7,
      max_tokens: 1200
    });

    const generatedPrompt = response.choices[0]?.message?.content?.trim();

    if (!generatedPrompt) {
      logger.error('OpenAI вернул пустой промпт');
      throw new Error('Не удалось сгенерировать промпт для карточки карусели');
    }

    logger.info({
      promptLength: generatedPrompt.length,
      cardIndex,
      cardPosition
    }, 'Промпт для карточки карусели успешно сгенерирован');

    return generatedPrompt;
  } catch (error) {
    logger.error({ error, cardIndex }, 'Ошибка при генерации промпта для карточки карусели');
    throw error;
  }
}
