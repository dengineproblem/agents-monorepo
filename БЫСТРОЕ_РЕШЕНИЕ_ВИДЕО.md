# üöÄ –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï: –°–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–µ—Ç –Ω–∞ –≤–∏–¥–µ–æ >100 –ú–ë

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #1 (OOM)**: –∫–æ–¥ –∑–∞–≥—Ä—É–∂–∞–ª –≤–µ—Å—å —Ñ–∞–π–ª –≤ RAM —á–µ—Ä–µ–∑ `part.toBuffer()` ‚Üí —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–ª –æ—Ç OOM  
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1**: —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–æ –ø–∏—à–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ –ø–æ—Ç–æ–∫–æ–º (streaming), –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø–∞–º—è—Ç—å  
‚úÖ **–ò–∑–º–µ–Ω–∏–ª –ø—É—Ç—å**: `/tmp` ‚Üí `/var/tmp` (—á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞—Å—Ç—å –≤ tmpfs)  
‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #2 (HTTP 413)**: Facebook –æ—Ç–∫–ª–æ–Ω—è–ª –≤–∏–¥–µ–æ >100 –ú–ë –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–º POST  
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2**: —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω chunked upload —á–µ—Ä–µ–∑ `graph-video.facebook.com`  
‚úÖ **–°–æ–∑–¥–∞–ª —Å–∫—Ä–∏–ø—Ç—ã**: –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –¥–µ–ø–ª–æ—è

---

## üî• –ß–¢–û –î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä—ã–π –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ù–∞ **—Å–µ—Ä–≤–µ—Ä–µ**:

```bash
# 1. –ü–µ—Ä–µ–π–¥–∏ –≤ –ø—Ä–æ–µ–∫—Ç
cd /root/agents-monorepo

# 2. –ü–æ–¥—Ç—è–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main

# 3. –ó–∞–ø—É—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π
chmod +x deploy-video-fix.sh
./deploy-video-fix.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç –∏ —Å–æ–∑–¥–∞—Å—Ç `/var/tmp`
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å swap (–µ—Å–ª–∏ –Ω–µ—Ç)
- –ü–µ—Ä–µ—Å–æ–±–µ—Ä—ë—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –ü–æ–∫–∞–∂–µ—Ç –ª–æ–≥–∏

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /root/agents-monorepo
git pull origin main

# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
sudo mkdir -p /var/tmp
sudo chown -R 1000:1000 /var/tmp

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose build agent-service
docker-compose up -d agent-service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f agent-service
```

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å)

–ù–∞ **—Å–µ—Ä–≤–µ—Ä–µ** –∑–∞–ø—É—Å—Ç–∏:

```bash
chmod +x diagnose-video-upload.sh
./diagnose-video-upload.sh
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- tmpfs –Ω–∞ /tmp (–ø–ª–æ—Ö–æ = –ø–∞–º—è—Ç—å)
- –ù–∞–ª–∏—á–∏–µ swap (–Ω—É–∂–µ–Ω –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏)
- OOM kills –≤ –ª–æ–≥–∞—Ö
- –õ–∏–º–∏—Ç—ã nginx
- –ü–∞–º—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

```bash
# –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
docker stats agent-service

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –∑–∞–≥—Ä—É–∑–∏ –±–æ–ª—å—à–æ–µ –≤–∏–¥–µ–æ
# –ü–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ —Ä–∞—Å—Ç–∏ –¥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
```

### 2. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ 200 –ú–ë

```bash
curl -X POST https://agents.performanteaiagency.com/process-video \
  -F "file=@/path/to/big-video.mp4" \
  -F "user_id=YOUR-UUID-HERE" \
  -F "title=Test 200MB" \
  -F "language=ru"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
# "Streaming video to disk: /var/tmp/video_..."
# "Video saved to disk: ..."
# "Video file read (200MB), uploading to Facebook..."

docker-compose logs -f agent-service | grep -i video
```

---

## üìä –í–ê–ñ–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #1: Streaming –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ RAM

**–ë—ã–ª–æ (–≥—Ä—É–∑–∏–ª–æ –≤ RAM ‚ùå)**:
```typescript
videoBuffer = await part.toBuffer();  // ‚Üê –í–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å!
videoPath = path.join('/tmp', ...);  // ‚Üê –ú–æ–∂–µ—Ç –±—ã—Ç—å tmpfs
await fs.writeFile(videoPath, videoBuffer);
```

**–°—Ç–∞–ª–æ (streaming ‚úÖ)**:
```typescript
videoPath = path.join('/var/tmp', ...);  // ‚Üê –î–∏—Å–∫, –Ω–µ tmpfs
await pipeline(part.file, createWriteStream(videoPath));  // ‚Üê –ü–æ—Ç–æ–∫!
// –ü–æ–∑–∂–µ —á–∏—Ç–∞–µ–º —Å –¥–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Facebook API
const videoBuffer = await fs.readFile(videoPath);
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #2: Chunked Upload –¥–ª—è Facebook

**–ë—ã–ª–æ (–ø—Ä–æ—Å—Ç–æ–π POST, 413 –¥–ª—è >100 –ú–ë ‚ùå)**:
```typescript
const formData = new FormData();
formData.append('source', fs.createReadStream(videoPath));
const url = `https://graph.facebook.com/.../advideos`;
await axios.post(url, formData);  // ‚Üê 413 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
```

**–°—Ç–∞–ª–æ (chunked upload —á–µ—Ä–µ–∑ graph-video ‚úÖ)**:
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞
if (fileSize > 50MB) {
  // START ‚Üí TRANSFER (chunks) ‚Üí FINISH
  return await uploadVideoChunked(...);
}

// –î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ - –ø—Ä–æ—Å—Ç–æ–π upload —á–µ—Ä–µ–∑ graph-video
const url = `https://graph-video.facebook.com/.../advideos`;
```

---

## ‚ùì FAQ

**–í: –ù—É–∂–Ω–æ –ª–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å RAM —Å–µ—Ä–≤–µ—Ä–∞?**  
–û: **–ù–ï–¢**. –¢–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (2-4 vCPU, 4-16 GB RAM) –±–æ–ª—å—à–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã. –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –∫–æ–¥–µ.

**–í: Nginx —É–∂–µ —Å—Ç–æ–∏—Ç 500m, –ø–æ—á–µ–º—É –ø–∞–¥–∞–ª–æ?**  
–û: Nginx –ø—Ä–æ–ø—É—Å–∫–∞–ª —Ñ–∞–π–ª, –Ω–æ **Node.js –ø—Ä–æ—Ü–µ—Å—Å** –∑–∞–≥—Ä—É–∂–∞–ª –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º –≤ –ø–∞–º—è—Ç—å ‚Üí OOM ‚Üí –∫—Ä–∞—à.

**–í: –ù—É–∂–µ–Ω –ª–∏ swap –Ω–∞ 16 GB —Å–µ—Ä–≤–µ—Ä–µ?**  
–û: –î–∞, 4 GB swap –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–µ –ø–æ–º–µ—à–∞–µ—Ç –¥–∞–∂–µ —Å 16 GB RAM.

**–í: –ß—Ç–æ –µ—Å–ª–∏ –ø–∞–¥–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—Å—è?**  
–û: –ó–∞–ø—É—Å—Ç–∏ `diagnose-video-upload.sh` –∏ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ –≤—ã–≤–æ–¥. –ù–æ —Å 99% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞.

---

## üéØ –ò–¢–û–ì

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
- ‚úÖ –í–∏–¥–µ–æ –¥–æ **500 –ú–ë** –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ü–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–∞–¥–∞–µ—Ç
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã (–ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –∫–æ–¥–µ, –Ω–µ –≤ –∂–µ–ª–µ–∑–µ)

---

## üìù –§–ê–ô–õ–´

- `FIX_VIDEO_UPLOAD_200MB.md` - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å –¥–µ—Ç–∞–ª—è–º–∏
- `deploy-video-fix.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π
- `diagnose-video-upload.sh` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- `services/agent-service/src/routes/video.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

---

**–í–æ–ø—Ä–æ—Å—ã?** –ü–∏—à–∏, –ø–æ–º–æ–≥—É!

